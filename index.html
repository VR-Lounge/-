<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VR Lounge - –£—á–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background-color: #f5f5f7;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      color: #1d1d1f;
    }
    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
  </style>
</head>
<body>
  <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
  <div id="authContainer" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 hidden" onclick="event.target === this && this.classList.add('hidden')">
    <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-8 relative" onclick="event.stopPropagation()">
      <button id="closeAuthBtn" class="absolute top-5 right-5 text-gray-400 hover:text-gray-600 text-3xl font-thin leading-none focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full w-10 h-10 flex items-center justify-center" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ">&times;</button>
      <h3 class="text-2xl font-semibold mb-6 text-center">–î–æ—Å—Ç—É–ø –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
      <form id="loginForm" class="space-y-4">
        <div>
          <label for="loginEmail" class="block mb-2 font-medium">Email</label>
          <input type="email" id="loginEmail" required class="w-full rounded-3xl border border-gray-300 px-4 py-3">
        </div>
        <div>
          <label for="loginPassword" class="block mb-2 font-medium">–ü–∞—Ä–æ–ª—å</label>
          <input type="password" id="loginPassword" required class="w-full rounded-3xl border border-gray-300 px-4 py-3">
        </div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-3xl">
          –í–æ–π—Ç–∏
        </button>
      </form>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
  <header class="bg-white shadow-md sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-6 py-5 flex flex-col md:flex-row md:items-center md:justify-between">
      <h1 class="text-3xl font-semibold tracking-tight text-gray-900 select-none" style="font-weight: 600;">VR Lounge - –£—á–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</h1>
      <div class="flex items-center space-x-4">
        <button id="logoutBtn" class="hidden text-sm text-blue-600 hover:text-blue-800">–í—ã–π—Ç–∏</button>
        <button id="loginBtn" class="text-sm text-blue-600 hover:text-blue-800">–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</button>
      </div>
    </div>
  </header>

  <main class="flex-grow max-w-7xl mx-auto px-6 py-8 flex flex-col space-y-10">
    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏ -->
    <section>
      <h2 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight">–ì—Ä–∞—Ñ–∏–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</h2>
      <div class="bg-white rounded-3xl shadow-lg max-w-4xl mx-auto p-8 border border-gray-200">
        <div class="flex justify-between mb-6">
          <button id="prevMonthAdmins" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-chevron-left text-lg"></i>
          </button>
          <h3 id="currentMonthAdmins" class="text-xl font-semibold text-gray-900 tracking-tight select-none"></h3>
          <button id="nextMonthAdmins" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-chevron-right text-lg"></i>
          </button>
        </div>
        
        <div id="adminsCalendar" class="grid grid-cols-7 gap-1 text-center text-sm select-none">
          <!-- –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ -->
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">–ü–Ω</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">–í—Ç</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">–°—Ä</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">–ß—Ç</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">–ü—Ç</div>
          <div class="font-semibold text-indigo-600 py-3 border-b border-gray-200">–°–±</div>
          <div class="font-semibold text-indigo-600 py-3 border-b border-gray-200">–í—Å</div>
        </div>
      </div>
    </section>

    <!-- –†–∞—Å—á–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã -->
    <section>
      <h2 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight">–†–∞—Å—á–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã</h2>
      <div class="bg-white rounded-3xl shadow-lg max-w-4xl mx-auto p-8 border border-gray-200">
        <div class="flex justify-between mb-6">
          <button id="prevMonthSalary" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-chevron-left text-lg"></i>
          </button>
          <h3 id="currentMonthSalary" class="text-xl font-semibold text-gray-900 tracking-tight select-none"></h3>
          <button id="nextMonthSalary" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-chevron-right text-lg"></i>
          </button>
        </div>
        
        <div id="salaryResults" class="space-y-6">
          <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ -->
        </div>
      </div>
    </section>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
    <div id="assignAdminModal" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center p-6 hidden z-50">
      <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-8 relative ring-1 ring-gray-200">
        <button id="closeAssignModal" class="absolute top-5 right-5 text-gray-400 hover:text-gray-600 text-3xl font-thin leading-none focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full w-10 h-10 flex items-center justify-center" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ">&times;</button>
        <h3 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight" id="assignModalTitle">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
        <form id="assignAdminForm" class="space-y-6">
          <input type="hidden" id="assignDate" name="assignDate">
          
          <div>
            <label class="block text-gray-900 font-semibold mb-2">–û—Å–Ω–æ–≤–Ω–æ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</label>
            <select id="mainAdmin" name="mainAdmin" required class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</option>
              <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </select>
          </div>
          
          <div id="helperAdminSection" class="hidden">
            <label class="block text-gray-900 font-semibold mb-2">–ü–æ–º–æ—â–Ω–∏–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
            <select id="helperAdmin" name="helperAdmin" class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
              <option value="">–ù–µ—Ç –ø–æ–º–æ—â–Ω–∏–∫–∞</option>
              <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </select>
            
            <div class="mt-4">
              <label class="block text-gray-900 font-semibold mb-2">–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã –ø–æ–º–æ—â–Ω–∏–∫–∞</label>
              <input type="number" id="helperHours" name="helperHours" min="1" max="24" class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤">
            </div>
          </div>
          
          <div class="flex space-x-4">
            <button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white py-3 rounded-3xl font-semibold transition focus:ring-4 focus:ring-blue-300 focus:outline-none">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script type="module">
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, onSnapshot, 
      deleteDoc, doc, updateDoc, query, where, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { 
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBaq_faWwfE_TXn4Xh_2U3GYSAsUzGJ1bk",
      authDomain: "vr-lounge33.firebaseapp.com",
      projectId: "vr-lounge33",
      storageBucket: "vr-lounge33.appspot.com",
      messagingSenderId: "825655988090",
      appId: "1:825655988090:web:76d8e0554b8601f8bd10c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const authContainer = document.getElementById('authContainer');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginBtn = document.getElementById('loginBtn');
    const closeAuthBtn = document.getElementById('closeAuthBtn');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –≥—Ä–∞—Ñ–∏–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    const adminsCalendar = document.getElementById('adminsCalendar');
    const currentMonthAdmins = document.getElementById('currentMonthAdmins');
    const prevMonthAdminsBtn = document.getElementById('prevMonthAdmins');
    const nextMonthAdminsBtn = document.getElementById('nextMonthAdmins');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã
    const salaryResults = document.getElementById('salaryResults');
    const currentMonthSalary = document.getElementById('currentMonthSalary');
    const prevMonthSalaryBtn = document.getElementById('prevMonthSalary');
    const nextMonthSalaryBtn = document.getElementById('nextMonthSalary');
    
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    const assignAdminModal = document.getElementById('assignAdminModal');
    const assignAdminForm = document.getElementById('assignAdminForm');
    const assignModalTitle = document.getElementById('assignModalTitle');
    const assignDateInput = document.getElementById('assignDate');
    const mainAdminSelect = document.getElementById('mainAdmin');
    const helperAdminSelect = document.getElementById('helperAdmin');
    const helperAdminSection = document.getElementById('helperAdminSection');
    const helperHoursInput = document.getElementById('helperHours');
    const closeAssignModal = document.getElementById('closeAssignModal');

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let currentDate = new Date();
    currentDate.setDate(1);
    let selectedDate = null;
    let isAdmin = false;
    let admins = [];
    let adminAssignments = [];
    let bookings = [];
    let adminsViewMonth = new Date();
    let salaryViewMonth = new Date();

    // –¶–µ–Ω—ã —É—Å–ª—É–≥
    const servicePrices = {
      weekday_vr: 500,
      weekday_ps: 150,
      weekend_vr: 750,
      weekend_ps: 250,
      birthday: { // –¶–µ–Ω—ã –∑–∞ —á–∞—Å
        1: 4000,
        2: 3500,
        3: 3000,
        4: 3000
      }
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    function loadData() {
      // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
      onSnapshot(collection(db, "admins"), (snapshot) => {
        admins = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        updateAdminSelects();
        renderAdminsCalendar();
      });

      // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
      onSnapshot(collection(db, "adminAssignments"), (snapshot) => {
        adminAssignments = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        renderAdminsCalendar();
        calculateSalaries();
      });

      // –ó–∞–≥—Ä—É–∑–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
      onSnapshot(collection(db, "bookings"), (snapshot) => {
        bookings = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        calculateSalaries();
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –≤ select
    function updateAdminSelects() {
      mainAdminSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</option>';
      helperAdminSelect.innerHTML = '<option value="">–ù–µ—Ç –ø–æ–º–æ—â–Ω–∏–∫–∞</option>';
      
      admins.forEach(admin => {
        const option1 = document.createElement('option');
        option1.value = admin.id;
        option1.textContent = admin.name;
        mainAdminSelect.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = admin.id;
        option2.textContent = admin.name;
        helperAdminSelect.appendChild(option2);
      });
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    function renderAdminsCalendar() {
      // –û—á–∏—Å—Ç–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏)
      while (adminsCalendar.children.length > 7) {
        adminsCalendar.removeChild(adminsCalendar.lastChild);
      }

      const year = adminsViewMonth.getFullYear();
      const month = adminsViewMonth.getMonth();

      currentMonthAdmins.textContent = adminsViewMonth.toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
      });

      const firstDay = new Date(year, month, 1);
      let startDay = firstDay.getDay();
      startDay = startDay === 0 ? 6 : startDay - 1;

      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –¥–Ω–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
      for (let i = 0; i < startDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'border border-gray-200 bg-gray-50 h-24 rounded-3xl';
        adminsCalendar.appendChild(emptyCell);
      }

      // –Ø—á–µ–π–∫–∏ –¥–ª—è –¥–Ω–µ–π —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        
        const dayCell = document.createElement('div');
        dayCell.className = 'border border-gray-300 rounded-3xl h-24 p-2 flex flex-col cursor-pointer hover:bg-blue-50 transition relative';
        
        // –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
        const today = new Date();
        if (date.getDate() === today.getDate() && 
            date.getMonth() === today.getMonth() && 
            date.getFullYear() === today.getFullYear()) {
          dayCell.classList.add('ring-2', 'ring-blue-600');
        }

        // –ù–æ–º–µ—Ä –¥–Ω—è
        const dayNumber = document.createElement('div');
        dayNumber.textContent = day;
        dayNumber.className = 'font-semibold text-sm text-gray-900 mb-1';
        dayCell.appendChild(dayNumber);

        // –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã
        const assignment = adminAssignments.find(a => a.date === dateStr);
        if (assignment) {
          const mainAdmin = admins.find(a => a.id === assignment.mainAdminId);
          if (mainAdmin) {
            const adminDiv = document.createElement('div');
            adminDiv.className = 'text-xs bg-blue-100 text-blue-800 rounded px-1 py-0.5 mb-1 truncate';
            adminDiv.textContent = `üëë ${mainAdmin.name}`;
            dayCell.appendChild(adminDiv);
          }

          if (assignment.helperAdminId) {
            const helperAdmin = admins.find(a => a.id === assignment.helperAdminId);
            if (helperAdmin) {
              const helperDiv = document.createElement('div');
              helperDiv.className = 'text-xs bg-indigo-100 text-indigo-800 rounded px-1 py-0.5 truncate';
              helperDiv.textContent = `üõ† ${helperAdmin.name} (${assignment.helperHours || 0}—á)`;
              dayCell.appendChild(helperDiv);
            }
          }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        dayCell.addEventListener('click', () => {
          if (!isAdmin) {
            authContainer.classList.remove('hidden');
            return;
          }
          
          openAssignModal(date, dateStr);
        });

        adminsCalendar.appendChild(dayCell);
      }
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    function openAssignModal(date, dateStr) {
      assignModalTitle.textContent = `–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–∞ ${date.toLocaleDateString('ru-RU')}`;
      assignDateInput.value = dateStr;
      
      // –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
      const assignment = adminAssignments.find(a => a.date === dateStr);
      
      if (assignment) {
        mainAdminSelect.value = assignment.mainAdminId;
        helperAdminSelect.value = assignment.helperAdminId || '';
        helperHoursInput.value = assignment.helperHours || '';
        
        if (assignment.helperAdminId) {
          helperAdminSection.classList.remove('hidden');
        } else {
          helperAdminSection.classList.add('hidden');
        }
      } else {
        mainAdminSelect.value = '';
        helperAdminSelect.value = '';
        helperHoursInput.value = '';
        helperAdminSection.classList.add('hidden');
      }
      
      assignAdminModal.classList.remove('hidden');
    }

    // –†–∞—Å—á–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç
    function calculateSalaries() {
      const year = salaryViewMonth.getFullYear();
      const month = salaryViewMonth.getMonth();
      
      currentMonthSalary.textContent = salaryViewMonth.toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
      });
      
      // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ –¥–∞—Ç–∞–º
      const bookingsByDate = {};
      bookings.forEach(booking => {
        const bookingDate = new Date(booking.bookingDate);
        if (bookingDate.getFullYear() === year && bookingDate.getMonth() === month) {
          const dateStr = booking.bookingDate;
          if (!bookingsByDate[dateStr]) {
            bookingsByDate[dateStr] = [];
          }
          bookingsByDate[dateStr].push(booking);
        }
      });
      
      // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –ø–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
      const salaryData = {};
      admins.forEach(admin => {
        salaryData[admin.id] = {
          name: admin.name,
          baseSalary: 0,
          bonusSalary: 0,
          totalSalary: 0,
          daysWorked: 0,
          hoursWorked: 0,
          details: []
        };
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      let totalRevenue = 0;
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        
        const assignment = adminAssignments.find(a => a.date === dateStr);
        if (!assignment) continue;
        
        const dayBookings = bookingsByDate[dateStr] || [];
        let dayRevenue = 0;
        
        // –†–∞—Å—á–µ—Ç –≤—ã—Ä—É—á–∫–∏ –∑–∞ –¥–µ–Ω—å
        dayBookings.forEach(booking => {
          let bookingRevenue = 0;
          
          if (booking.serviceType === 'birthday') {
            // –†–∞—Å—á–µ—Ç –¥–ª—è –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è
            const hours = Math.min(booking.duration, 4);
            bookingRevenue = servicePrices.birthday[hours] || 0;
          } else {
            // –†–∞—Å—á–µ—Ç –¥–ª—è –¥—Ä—É–≥–∏—Ö —É—Å–ª—É–≥
            bookingRevenue = (servicePrices[booking.serviceType] || 0) * booking.duration;
          }
          
          dayRevenue += bookingRevenue;
        });
        
        totalRevenue += dayRevenue;
        
        // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç—ã –æ—Å–Ω–æ–≤–Ω–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        if (assignment.mainAdminId && salaryData[assignment.mainAdminId]) {
          salaryData[assignment.mainAdminId].daysWorked++;
          salaryData[assignment.mainAdminId].baseSalary += 500; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞–≤–∫–∞
          
          let bonusPercent = 0.15; // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±–æ–Ω—É—Å
          if (assignment.helperAdminId) {
            bonusPercent = 0.08; // –ë–æ–Ω—É—Å –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø–æ–º–æ—â–Ω–∏–∫–∞
          }
          
          const bonus = dayRevenue * bonusPercent;
          salaryData[assignment.mainAdminId].bonusSalary += bonus;
          salaryData[assignment.mainAdminId].totalSalary += 500 + bonus;
          
          salaryData[assignment.mainAdminId].details.push({
            date: dateStr,
            type: '–û—Å–Ω–æ–≤–Ω–∞—è —Å–º–µ–Ω–∞',
            base: 500,
            bonus: bonus,
            revenue: dayRevenue,
            hours: 0
          });
        }
        
        // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç—ã –ø–æ–º–æ—â–Ω–∏–∫—É
        if (assignment.helperAdminId && salaryData[assignment.helperAdminId] && assignment.helperHours) {
          const hours = parseInt(assignment.helperHours) || 0;
          salaryData[assignment.helperAdminId].hoursWorked += hours;
          
          let bonusPercent = 0.07; // –ë–æ–Ω—É—Å –ø–æ–º–æ—â–Ω–∏–∫–∞
          const base = hours * 150; // –ü–æ—á–∞—Å–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞
          const bonus = dayRevenue * bonusPercent;
          
          salaryData[assignment.helperAdminId].baseSalary += base;
          salaryData[assignment.helperAdminId].bonusSalary += bonus;
          salaryData[assignment.helperAdminId].totalSalary += base + bonus;
          
          salaryData[assignment.helperAdminId].details.push({
            date: dateStr,
            type: '–ü–æ–º–æ—â—å –Ω–∞ —Å–º–µ–Ω–µ',
            base: base,
            bonus: bonus,
            revenue: dayRevenue,
            hours: hours
          });
        }
      }
      
      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      renderSalaryResults(salaryData, totalRevenue);
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—á–µ—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã
    function renderSalaryResults(salaryData, totalRevenue) {
      salaryResults.innerHTML = '';
      
      // –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞
      const revenueCard = document.createElement('div');
      revenueCard.className = 'bg-white rounded-2xl shadow-md p-6 border border-gray-200';
      revenueCard.innerHTML = `
        <h3 class="text-lg font-semibold mb-4">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ –∑–∞ –º–µ—Å—è—Ü</h3>
        <p class="text-2xl font-bold text-green-600">${totalRevenue.toLocaleString()} ‚ÇΩ</p>
      `;
      salaryResults.appendChild(revenueCard);
      
      // –ó–∞—Ä–ø–ª–∞—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
      admins.forEach(admin => {
        const data = salaryData[admin.id];
        if (!data || data.totalSalary <= 0) return;
        
        const adminCard = document.createElement('div');
        adminCard.className = 'bg-white rounded-2xl shadow-md p-6 border border-gray-200';
        
        adminCard.innerHTML = `
          <h3 class="text-lg font-semibold mb-2">${admin.name}</h3>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <p class="text-sm text-gray-500">–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–º–µ–Ω</p>
              <p class="font-medium">${data.daysWorked}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ —á–∞—Å–æ–≤</p>
              <p class="font-medium">${data.hoursWorked}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —á–∞—Å—Ç—å</p>
              <p class="font-medium">${data.baseSalary.toLocaleString()} ‚ÇΩ</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">–ë–æ–Ω—É—Å–Ω–∞—è —á–∞—Å—Ç—å</p>
              <p class="font-medium">${data.bonusSalary.toLocaleString()} ‚ÇΩ</p>
            </div>
          </div>
          <div class="border-t border-gray-200 pt-4">
            <p class="text-sm text-gray-500">–ò—Ç–æ–≥–æ –∑–∞—Ä–ø–ª–∞—Ç–∞</p>
            <p class="text-xl font-bold text-blue-600">${data.totalSalary.toLocaleString()} ‚ÇΩ</p>
          </div>
          <button class="mt-4 text-sm text-blue-600 hover:text-blue-800 view-details" data-admin="${admin.id}">
            <i class="fas fa-list mr-1"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
          </button>
          <div id="details-${admin.id}" class="hidden mt-4 space-y-3"></div>
        `;
        
        salaryResults.appendChild(adminCard);
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ"
      document.querySelectorAll('.view-details').forEach(btn => {
        btn.addEventListener('click', () => {
          const adminId = btn.getAttribute('data-admin');
          const detailsDiv = document.getElementById(`details-${adminId}`);
          const data = salaryData[adminId];
          
          if (detailsDiv.classList.contains('hidden')) {
            detailsDiv.innerHTML = '';
            data.details.forEach(detail => {
              const detailItem = document.createElement('div');
              detailItem.className = 'text-sm border-b border-gray-100 pb-2';
              detailItem.innerHTML = `
                <p class="font-medium">${detail.date} - ${detail.type}</p>
                <div class="grid grid-cols-3 gap-2 mt-1">
                  <span>${detail.hours > 0 ? detail.hours + '—á' : '–°–º–µ–Ω–∞'}: ${detail.base} ‚ÇΩ</span>
                  <span>–ë–æ–Ω—É—Å: ${detail.bonus.toFixed(0)} ‚ÇΩ</span>
                  <span>–í—ã—Ä—É—á–∫–∞: ${detail.revenue.toFixed(0)} ‚ÇΩ</span>
                </div>
              `;
              detailsDiv.appendChild(detailItem);
            });
            detailsDiv.classList.remove('hidden');
            btn.innerHTML = '<i class="fas fa-chevron-up mr-1"></i> –°–∫—Ä—ã—Ç—å';
          } else {
            detailsDiv.classList.add('hidden');
            btn.innerHTML = '<i class="fas fa-list mr-1"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ';
          }
        });
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function init() {
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        try {
          await signInWithEmailAndPassword(auth, email, password);
          authContainer.classList.add('hidden');
        } catch (error) {
          alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
        }
      });

      logoutBtn.addEventListener('click', () => {
        signOut(auth);
      });

      loginBtn.addEventListener('click', () => {
        authContainer.classList.remove('hidden');
      });

      closeAuthBtn.addEventListener('click', () => {
        authContainer.classList.add('hidden');
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
      assignAdminForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const date = assignDateInput.value;
        const mainAdminId = mainAdminSelect.value;
        const helperAdminId = helperAdminSelect.value;
        const helperHours = helperHoursInput.value;
        
        if (!mainAdminId) {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
          return;
        }
        
        try {
          const assignmentRef = doc(db, "adminAssignments", date);
          await setDoc(assignmentRef, {
            date: date,
            mainAdminId: mainAdminId,
            helperAdminId: helperAdminId || null,
            helperHours: helperHours || null
          });
          
          assignAdminModal.classList.add('hidden');
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", error);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ");
        }
      });

      mainAdminSelect.addEventListener('change', () => {
        if (mainAdminSelect.value) {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–º–æ—â–Ω–∏–∫–æ–≤ (–∏—Å–∫–ª—é—á–∞—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
          helperAdminSelect.innerHTML = '<option value="">–ù–µ—Ç –ø–æ–º–æ—â–Ω–∏–∫–∞</option>';
          admins.forEach(admin => {
            if (admin.id !== mainAdminSelect.value) {
              const option = document.createElement('option');
              option.value = admin.id;
              option.textContent = admin.name;
              helperAdminSelect.appendChild(option);
            }
          });
        }
      });

      helperAdminSelect.addEventListener('change', () => {
        if (helperAdminSelect.value) {
          helperAdminSection.classList.remove('hidden');
        } else {
          helperAdminSection.classList.add('hidden');
        }
      });

      closeAssignModal.addEventListener('click', () => {
        assignAdminModal.classList.add('hidden');
      });

      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º (–≥—Ä–∞—Ñ–∏–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)
      prevMonthAdminsBtn.addEventListener('click', () => {
        adminsViewMonth.setMonth(adminsViewMonth.getMonth() - 1);
        renderAdminsCalendar();
      });

      nextMonthAdminsBtn.addEventListener('click', () => {
        adminsViewMonth.setMonth(adminsViewMonth.getMonth() + 1);
        renderAdminsCalendar();
      });

      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º (—Ä–∞—Å—á–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã)
      prevMonthSalaryBtn.addEventListener('click', () => {
        salaryViewMonth.setMonth(salaryViewMonth.getMonth() - 1);
        calculateSalaries();
      });

      nextMonthSalaryBtn.addEventListener('click', () => {
        salaryViewMonth.setMonth(salaryViewMonth.getMonth() + 1);
        calculateSalaries();
      });

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      onAuthStateChanged(auth, (user) => {
        if (user) {
          isAdmin = true;
          logoutBtn.classList.remove('hidden');
          loginBtn.classList.add('hidden');
          loadData();
        } else {
          isAdmin = false;
          logoutBtn.classList.add('hidden');
          loginBtn.classList.remove('hidden');
        }
      });

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö –æ–±–ª–∞—Å—Ç–∏
      authContainer.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.add('hidden');
        }
      });

      assignAdminModal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.add('hidden');
        }
      });

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Esc
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          if (!authContainer.classList.contains('hidden')) {
            authContainer.classList.add('hidden');
          }
          if (!assignAdminModal.classList.contains('hidden')) {
            assignAdminModal.classList.add('hidden');
          }
        }
      });
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    init();
  </script>
</body>
</html>
