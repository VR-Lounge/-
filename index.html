<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VR Lounge - Учет администраторов</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background-color: #f5f5f7;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      color: #1d1d1f;
    }
    /* Остальные стили остаются без изменений */
  </style>
</head>
<body>
  <!-- Форма входа -->
  <div id="authContainer" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 hidden" onclick="event.target === this && this.classList.add('hidden')">
    <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-8 relative" onclick="event.stopPropagation()">
      <button id="closeAuthBtn" class="absolute top-5 right-5 text-gray-400 hover:text-gray-600 text-3xl font-thin leading-none focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full w-10 h-10 flex items-center justify-center" aria-label="Закрыть модальное окно">&times;</button>
      <h3 class="text-2xl font-semibold mb-6 text-center">Доступ для администратора</h3>
      <form id="loginForm" class="space-y-4">
        <div>
          <label for="loginEmail" class="block mb-2 font-medium">Email</label>
          <input type="email" id="loginEmail" required class="w-full rounded-3xl border border-gray-300 px-4 py-3">
        </div>
        <div>
          <label for="loginPassword" class="block mb-2 font-medium">Пароль</label>
          <input type="password" id="loginPassword" required class="w-full rounded-3xl border border-gray-300 px-4 py-3">
        </div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-3xl">
          Войти
        </button>
      </form>
    </div>
  </div>

  <!-- Основной интерфейс -->
  <header class="bg-white shadow-md sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-6 py-5 flex flex-col md:flex-row md:items-center md:justify-between">
      <h1 class="text-3xl font-semibold tracking-tight text-gray-900 select-none" style="font-weight: 600;">VR Lounge - Учет администраторов</h1>
      <div class="flex items-center space-x-4">
        <button id="logoutBtn" class="hidden text-sm text-blue-600 hover:text-blue-800">Выйти</button>
        <button id="loginBtn" class="text-sm text-blue-600 hover:text-blue-800">Вход для администратора</button>
      </div>
    </div>
  </header>

  <main class="flex-grow max-w-7xl mx-auto px-6 py-8 flex flex-col space-y-10">
    <!-- Управление администраторами -->
    <section>
      <h2 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight">График администраторов</h2>
      <div class="bg-white rounded-3xl shadow-lg max-w-4xl mx-auto p-8 border border-gray-200">
        <div class="flex justify-between mb-6">
          <button id="prevMonthAdmins" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-chevron-left text-lg"></i>
          </button>
          <h3 id="currentMonthAdmins" class="text-xl font-semibold text-gray-900 tracking-tight select-none"></h3>
          <button id="nextMonthAdmins" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-chevron-right text-lg"></i>
          </button>
        </div>
        
        <div id="adminsCalendar" class="grid grid-cols-7 gap-1 text-center text-sm select-none">
          <!-- Дни недели -->
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Пн</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Вт</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Ср</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Чт</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Пт</div>
          <div class="font-semibold text-indigo-600 py-3 border-b border-gray-200">Сб</div>
          <div class="font-semibold text-indigo-600 py-3 border-b border-gray-200">Вс</div>
        </div>
      </div>
    </section>

    <!-- Расчет зарплаты -->
    <section>
      <h2 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight">Расчет зарплаты</h2>
      <div class="bg-white rounded-3xl shadow-lg max-w-4xl mx-auto p-8 border border-gray-200">
        <div class="flex justify-between mb-6">
          <button id="prevMonthSalary" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-chevron-left text-lg"></i>
          </button>
          <h3 id="currentMonthSalary" class="text-xl font-semibold text-gray-900 tracking-tight select-none"></h3>
          <button id="nextMonthSalary" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-chevron-right text-lg"></i>
          </button>
        </div>
        
        <div id="salaryResults" class="space-y-6">
          <!-- Здесь будут отображаться результаты расчета -->
        </div>
      </div>
    </section>

    <!-- Модальное окно для назначения администратора -->
    <div id="assignAdminModal" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center p-6 hidden z-50">
      <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-8 relative ring-1 ring-gray-200">
        <button id="closeAssignModal" class="absolute top-5 right-5 text-gray-400 hover:text-gray-600 text-3xl font-thin leading-none focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full w-10 h-10 flex items-center justify-center" aria-label="Закрыть модальное окно">&times;</button>
        <h3 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight" id="assignModalTitle">Назначить администратора</h3>
        <form id="assignAdminForm" class="space-y-6">
          <input type="hidden" id="assignDate" name="assignDate">
          
          <div>
            <label class="block text-gray-900 font-semibold mb-2">Основной администратор</label>
            <select id="mainAdmin" name="mainAdmin" required class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
              <option value="">Выберите администратора</option>
              <!-- Опции будут заполнены динамически -->
            </select>
          </div>
          
          <div id="helperAdminSection" class="hidden">
            <label class="block text-gray-900 font-semibold mb-2">Помощник администратора</label>
            <select id="helperAdmin" name="helperAdmin" class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
              <option value="">Нет помощника</option>
              <!-- Опции будут заполнены динамически -->
            </select>
            
            <div class="mt-4">
              <label class="block text-gray-900 font-semibold mb-2">Часы работы помощника</label>
              <input type="number" id="helperHours" name="helperHours" min="1" max="24" class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Количество часов">
            </div>
          </div>
          
          <div class="flex space-x-4">
            <button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white py-3 rounded-3xl font-semibold transition focus:ring-4 focus:ring-blue-300 focus:outline-none">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script type="module">
    // Инициализация Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, onSnapshot, 
      deleteDoc, doc, updateDoc, query, where, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { 
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBaq_faWwfE_TXn4Xh_2U3GYSAsUzGJ1bk",
      authDomain: "vr-lounge33.firebaseapp.com",
      projectId: "vr-lounge33",
      storageBucket: "vr-lounge33.appspot.com",
      messagingSenderId: "825655988090",
      appId: "1:825655988090:web:76d8e0554b8601f8bd10c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Элементы интерфейса
    const authContainer = document.getElementById('authContainer');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginBtn = document.getElementById('loginBtn');
    const closeAuthBtn = document.getElementById('closeAuthBtn');
    
    // Элементы графика администраторов
    const adminsCalendar = document.getElementById('adminsCalendar');
    const currentMonthAdmins = document.getElementById('currentMonthAdmins');
    const prevMonthAdminsBtn = document.getElementById('prevMonthAdmins');
    const nextMonthAdminsBtn = document.getElementById('nextMonthAdmins');
    
    // Элементы расчета зарплаты
    const salaryResults = document.getElementById('salaryResults');
    const currentMonthSalary = document.getElementById('currentMonthSalary');
    const prevMonthSalaryBtn = document.getElementById('prevMonthSalary');
    const nextMonthSalaryBtn = document.getElementById('nextMonthSalary');
    
    // Модальное окно назначения администратора
    const assignAdminModal = document.getElementById('assignAdminModal');
    const assignAdminForm = document.getElementById('assignAdminForm');
    const assignModalTitle = document.getElementById('assignModalTitle');
    const assignDateInput = document.getElementById('assignDate');
    const mainAdminSelect = document.getElementById('mainAdmin');
    const helperAdminSelect = document.getElementById('helperAdmin');
    const helperAdminSection = document.getElementById('helperAdminSection');
    const helperHoursInput = document.getElementById('helperHours');
    const closeAssignModal = document.getElementById('closeAssignModal');

    // Состояние приложения
    let currentDate = new Date();
    currentDate.setDate(1);
    let selectedDate = null;
    let isAdmin = false;
    let admins = [];
    let adminAssignments = [];
    let bookings = [];
    let adminsViewMonth = new Date();
    let salaryViewMonth = new Date();

    // Цены услуг
    const servicePrices = {
      weekday_vr: 500,
      weekday_ps: 150,
      weekend_vr: 750,
      weekend_ps: 250,
      birthday: { // Цены за час
        1: 4000,
        2: 3500,
        3: 3000,
        4: 3000
      }
    };

    // Загрузка данных
    function loadData() {
      // Загрузка администраторов
      onSnapshot(collection(db, "admins"), (snapshot) => {
        admins = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        updateAdminSelects();
        renderAdminsCalendar();
      });

      // Загрузка назначений администраторов
      onSnapshot(collection(db, "adminAssignments"), (snapshot) => {
        adminAssignments = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        renderAdminsCalendar();
        calculateSalaries();
      });

      // Загрузка бронирований
      onSnapshot(collection(db, "bookings"), (snapshot) => {
        bookings = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        calculateSalaries();
      });
    }

    // Обновление списков администраторов в select
    function updateAdminSelects() {
      mainAdminSelect.innerHTML = '<option value="">Выберите администратора</option>';
      helperAdminSelect.innerHTML = '<option value="">Нет помощника</option>';
      
      admins.forEach(admin => {
        const option1 = document.createElement('option');
        option1.value = admin.id;
        option1.textContent = admin.name;
        mainAdminSelect.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = admin.id;
        option2.textContent = admin.name;
        helperAdminSelect.appendChild(option2);
      });
    }

    // Отображение календаря администраторов
    function renderAdminsCalendar() {
      // Очистка календаря (оставляем только заголовки дней недели)
      while (adminsCalendar.children.length > 7) {
        adminsCalendar.removeChild(adminsCalendar.lastChild);
      }

      const year = adminsViewMonth.getFullYear();
      const month = adminsViewMonth.getMonth();

      currentMonthAdmins.textContent = adminsViewMonth.toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
      });

      const firstDay = new Date(year, month, 1);
      let startDay = firstDay.getDay();
      startDay = startDay === 0 ? 6 : startDay - 1;

      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // Пустые ячейки для дней предыдущего месяца
      for (let i = 0; i < startDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'border border-gray-200 bg-gray-50 h-24 rounded-3xl';
        adminsCalendar.appendChild(emptyCell);
      }

      // Ячейки для дней текущего месяца
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        
        const dayCell = document.createElement('div');
        dayCell.className = 'border border-gray-300 rounded-3xl h-24 p-2 flex flex-col cursor-pointer hover:bg-blue-50 transition relative';
        
        // Выделение текущего дня
        const today = new Date();
        if (date.getDate() === today.getDate() && 
            date.getMonth() === today.getMonth() && 
            date.getFullYear() === today.getFullYear()) {
          dayCell.classList.add('ring-2', 'ring-blue-600');
        }

        // Номер дня
        const dayNumber = document.createElement('div');
        dayNumber.textContent = day;
        dayNumber.className = 'font-semibold text-sm text-gray-900 mb-1';
        dayCell.appendChild(dayNumber);

        // Назначенные администраторы
        const assignment = adminAssignments.find(a => a.date === dateStr);
        if (assignment) {
          const mainAdmin = admins.find(a => a.id === assignment.mainAdminId);
          if (mainAdmin) {
            const adminDiv = document.createElement('div');
            adminDiv.className = 'text-xs bg-blue-100 text-blue-800 rounded px-1 py-0.5 mb-1 truncate';
            adminDiv.textContent = `👑 ${mainAdmin.name}`;
            dayCell.appendChild(adminDiv);
          }

          if (assignment.helperAdminId) {
            const helperAdmin = admins.find(a => a.id === assignment.helperAdminId);
            if (helperAdmin) {
              const helperDiv = document.createElement('div');
              helperDiv.className = 'text-xs bg-indigo-100 text-indigo-800 rounded px-1 py-0.5 truncate';
              helperDiv.textContent = `🛠 ${helperAdmin.name} (${assignment.helperHours || 0}ч)`;
              dayCell.appendChild(helperDiv);
            }
          }
        }

        // Обработчик клика для назначения администраторов
        dayCell.addEventListener('click', () => {
          if (!isAdmin) {
            authContainer.classList.remove('hidden');
            return;
          }
          
          openAssignModal(date, dateStr);
        });

        adminsCalendar.appendChild(dayCell);
      }
    }

    // Открытие модального окна назначения администратора
    function openAssignModal(date, dateStr) {
      assignModalTitle.textContent = `Назначение администраторов на ${date.toLocaleDateString('ru-RU')}`;
      assignDateInput.value = dateStr;
      
      // Поиск существующего назначения
      const assignment = adminAssignments.find(a => a.date === dateStr);
      
      if (assignment) {
        mainAdminSelect.value = assignment.mainAdminId;
        helperAdminSelect.value = assignment.helperAdminId || '';
        helperHoursInput.value = assignment.helperHours || '';
        
        if (assignment.helperAdminId) {
          helperAdminSection.classList.remove('hidden');
        } else {
          helperAdminSection.classList.add('hidden');
        }
      } else {
        mainAdminSelect.value = '';
        helperAdminSelect.value = '';
        helperHoursInput.value = '';
        helperAdminSection.classList.add('hidden');
      }
      
      assignAdminModal.classList.remove('hidden');
    }

    // Расчет зарплат
    function calculateSalaries() {
      const year = salaryViewMonth.getFullYear();
      const month = salaryViewMonth.getMonth();
      
      currentMonthSalary.textContent = salaryViewMonth.toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
      });
      
      // Группировка бронирований по датам
      const bookingsByDate = {};
      bookings.forEach(booking => {
        const bookingDate = new Date(booking.bookingDate);
        if (bookingDate.getFullYear() === year && bookingDate.getMonth() === month) {
          const dateStr = booking.bookingDate;
          if (!bookingsByDate[dateStr]) {
            bookingsByDate[dateStr] = [];
          }
          bookingsByDate[dateStr].push(booking);
        }
      });
      
      // Группировка назначений по администраторам
      const salaryData = {};
      admins.forEach(admin => {
        salaryData[admin.id] = {
          name: admin.name,
          baseSalary: 0,
          bonusSalary: 0,
          totalSalary: 0,
          daysWorked: 0,
          hoursWorked: 0,
          details: []
        };
      });
      
      // Обработка каждого дня месяца
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      let totalRevenue = 0;
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        
        const assignment = adminAssignments.find(a => a.date === dateStr);
        if (!assignment) continue;
        
        const dayBookings = bookingsByDate[dateStr] || [];
        let dayRevenue = 0;
        
        // Расчет выручки за день
        dayBookings.forEach(booking => {
          let bookingRevenue = 0;
          
          if (booking.serviceType === 'birthday') {
            // Расчет для дней рождения
            const hours = Math.min(booking.duration, 4);
            bookingRevenue = servicePrices.birthday[hours] || 0;
          } else {
            // Расчет для других услуг
            bookingRevenue = (servicePrices[booking.serviceType] || 0) * booking.duration;
          }
          
          dayRevenue += bookingRevenue;
        });
        
        totalRevenue += dayRevenue;
        
        // Начисление зарплаты основному администратору
        if (assignment.mainAdminId && salaryData[assignment.mainAdminId]) {
          salaryData[assignment.mainAdminId].daysWorked++;
          salaryData[assignment.mainAdminId].baseSalary += 500; // Фиксированная ставка
          
          let bonusPercent = 0.15; // Стандартный бонус
          if (assignment.helperAdminId) {
            bonusPercent = 0.08; // Бонус при наличии помощника
          }
          
          const bonus = dayRevenue * bonusPercent;
          salaryData[assignment.mainAdminId].bonusSalary += bonus;
          salaryData[assignment.mainAdminId].totalSalary += 500 + bonus;
          
          salaryData[assignment.mainAdminId].details.push({
            date: dateStr,
            type: 'Основная смена',
            base: 500,
            bonus: bonus,
            revenue: dayRevenue,
            hours: 0
          });
        }
        
        // Начисление зарплаты помощнику
        if (assignment.helperAdminId && salaryData[assignment.helperAdminId] && assignment.helperHours) {
          const hours = parseInt(assignment.helperHours) || 0;
          salaryData[assignment.helperAdminId].hoursWorked += hours;
          
          let bonusPercent = 0.07; // Бонус помощника
          const base = hours * 150; // Почасовая ставка
          const bonus = dayRevenue * bonusPercent;
          
          salaryData[assignment.helperAdminId].baseSalary += base;
          salaryData[assignment.helperAdminId].bonusSalary += bonus;
          salaryData[assignment.helperAdminId].totalSalary += base + bonus;
          
          salaryData[assignment.helperAdminId].details.push({
            date: dateStr,
            type: 'Помощь на смене',
            base: base,
            bonus: bonus,
            revenue: dayRevenue,
            hours: hours
          });
        }
      }
      
      // Отображение результатов
      renderSalaryResults(salaryData, totalRevenue);
    }

    // Отображение результатов расчета зарплаты
    function renderSalaryResults(salaryData, totalRevenue) {
      salaryResults.innerHTML = '';
      
      // Общая выручка
      const revenueCard = document.createElement('div');
      revenueCard.className = 'bg-white rounded-2xl shadow-md p-6 border border-gray-200';
      revenueCard.innerHTML = `
        <h3 class="text-lg font-semibold mb-4">Общая выручка за месяц</h3>
        <p class="text-2xl font-bold text-green-600">${totalRevenue.toLocaleString()} ₽</p>
      `;
      salaryResults.appendChild(revenueCard);
      
      // Зарплаты администраторов
      admins.forEach(admin => {
        const data = salaryData[admin.id];
        if (!data || data.totalSalary <= 0) return;
        
        const adminCard = document.createElement('div');
        adminCard.className = 'bg-white rounded-2xl shadow-md p-6 border border-gray-200';
        
        adminCard.innerHTML = `
          <h3 class="text-lg font-semibold mb-2">${admin.name}</h3>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <p class="text-sm text-gray-500">Отработано смен</p>
              <p class="font-medium">${data.daysWorked}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Отработано часов</p>
              <p class="font-medium">${data.hoursWorked}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Фиксированная часть</p>
              <p class="font-medium">${data.baseSalary.toLocaleString()} ₽</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Бонусная часть</p>
              <p class="font-medium">${data.bonusSalary.toLocaleString()} ₽</p>
            </div>
          </div>
          <div class="border-t border-gray-200 pt-4">
            <p class="text-sm text-gray-500">Итого зарплата</p>
            <p class="text-xl font-bold text-blue-600">${data.totalSalary.toLocaleString()} ₽</p>
          </div>
          <button class="mt-4 text-sm text-blue-600 hover:text-blue-800 view-details" data-admin="${admin.id}">
            <i class="fas fa-list mr-1"></i> Подробнее
          </button>
          <div id="details-${admin.id}" class="hidden mt-4 space-y-3"></div>
        `;
        
        salaryResults.appendChild(adminCard);
      });
      
      // Обработчики для кнопок "Подробнее"
      document.querySelectorAll('.view-details').forEach(btn => {
        btn.addEventListener('click', () => {
          const adminId = btn.getAttribute('data-admin');
          const detailsDiv = document.getElementById(`details-${adminId}`);
          const data = salaryData[adminId];
          
          if (detailsDiv.classList.contains('hidden')) {
            detailsDiv.innerHTML = '';
            data.details.forEach(detail => {
              const detailItem = document.createElement('div');
              detailItem.className = 'text-sm border-b border-gray-100 pb-2';
              detailItem.innerHTML = `
                <p class="font-medium">${detail.date} - ${detail.type}</p>
                <div class="grid grid-cols-3 gap-2 mt-1">
                  <span>${detail.hours > 0 ? detail.hours + 'ч' : 'Смена'}: ${detail.base} ₽</span>
                  <span>Бонус: ${detail.bonus.toFixed(0)} ₽</span>
                  <span>Выручка: ${detail.revenue.toFixed(0)} ₽</span>
                </div>
              `;
              detailsDiv.appendChild(detailItem);
            });
            detailsDiv.classList.remove('hidden');
            btn.innerHTML = '<i class="fas fa-chevron-up mr-1"></i> Скрыть';
          } else {
            detailsDiv.classList.add('hidden');
            btn.innerHTML = '<i class="fas fa-list mr-1"></i> Подробнее';
          }
        });
      });
    }

    // Инициализация приложения
    function init() {
      // Обработчики авторизации
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        try {
          await signInWithEmailAndPassword(auth, email, password);
          authContainer.classList.add('hidden');
        } catch (error) {
          alert('Ошибка входа: ' + error.message);
        }
      });

      logoutBtn.addEventListener('click', () => {
        signOut(auth);
      });

      loginBtn.addEventListener('click', () => {
        authContainer.classList.remove('hidden');
      });

      closeAuthBtn.addEventListener('click', () => {
        authContainer.classList.add('hidden');
      });

      // Обработчики модального окна назначения администраторов
      assignAdminForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const date = assignDateInput.value;
        const mainAdminId = mainAdminSelect.value;
        const helperAdminId = helperAdminSelect.value;
        const helperHours = helperHoursInput.value;
        
        if (!mainAdminId) {
          alert('Пожалуйста, выберите основного администратора');
          return;
        }
        
        try {
          const assignmentRef = doc(db, "adminAssignments", date);
          await setDoc(assignmentRef, {
            date: date,
            mainAdminId: mainAdminId,
            helperAdminId: helperAdminId || null,
            helperHours: helperHours || null
          });
          
          assignAdminModal.classList.add('hidden');
        } catch (error) {
          console.error("Ошибка сохранения:", error);
          alert("Не удалось сохранить назначение");
        }
      });

      mainAdminSelect.addEventListener('change', () => {
        if (mainAdminSelect.value) {
          // Обновляем список помощников (исключая выбранного основного администратора)
          helperAdminSelect.innerHTML = '<option value="">Нет помощника</option>';
          admins.forEach(admin => {
            if (admin.id !== mainAdminSelect.value) {
              const option = document.createElement('option');
              option.value = admin.id;
              option.textContent = admin.name;
              helperAdminSelect.appendChild(option);
            }
          });
        }
      });

      helperAdminSelect.addEventListener('change', () => {
        if (helperAdminSelect.value) {
          helperAdminSection.classList.remove('hidden');
        } else {
          helperAdminSection.classList.add('hidden');
        }
      });

      closeAssignModal.addEventListener('click', () => {
        assignAdminModal.classList.add('hidden');
      });

      // Навигация по месяцам (график администраторов)
      prevMonthAdminsBtn.addEventListener('click', () => {
        adminsViewMonth.setMonth(adminsViewMonth.getMonth() - 1);
        renderAdminsCalendar();
      });

      nextMonthAdminsBtn.addEventListener('click', () => {
        adminsViewMonth.setMonth(adminsViewMonth.getMonth() + 1);
        renderAdminsCalendar();
      });

      // Навигация по месяцам (расчет зарплаты)
      prevMonthSalaryBtn.addEventListener('click', () => {
        salaryViewMonth.setMonth(salaryViewMonth.getMonth() - 1);
        calculateSalaries();
      });

      nextMonthSalaryBtn.addEventListener('click', () => {
        salaryViewMonth.setMonth(salaryViewMonth.getMonth() + 1);
        calculateSalaries();
      });

      // Отслеживание состояния авторизации
      onAuthStateChanged(auth, (user) => {
        if (user) {
          isAdmin = true;
          logoutBtn.classList.remove('hidden');
          loginBtn.classList.add('hidden');
          loadData();
        } else {
          isAdmin = false;
          logoutBtn.classList.add('hidden');
          loginBtn.classList.remove('hidden');
        }
      });

      // Закрытие модальных окон при клике вне их области
      authContainer.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.add('hidden');
        }
      });

      assignAdminModal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.add('hidden');
        }
      });

      // Закрытие модальных окон при нажатии Esc
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          if (!authContainer.classList.contains('hidden')) {
            authContainer.classList.add('hidden');
          }
          if (!assignAdminModal.classList.contains('hidden')) {
            assignAdminModal.classList.add('hidden');
          }
        }
      });
    }

    // Запуск приложения
    init();
  </script>
</body>
</html>
