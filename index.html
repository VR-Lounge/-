<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VR Lounge - Игровой Рай Календарь Записей</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background-color: #f5f5f7;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      color: #1d1d1f;
    }
    ul::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ul::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.1);
      border-radius: 3px;
    }
    ul::-webkit-scrollbar-track {
      background: transparent;
    }
    #bookingModal {
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.4);
      border-radius: 12px;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.4);
      border-radius: 12px;
      border-color: #007aff;
    }
    .bookings-list::-webkit-scrollbar {
      width: 5px;
      height: 5px;
    }
    .bookings-list::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.1);
      border-radius: 2.5px;
    }
    .bookings-list::-webkit-scrollbar-track {
      background: transparent;
    }
  </style>
</head>
<body>
  <!-- Форма входа (изначально скрыта) -->
  <div id="authContainer" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-8">
      <h3 class="text-2xl font-semibold mb-6 text-center">Доступ для администратора</h3>
      <form id="loginForm" class="space-y-4">
        <div>
          <label for="loginEmail" class="block mb-2 font-medium">Email</label>
          <input type="email" id="loginEmail" required class="w-full rounded-3xl border border-gray-300 px-4 py-3">
        </div>
        <div>
          <label for="loginPassword" class="block mb-2 font-medium">Пароль</label>
          <input type="password" id="loginPassword" required class="w-full rounded-3xl border border-gray-300 px-4 py-3">
        </div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-3xl">
          Войти
        </button>
      </form>
    </div>
  </div>

  <!-- Основной интерфейс -->
  <header class="bg-white shadow-md sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-6 py-5 flex flex-col md:flex-row md:items-center md:justify-between">
      <h1 class="text-3xl font-semibold tracking-tight text-gray-900 select-none" style="font-weight: 600;">VR Lounge - Игровой Рай</h1>
      <div class="flex items-center space-x-4">
        <p class="mt-1 md:mt-0 text-gray-500 text-sm select-none">Календарь записи клиентов</p>
        <button id="logoutBtn" class="hidden text-sm text-blue-600 hover:text-blue-800">Выйти</button>
        <button id="loginBtn" class="text-sm text-blue-600 hover:text-blue-800">Вход для администратора</button>
      </div>
    </div>
  </header>

  <main class="flex-grow max-w-7xl mx-auto px-6 py-8 flex flex-col space-y-10">
    <!-- Календарь и кнопка добавления записи -->
    <section>
      <h2 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight">Календарь записи</h2>
      <div class="bg-white rounded-3xl shadow-lg max-w-4xl mx-auto p-8 border border-gray-200">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 space-y-5 md:space-y-0">
          <div class="flex items-center space-x-3">
            <button id="prevMonth" aria-label="Предыдущий месяц" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
              <i class="fas fa-chevron-left text-lg"></i>
            </button>
            <h3 id="monthYear" class="text-xl font-semibold text-gray-900 tracking-tight select-none"></h3>
            <button id="nextMonth" aria-label="Следующий месяц" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
              <i class="fas fa-chevron-right text-lg"></i>
            </button>
          </div>
          <button id="addBookingBtn" class="inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-semibold rounded-3xl px-5 py-3 shadow-md transition focus:ring-4 focus:ring-blue-300 focus:outline-none">
            <i class="fas fa-plus text-base"></i>
            <span>Добавить запись</span>
          </button>
        </div>

        <div id="calendar" class="grid grid-cols-7 gap-1 text-center text-sm select-none user-select-none">
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200 rounded-tl-3xl">Пн</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Вт</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Ср</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Чт</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Пт</div>
          <div class="font-semibold text-indigo-600 py-3 border-b border-gray-200">Сб</div>
          <div class="font-semibold text-indigo-600 py-3 border-b border-gray-200 rounded-tr-3xl">Вс</div>
        </div>
      </div>
    </section>

    <!-- Список записей -->
    <section>
      <h2 id="bookingsListTitle" class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight">Список записей</h2>
      <div class="bg-white rounded-3xl shadow-lg max-w-4xl mx-auto p-8 border border-gray-200 min-h-[200px]">
        <ul id="bookingsList" class="space-y-4 max-h-[400px] overflow-y-auto text-gray-900 text-base leading-relaxed">
          <!-- Записи будут добавлены сюда -->
        </ul>
        <p id="noBookingsText" class="text-center text-gray-500 italic select-none">Нет записей на выбранный месяц</p>
      </div>
    </section>

    <!-- Стоимость услуг -->
    <section class="mb-12">
      <h2 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight">Стоимость услуг</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-7xl mx-auto">
        <div class="bg-white rounded-3xl shadow-lg p-8 border border-gray-200">
          <h3 class="text-xl font-semibold mb-5 border-b border-gray-200 pb-3 text-gray-900 tracking-tight">Будние дни</h3>
          <ul class="space-y-4 text-gray-700 text-base leading-relaxed">
            <li class="flex items-center space-x-3">
              <i class="fas fa-vr-cardboard text-blue-600 text-lg flex-shrink-0"></i>
              <span>VR очки — 500 руб./час (половина часа 250 руб)</span>
            </li>
            <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-blue-600 text-lg flex-shrink-0"></i>
              <span>PS за 1 джойстик — 150 руб./час</span>
            </li>
          </ul>
        </div>
        <div class="bg-white rounded-3xl shadow-lg p-8 border border-gray-200">
          <h3 class="text-xl font-semibold mb-5 border-b border-gray-200 pb-3 text-gray-900 tracking-tight">Выходные дни</h3>
          <ul class="space-y-4 text-gray-700 text-base leading-relaxed">
            <li class="flex items-center space-x-3">
              <i class="fas fa-vr-cardboard text-indigo-600 text-lg flex-shrink-0"></i>
              <span>VR очки — 750 руб./час (половина часа 350 руб)</span>
            </li>
            <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-indigo-600 text-lg flex-shrink-0"></i>
              <span>PS за 1 джойстик — 250 руб./час</span>
            </li>
          </ul>
        </div>
        <div class="bg-white rounded-3xl shadow-lg p-8 border border-gray-200">
          <h3 class="text-xl font-semibold mb-5 border-b border-gray-200 pb-3 text-gray-900 tracking-tight">День рождения</h3>
          <ul class="space-y-3 text-gray-700 text-base leading-relaxed">
            <li>Первый час — 4000 руб.</li>
            <li>Второй час — 3500 руб.</li>
            <li>Третий час — 3000 руб.</li>
            <li>Четвертый и далее — 3000 руб./час</li>
          </ul>
          <p class="mt-5 font-semibold text-gray-900 tracking-tight">В стоимость входит аренда всего помещения:</p>
          <ul class="list-disc list-inside text-gray-700 space-y-1 mt-2 text-base leading-relaxed">
            <li>VR очки</li>
            <li>PS комната</li>
            <li>Караоке</li>
            <li>Кино</li>
            <li>XBOX 360</li>
            <li>Танцы в XBOX</li>
            <li>Игры на ПК</li>
          </ul>
          <p class="mt-4 text-gray-500 italic text-sm">Можно заказать свою еду и напитки</p>
        </div>
      </div>
    </section>
  </main>


  <!-- Модальное окно бронирования -->
  <div id="bookingModal" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center p-6 hidden z-50">
    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-8 relative ring-1 ring-gray-200">
      <button id="closeModal" class="absolute top-5 right-5 text-gray-400 hover:text-gray-600 text-3xl font-thin leading-none focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full w-10 h-10 flex items-center justify-center" aria-label="Закрыть модальное окно">&times;</button>
      <h3 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight" id="modalTitle">Добавить запись</h3>
      <form id="bookingForm" class="space-y-6">
        <input type="hidden" id="bookingId" name="bookingId" />
        <div>
          <label for="clientName" class="block text-gray-900 font-semibold mb-2">Имя клиента</label>
          <input type="text" id="clientName" name="clientName" required autocomplete="off" class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Введите имя клиента" />
        </div>
        <div>
          <label for="clientPhone" class="block text-gray-900 font-semibold mb-2">Номер телефона</label>
          <input type="tel" id="clientPhone" name="clientPhone" required autocomplete="off"
         class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
         placeholder="+7 (XXX) XXX-XX-XX" />
        </div>
        <div>
          <label for="bookingDate" class="block text-gray-900 font-semibold mb-2">Дата</label>
          <input type="date" id="bookingDate" name="bookingDate" required class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" />
        </div>
        <div>
          <label for="startTime" class="block text-gray-900 font-semibold mb-2">Время начала</label>
          <input type="time" id="startTime" name="startTime" required class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" />
        </div>
        <div>
          <label for="duration" class="block text-gray-900 font-semibold mb-2">Длительность (часы)</label>
          <select id="duration" name="duration" required class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            <option value="0.5">0.5</option>
            <option value="1" selected>1</option>
            <option value="1.5">1.5</option>
            <option value="2">2</option>
            <option value="2.5">2.5</option>
            <option value="3">3</option>
            <option value="3.5">3.5</option>
            <option value="4">4</option>
          </select>
        </div>
        <div>
          <label for="serviceType" class="block text-gray-900 font-semibold mb-2">Тип услуги</label>
          <select id="serviceType" name="serviceType" required class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            <option value="weekday_vr">Будние дни - VR очки</option>
            <option value="weekday_ps">Будние дни - PS (1 джойстик)</option>
            <option value="weekend_vr">Выходные дни - VR очки</option>
            <option value="weekend_ps">Выходные дни - PS (1 джойстик)</option>
            <option value="birthday">День рождения (аренда помещения)</option>
          </select>
        </div>
        <div>
          <label for="notes" class="block text-gray-900 font-semibold mb-2">Примечания</label>
          <textarea id="notes" name="notes" rows="3" placeholder="Введите дополнительные сведения" class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none transition resize-none"></textarea>
        </div>
        <div class="flex space-x-4">
          <button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white py-3 rounded-3xl font-semibold transition focus:ring-4 focus:ring-blue-300 focus:outline-none">Сохранить запись</button>
          <button type="button" id="deleteBookingBtn" class="hidden flex-grow bg-red-600 hover:bg-red-700 active:bg-red-800 text-white py-3 rounded-3xl font-semibold transition focus:ring-4 focus:ring-red-300 focus:outline-none">Удалить запись</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase и основная логика приложения -->
  <script type="module">
    // Инициализация Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, onSnapshot, 
      deleteDoc, doc, updateDoc, query, where 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { 
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Ваша конфигурация Firebase (замените на свою!)
    const firebaseConfig = {
      apiKey: "AIzaSyBaq_faWwfE_TXn4Xh_2U3GYSAsUzGJ1bk",
      authDomain: "vr-lounge33.firebaseapp.com",
      projectId: "vr-lounge33",
      storageBucket: "vr-lounge33.appspot.com",
      messagingSenderId: "825655988090",
      appId: "1:825655988090:web:76d8e0554b8601f8bd10c3"
    };

    // Инициализация Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Элементы интерфейса
    const calendarEl = document.getElementById('calendar');
    const monthYearEl = document.getElementById('monthYear');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const addBookingBtn = document.getElementById('addBookingBtn');
    const bookingModal = document.getElementById('bookingModal');
    const closeModalBtn = document.getElementById('closeModal');
    const bookingForm = document.getElementById('bookingForm');
    const bookingsListEl = document.getElementById('bookingsList');
    const noBookingsText = document.getElementById('noBookingsText');
    const modalTitle = document.getElementById('modalTitle');
    const bookingIdInput = document.getElementById('bookingId');
    const deleteBookingBtn = document.getElementById('deleteBookingBtn');
    const bookingsListTitle = document.getElementById('bookingsListTitle');
    const authContainer = document.getElementById('authContainer');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginBtn = document.getElementById('loginBtn');
    const clientPhoneInput = document.getElementById('clientPhone');

    // Состояние приложения
    let currentDate = new Date();
    currentDate.setDate(1);
    let selectedDate = null;
    let bookings = [];
    let isAdmin = false;

    // Маска для телефона (простая версия)
    clientPhoneInput.addEventListener('input', function(e) {
    let numbers = e.target.value.replace(/\D/g, '');
    // Если номер начинается с 7 или 8, заменяем на +7
    if (numbers.startsWith('7') || numbers.startsWith('8')) {
    numbers = '7' + numbers.substring(1);
    }
    // Форматируем только если есть цифры
    if (numbers.length > 0) {
    const match = numbers.match(/^7(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})$/);
    e.target.value = '+7' + (match[1] ? ' (' + match[1] : '') + 
                      (match[2] ? ') ' + match[2] : '') + 
                      (match[3] ? '-' + match[3] : '') + 
                      (match[4] ? '-' + match[4] : '');
    }
    });

    // ================== АУТЕНТИФИКАЦИЯ ==================
    // Обработчик формы входа
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
        authContainer.classList.add('hidden');
      } catch (error) {
        alert('Ошибка входа: ' + error.message);
      }
    });

    // Кнопка выхода
    logoutBtn.addEventListener('click', () => {
      signOut(auth);
    });

    // Кнопка входа
    loginBtn.addEventListener('click', () => {
      authContainer.classList.remove('hidden');
    });

    // Отслеживание состояния авторизации
    onAuthStateChanged(auth, (user) => {
      if (user) {
        isAdmin = true;
        logoutBtn.classList.remove('hidden');
        loginBtn.classList.add('hidden');
        addBookingBtn.classList.remove('hidden');
      } else {
        isAdmin = false;
        logoutBtn.classList.add('hidden');
        loginBtn.classList.remove('hidden');
        addBookingBtn.classList.add('hidden');
      }
    });

    // ================== ОСНОВНАЯ ЛОГИКА ==================
    // Загрузка и отображение данных
    onSnapshot(collection(db, "bookings"), (snapshot) => {
      bookings = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      renderCalendar();
      renderBookingsList();
    });

    function isWeekend(date) {
      const day = date.getDay();
      return day === 0 || day === 6;
    }

    function renderCalendar() {
      while (calendarEl.children.length > 7) {
        calendarEl.removeChild(calendarEl.lastChild);
      }

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      monthYearEl.textContent = currentDate.toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
      });

      const firstDay = new Date(year, month, 1);
      let startDay = firstDay.getDay();
      startDay = startDay === 0 ? 6 : startDay - 1;

      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < startDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'border border-gray-200 bg-gray-50 h-24 rounded-3xl';
        calendarEl.appendChild(emptyCell);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dayCell = document.createElement('div');
        dayCell.className = 'border border-gray-300 rounded-3xl h-24 p-3 flex flex-col justify-start cursor-pointer hover:bg-blue-50 transition relative select-text';

        if (isWeekend(date)) {
          dayCell.classList.add('bg-blue-50');
        }

        const today = new Date();
        if (
          day === today.getDate() &&
          month === today.getMonth() &&
          year === today.getFullYear()
        ) {
          dayCell.classList.add('ring-2', 'ring-blue-600');
        }

        if (
          selectedDate &&
          date.getFullYear() === selectedDate.getFullYear() &&
          date.getMonth() === selectedDate.getMonth() &&
          date.getDate() === selectedDate.getDate()
        ) {
          dayCell.classList.add('bg-blue-200', 'ring-4', 'ring-blue-500');
        }

        const dayNumber = document.createElement('div');
        dayNumber.textContent = day;
        dayNumber.className = 'font-semibold text-sm text-gray-900 mb-1 select-none';
        dayCell.appendChild(dayNumber);

        const dayBookings = bookings.filter((b) => {
          const bDate = new Date(b.bookingDate);
          return (
            bDate.getFullYear() === year &&
            bDate.getMonth() === month &&
            bDate.getDate() === day
          );
        });

        if (dayBookings.length > 0) {
          const bookingsList = document.createElement('ul');
          bookingsList.className = 'bookings-list mt-0.5 overflow-y-auto max-h-16 text-xs text-gray-800 space-y-0.5';

          dayBookings.forEach((b) => {
            const li = document.createElement('li');
            li.className = 'truncate rounded-2xl px-2 py-0.5';

            let bgColor = 'bg-gray-100 text-gray-700';
            if (b.serviceType === 'weekday_vr') bgColor = 'bg-blue-100 text-blue-800';
            else if (b.serviceType === 'weekday_ps') bgColor = 'bg-blue-200 text-blue-900';
            else if (b.serviceType === 'weekend_vr') bgColor = 'bg-indigo-100 text-indigo-900';
            else if (b.serviceType === 'weekend_ps') bgColor = 'bg-indigo-200 text-indigo-900';
            else if (b.serviceType === 'birthday') bgColor = 'bg-pink-200 text-pink-900 font-semibold';

            li.classList.add(...bgColor.split(' '));
            li.textContent = `${b.startTime} (${b.duration}ч) - ${b.clientName}`;
            bookingsList.appendChild(li);
          });

          dayCell.appendChild(bookingsList);
        }

        dayCell.addEventListener('click', () => {
          selectedDate = date;
          renderCalendar();
        });

        calendarEl.appendChild(dayCell);
      }
    }

    function renderBookingsList() {
      bookingsListEl.innerHTML = '';
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      let filteredBookings;
      if (selectedDate) {
        bookingsListTitle.textContent = `Список записей на ${selectedDate.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric' })}`;
        filteredBookings = bookings.filter((b) => {
          const bDate = new Date(b.bookingDate);
          return (
            bDate.getFullYear() === selectedDate.getFullYear() &&
            bDate.getMonth() === selectedDate.getMonth() &&
            bDate.getDate() === selectedDate.getDate()
          );
        });
      } else {
        bookingsListTitle.textContent = `Список записей на ${currentDate.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' })}`;
        filteredBookings = bookings.filter((b) => {
          const bDate = new Date(b.bookingDate);
          return bDate.getFullYear() === year && bDate.getMonth() === month;
        });
      }

      if (filteredBookings.length === 0) {
        noBookingsText.classList.remove('hidden');
        return;
      } else {
        noBookingsText.classList.add('hidden');
      }

      filteredBookings.sort((a, b) => {
        const dateA = new Date(a.bookingDate + 'T' + a.startTime);
        const dateB = new Date(b.bookingDate + 'T' + b.startTime);
        return dateA - dateB;
      });

      filteredBookings.forEach((b) => {
        const li = document.createElement('li');
        li.className = 'border border-gray-300 rounded-3xl p-4 shadow-sm flex flex-col md:flex-row md:items-center md:justify-between space-y-2 md:space-y-0';

        const dateObj = new Date(b.bookingDate);
        const dateStr = dateObj.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric' });
        const timeStr = b.startTime + ' (' + b.duration + 'ч)';

        const leftDiv = document.createElement('div');
        leftDiv.className = 'text-gray-700 font-semibold text-base';
        leftDiv.textContent = `${dateStr}, ${timeStr}`;

        const middleDiv = document.createElement('div');
        middleDiv.className = 'text-gray-900 font-semibold text-base truncate max-w-xs';
        middleDiv.textContent = b.clientName;

        const rightDiv = document.createElement('div');
        rightDiv.className = 'text-sm text-gray-600 text-right max-w-xs';

        let serviceLabel = '';
        switch (b.serviceType) {
          case 'weekday_vr': serviceLabel = 'Будние дни - VR очки'; break;
          case 'weekday_ps': serviceLabel = 'Будние дни - PS (1 джойстик)'; break;
          case 'weekend_vr': serviceLabel = 'Выходные дни - VR очки'; break;
          case 'weekend_ps': serviceLabel = 'Выходные дни - PS (1 джойстик)'; break;
          case 'birthday': serviceLabel = 'День рождения (аренда помещения)'; break;
        }

        rightDiv.innerHTML = `<div class="font-semibold mb-1">${serviceLabel}</div>`;
        
        // Добавляем кликабельный номер телефона
        // Внутри функции renderBookingsList, где формируется rightDiv:
        if (b.clientPhone) {
        // Удаляем возможные дублирования +7
        let cleanPhone = b.clientPhone.replace(/^\+7\s*\+\s*7/, '+7');
        cleanPhone = cleanPhone.replace(/[^0-9+() -]/g, '');
        const telNumber = cleanPhone.replace(/\D/g, '');
        rightDiv.innerHTML += `<div class="mt-1"><a href="tel:${telNumber}" class="text-blue-600 hover:text-blue-800 hover:underline">${cleanPhone}</a></div>`;
        }
        
        if (b.notes) {
          rightDiv.innerHTML += `<div class="italic whitespace-pre-wrap">${b.notes}</div>`;
        }

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'flex space-x-3 ml-4';

        if (isAdmin) {
          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'text-blue-600 hover:text-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-400 rounded p-1';
          editBtn.title = 'Редактировать запись';
          editBtn.innerHTML = '<i class="fas fa-edit fa-lg"></i>';
          editBtn.addEventListener('click', () => openEditModal(b.id));

          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-red-400 rounded p-1';
          deleteBtn.title = 'Удалить запись';
          deleteBtn.innerHTML = '<i class="fas fa-trash-alt fa-lg"></i>';
          deleteBtn.addEventListener('click', () => {
            if (confirm('Вы уверены, что хотите удалить эту запись?')) {
              deleteBooking(b.id);
            }
          });

          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(deleteBtn);
        }

        li.appendChild(leftDiv);
        li.appendChild(middleDiv);
        li.appendChild(rightDiv);
        
        if (isAdmin) {
          li.appendChild(actionsDiv);
        }

        bookingsListEl.appendChild(li);
      });
    }

    async function deleteBooking(id) {
      try {
        await deleteDoc(doc(db, "bookings", id));
      } catch (error) {
        console.error("Ошибка удаления:", error);
        alert("Не удалось удалить запись");
      }
    }

    function openEditModal(id) {
      if (!isAdmin) {
        authContainer.classList.remove('hidden');
        return;
      }

      const booking = bookings.find(b => b.id === id);
      if (!booking) return;

      bookingIdInput.value = booking.id;
      modalTitle.textContent = 'Редактировать запись';
      deleteBookingBtn.classList.remove('hidden');
      bookingModal.classList.remove('hidden');

      bookingForm.clientName.value = booking.clientName;
      bookingForm.clientPhone.value = booking.clientPhone || '';
      bookingForm.bookingDate.value = booking.bookingDate;
      bookingForm.startTime.value = booking.startTime;
      bookingForm.duration.value = booking.duration.toString();
      bookingForm.serviceType.value = booking.serviceType;
      bookingForm.notes.value = booking.notes || '';
      bookingForm.clientName.focus();

      selectedDate = new Date(booking.bookingDate);
      renderCalendar();
    }

    // Обработчики событий интерфейса
    prevMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      selectedDate = null;
      renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      selectedDate = null;
      renderCalendar();
    });

    addBookingBtn.addEventListener('click', () => {
      if (!isAdmin) {
        authContainer.classList.remove('hidden');
        return;
      }

      bookingIdInput.value = '';
      modalTitle.textContent = 'Добавить запись';
      deleteBookingBtn.classList.add('hidden');
      bookingModal.classList.remove('hidden');
      const todayStr = new Date().toISOString().slice(0, 10);
      bookingForm.bookingDate.value = todayStr;
      bookingForm.clientName.value = '';
      bookingForm.clientPhone.value = '';
      bookingForm.startTime.value = '';
      bookingForm.duration.value = '1';
      bookingForm.serviceType.value = 'weekday_vr';
      bookingForm.notes.value = '';
      bookingForm.clientName.focus();
      selectedDate = null;
    });

    closeModalBtn.addEventListener('click', () => {
      bookingModal.classList.add('hidden');
    });

    bookingModal.addEventListener('click', (e) => {
      if (e.target === bookingModal) {
        bookingModal.classList.add('hidden');
      }
    });

    bookingForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!isAdmin) {
        alert("Требуется авторизация!");
        authContainer.classList.remove('hidden');
        return;
      }

      const id = bookingIdInput.value;
      const newBooking = {
        clientName: bookingForm.clientName.value.trim(),
        clientPhone: bookingForm.clientPhone.value.replace(/^\+7\s*\+\s*7/, '+7'),
        bookingDate: bookingForm.bookingDate.value,
        startTime: bookingForm.startTime.value,
        duration: parseFloat(bookingForm.duration.value),
        serviceType: bookingForm.serviceType.value,
        notes: bookingForm.notes.value.trim(),
      };

      // Валидация
      if (!newBooking.clientName) {
        alert('Пожалуйста, введите имя клиента.');
        return;
      }
      if (!newBooking.clientPhone || newBooking.clientPhone.replace(/\D/g, '').length < 10) {
        alert('Пожалуйста, введите корректный номер телефона.');
        return;
      }
      if (!newBooking.bookingDate) {
        alert('Пожалуйста, выберите дату.');
        return;
      }
      if (!newBooking.startTime) {
        alert('Пожалуйста, выберите время начала.');
        return;
      }

      try {
        if (id) {
          // Обновление существующей записи
          await updateDoc(doc(db, "bookings", id), newBooking);
        } else {
          // Добавление новой записи
          await addDoc(collection(db, "bookings"), newBooking);
        }
        bookingModal.classList.add('hidden');
      } catch (error) {
        console.error("Ошибка сохранения:", error);
        alert("Не удалось сохранить запись");
      }
    });

    // Инициализация календаря
    renderCalendar();
  </script>
</body>
</html>
