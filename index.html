<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VR Lounge - Управление Записями и Администраторами</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background-color: #f5f5f7;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      color: #1d1d1f;
    }
    ul::-webkit-scrollbar, .bookings-list::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ul::-webkit-scrollbar-thumb, .bookings-list::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.1);
      border-radius: 3px;
    }
    ul::-webkit-scrollbar-track, .bookings-list::-webkit-scrollbar-track {
      background: transparent;
    }
    #bookingModal, #assignAdminModal, #authContainer {
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.4);
      border-radius: 12px;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.4);
      border-radius: 12px;
      border-color: #007aff;
    }
    .calendar-day-cell { /* Добавлен класс для ячеек календаря админов */
       min-height: 100px; /* Минимальная высота ячейки */
    }

    /* Стили для тегов-кнопок услуг */
    .service-tag {
      /* display: inline-flex; */ /* Убрано */
      display: inline-block; /* Чтобы теги шли в строку, но контент внутри мог быть блочным */
      flex-direction: column;
      /* align-items: center; */ /* Убрано, текст выровняем по центру */
      /* padding: 8px 16px; */
      padding: 12px 10px; /* Немного изменил отступы */
      border-radius: 14px; /* Чуть менее круглые */
      background-color: #f5f5f7;
      color: #1d1d1f;
      font-weight: 500;
      border: 1px solid #e5e5e5;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      text-align: center; /* Выравнивание текста по центру */
      min-width: 110px; /* Минимальная ширина для единообразия */
      vertical-align: top; /* Выравнивание тегов по верху, если они разной высоты */
    }

    /* Убираем лишние стили для иконки внутри тега */
    .service-tag i {
       /* font-size: 14px; */ /* Удалено */
       margin-bottom: 0; /* Удалено */
       margin-right: 0; /* Удалено */
    }

    /* Стили для первой строки (иконка + название) */
    .service-tag-line1 {
        display: flex;        /* Иконка и текст в строку */
        align-items: center;  /* Выравнивание по вертикали */
        justify-content: center; /* Выравнивание по горизонтали */
        margin-bottom: 4px;   /* Отступ снизу до цены */
        font-size: 14px;      /* Увеличено */
    }
    .service-tag-line1 i {
        font-size: 16px;    /* Размер иконки */
        margin-right: 6px;  /* Отступ иконки справа */
    }
    .service-tag-line1 span { /* Чтобы текст мог переноситься, если нужно */
        display: inline-block;
        font-weight: 600; /* Делаем название жирным */
    }

    /* Стили для строки с ценой */
    .service-tag-price {
      font-size: 13px; /* Увеличено */
      color: #6e6e73; /* Вторичный цвет текста Apple */
    }

    .service-tag:hover {
      background-color: #e5e5e5;
    }

    .service-tag.selected {
      background-color: #007aff;
      color: white;
      border-color: #007aff;
    }

    .service-tag.selected:hover {
      background-color: #0062cc;
    }

    .service-tag.selected .service-tag-price {
      /* color: rgba(255, 255, 255, 0.8); */ /* Делаем цену такой же, как основной текст */
      color: white;
    }

    .service-tag.selected i {
        color: white !important; /* Переопределяем цвет иконки на белый при выборе */
    }

    /* Стили для контейнера тегов */
    #servicesContainer {
      /* Общие стили для контейнера (десктоп + мобильные) */
      display: flex;       /* По умолчанию flex для рядов на десктопе */
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      max-height: 220px;  /* Ограничение высоты (примерно под 2 ряда) */
      overflow-y: auto;   /* Включаем вертикальный скролл */
      padding: 10px 5px; /* Отступы внутри блока скролла (верх/низ больше) */
      border: 1px solid #e5e5e5;
      border-radius: 14px;
      /* Стили для скроллбара (применяются ко всем) */
    }
    #servicesContainer::-webkit-scrollbar {
      width: 5px;
    }
    #servicesContainer::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.15);
        border-radius: 3px;
    }
    #servicesContainer::-webkit-scrollbar-track {
      background: transparent;
    }

    /* Стили для контейнера тегов на мобильных (переопределение) */
    @media (max-width: 768px) {
      #servicesContainer {
        display: block; /* Переключаем на блочный макет (1 колонка) */
        max-height: 350px; /* Можно сделать выше на мобильных */
        /* Остальные стили (border, padding, scrollbar) наследуются */
      }

      /* Кастомизация скроллбара для мобильного контейнера (уже есть общие) */
      /* #servicesContainer::-webkit-scrollbar { ... } */

      .service-tag {
        display: block; /* Каждый тег на новой строке */
        width: 100%;    /* На всю ширину контейнера */
        min-width: 0;   /* Сбрасываем минимальную ширину */
        margin-bottom: 8px; /* Отступ между тегами */
        text-align: center; /* Выравнивание остается по центру */
      }
      .service-tag:last-child {
        margin-bottom: 0; /* Убираем отступ у последнего тега */
      }

      /* Убедимся, что цена тоже центрируется */
      .service-tag-price {
          text-align: center;
      }

      /* Центрируем навигацию клиента на мобильных */
      #client-month-nav {
          justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Форма входа -->
  <div id="authContainer" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 hidden" onclick="event.target === this && this.classList.add('hidden')">
    <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-8 relative" onclick="event.stopPropagation()">
    <button id="closeAuthBtn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-3xl font-thin leading-none focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full w-10 h-10 flex items-center justify-center" aria-label="Закрыть модальное окно">&times;</button>
    <h3 class="text-2xl font-semibold mb-6 text-center">Доступ для администратора</h3>
    <form id="loginForm" class="space-y-4">
      <div>
        <label for="loginEmail" class="block mb-2 font-medium">Email</label>
        <input type="email" id="loginEmail" required class="w-full rounded-3xl border border-gray-300 px-4 py-3">
      </div>
      <div>
        <label for="loginPassword" class="block mb-2 font-medium">Пароль</label>
        <input type="password" id="loginPassword" required class="w-full rounded-3xl border border-gray-300 px-4 py-3">
      </div>
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-3xl">
        Войти
      </button>
    </form>
  </div>
</div>

  <!-- Основной интерфейс -->
  <header class="bg-white shadow-md sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-6 py-5 flex flex-col md:flex-row md:items-center md:justify-between">
      <h1 class="text-3xl font-semibold tracking-tight text-gray-900 select-none" style="font-weight: 600;">VR Lounge - Управление</h1>
      <div class="flex items-center space-x-4 mt-2 md:mt-0">
        <p class="text-gray-500 text-sm select-none">Записи и Администраторы</p>
        <button id="logoutBtn" class="hidden text-sm text-blue-600 hover:text-blue-800">Выйти</button>
        <button id="loginBtn" class="text-sm text-blue-600 hover:text-blue-800">Вход для администратора</button>
      </div>
    </div>
  </header>

  <main class="flex-grow max-w-7xl mx-auto px-6 py-8 flex flex-col space-y-10">
    <!-- Календарь записи клиентов -->
    <section>
      <h2 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight">Календарь записи клиентов</h2>
      <div class="bg-white rounded-3xl shadow-lg max-w-4xl mx-auto p-8 border border-gray-200">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 space-y-5 md:space-y-0">
          <div id="client-month-nav" class="flex items-center space-x-3">
            <button id="prevMonth" aria-label="Предыдущий месяц" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
              <i class="fas fa-chevron-left text-lg"></i>
            </button>
            <h3 id="monthYear" class="text-xl font-semibold text-gray-900 tracking-tight select-none"></h3>
            <button id="nextMonth" aria-label="Следующий месяц" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
              <i class="fas fa-chevron-right text-lg"></i>
            </button>
          </div>
          <button id="addBookingBtn" class="hidden inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-semibold rounded-3xl px-5 py-3 shadow-md transition focus:ring-4 focus:ring-blue-300 focus:outline-none">
            <i class="fas fa-plus text-base"></i>
            <span>Добавить запись клиента</span>
          </button>
        </div>

        <div id="calendar" class="grid grid-cols-7 gap-1 text-center text-sm select-none user-select-none">
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Пн</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Вт</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Ср</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Чт</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Пт</div>
          <div class="font-semibold text-indigo-600 py-3 border-b border-gray-200">Сб</div>
          <div class="font-semibold text-indigo-600 py-3 border-b border-gray-200">Вс</div>
          <!-- Дни календаря будут добавлены сюда -->
        </div>
      </div>
    </section>

    <!-- График администраторов -->
    <section id="adminScheduleSection" class="hidden">
      <h2 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight">График администраторов</h2>
      <div class="bg-white rounded-3xl shadow-lg max-w-4xl mx-auto p-8 border border-gray-200">
        <div class="flex justify-between mb-6">
          <button id="prevMonthAdmins" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-chevron-left text-lg"></i>
          </button>
          <h3 id="currentMonthAdmins" class="text-xl font-semibold text-gray-900 tracking-tight select-none"></h3>
          <button id="nextMonthAdmins" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-chevron-right text-lg"></i>
          </button>
        </div>
        <div id="adminsCalendar" class="grid grid-cols-7 gap-1 text-center text-sm select-none">
          <!-- Дни недели -->
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Пн</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Вт</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Ср</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Чт</div>
          <div class="font-semibold text-gray-500 py-3 border-b border-gray-200">Пт</div>
          <div class="font-semibold text-indigo-600 py-3 border-b border-gray-200">Сб</div>
          <div class="font-semibold text-indigo-600 py-3 border-b border-gray-200">Вс</div>
          <!-- Календарь админов будет добавлен сюда -->
        </div>
      </div>
    </section>

    <!-- Список записей клиентов -->
    <section>
      <div class="flex items-center justify-center space-x-4 mb-6">
        <button id="prevMonthBookings" aria-label="Предыдущий месяц записей" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
          <i class="fas fa-chevron-left text-lg"></i>
        </button>
        <h2 id="bookingsListTitle" class="text-2xl font-semibold text-center text-gray-900 tracking-tight">Список записей клиентов</h2>
        <button id="nextMonthBookings" aria-label="Следующий месяц записей" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
          <i class="fas fa-chevron-right text-lg"></i>
        </button>
      </div>
      <div class="bg-white rounded-3xl shadow-lg max-w-4xl mx-auto p-8 border border-gray-200 min-h-[200px]">
        <ul id="bookingsList" class="space-y-4 max-h-[400px] overflow-y-auto text-gray-900 text-base leading-relaxed bookings-list">
          <!-- Записи клиентов будут добавлены сюда -->
        </ul>
        <p id="noBookingsText" class="text-center text-gray-500 italic select-none">Нет записей на выбранный месяц</p>
      </div>
    </section>

    <!-- Расчет зарплаты -->
    <section id="salarySection" class="hidden">
      <h2 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight">Финансы и Расчет зарплаты</h2>
      <div class="bg-white rounded-3xl shadow-lg max-w-4xl mx-auto p-8 border border-gray-200">
        <!-- Навигация по месяцам (остается для месячного отчета) -->
        <div class="flex justify-between mb-6">
          <button id="prevMonthSalary" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-chevron-left text-lg"></i>
          </button>
          <h3 id="currentMonthSalary" class="text-xl font-semibold text-gray-900 tracking-tight select-none"></h3>
          <button id="nextMonthSalary" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 transition text-gray-700 focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <i class="fas fa-chevron-right text-lg"></i>
          </button>
        </div>

        <!-- СТАТИСТИКА ВЫРУЧКИ -->
        <div class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-green-50 border border-green-200 rounded-2xl p-4 text-center">
            <p class="text-sm font-medium text-green-700">Выручка сегодня</p>
            <p id="revenueToday" class="text-xl font-bold text-green-600 mt-1">0 ₽</p>
          </div>
          <div class="bg-green-50 border border-green-200 rounded-2xl p-4 text-center">
            <p class="text-sm font-medium text-green-700">Выручка за неделю</p>
            <p id="revenueCurrentWeek" class="text-xl font-bold text-green-600 mt-1">0 ₽</p>
          </div>
          <div class="bg-green-50 border border-green-200 rounded-2xl p-4 text-center">
            <p class="text-sm font-medium text-green-700">Выручка за месяц</p>
            <p id="revenueSelectedMonth" class="text-xl font-bold text-green-600 mt-1">0 ₽</p>
          </div>
        </div>
        <!-- КОНЕЦ СТАТИСТИКИ ВЫРУЧКИ -->


        <!-- ЕЖЕНЕДЕЛЬНЫЙ РАСЧЕТ К ВЫПЛАТЕ -->
        <div class="mb-8 p-6 bg-yellow-50 border border-yellow-200 rounded-2xl">
            <h4 class="font-semibold text-base mb-3 text-yellow-900">К выплате в этот понедельник (за прошлую неделю):</h4>
            <p id="weeklyPayrollPeriod" class="text-xs text-yellow-700 mb-3"></p>
            <div id="weeklyPayrollResults" class="space-y-2 text-sm">
                <p class="italic text-yellow-600">Расчет...</p>
                <!-- Результаты еженедельной ЗП -->
            </div>
        </div>
        <!-- КОНЕЦ ЕЖЕНЕДЕЛЬНОГО РАСЧЕТА -->


        <!-- ИНФОРМАЦИОННЫЙ БЛОК -->
        <div class="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-2xl text-sm text-blue-800">
          <h4 class="font-semibold text-base mb-3 text-blue-900">Условия начисления зарплаты (для месячного отчета):</h4>
          <ul class="list-disc list-inside space-y-1.5">
            <li>Фиксированная ставка <strong>500₽</strong> за смену для основного администратора.</li>
            <li>Бонус <strong>15%</strong> от выручки за смену (или <strong>8%</strong>, если на смене был помощник).</li>
            <li>Помощнику начисляется <strong>150₽/час</strong> + бонус <strong>7%</strong> от выручки за смену.</li>
            <li>Расчет и выдача зарплаты производятся по понедельникам.</li>
          </ul>
        </div>
        <!-- КОНЕЦ ИНФОРМАЦИОННОГО БЛОКА -->

        <!-- МЕСЯЧНЫЙ ОТЧЕТ ПО ЗАРПЛАТЕ -->
        <h4 class="text-lg font-semibold mb-4 text-gray-700 text-center">Месячный отчет по зарплате</h4>
        <div id="salaryResults" class="space-y-6">
          <!-- Результаты расчета зарплаты будут добавлены сюда -->
        </div>
         <!-- КОНЕЦ МЕСЯЧНОГО ОТЧЕТА -->
      </div>
    </section>

    <!-- Стоимость услуг -->
    <section class="mb-12">
      <h2 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight">Стоимость услуг</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-7xl mx-auto">
        <div class="bg-white rounded-3xl shadow-lg p-8 border border-gray-200">
          <h3 class="text-xl font-semibold mb-5 border-b border-gray-200 pb-3 text-gray-900 tracking-tight">Будние дни</h3>
          <ul class="space-y-4 text-gray-700 text-base leading-relaxed">
            <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-indigo-600 text-lg flex-shrink-0"></i>
              <span>PS5 (1 джойстик) — 150 ₽/час</span>
            </li>
            <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-indigo-600 text-lg flex-shrink-0"></i>
              <span>PS5 (2 джойстика) — 300 ₽/час</span>
            </li>
            <li class="flex items-center space-x-3">
              <i class="fas fa-vr-cardboard text-blue-600 text-lg flex-shrink-0"></i>
              <span>VR очки (1 шт.) — 500 ₽/час</span>
            </li>
            <li class="flex items-center space-x-3">
              <i class="fas fa-vr-cardboard text-blue-600 text-lg flex-shrink-0"></i>
              <span>VR очки (2 шт.) — 1000 ₽/час</span>
            </li>
             <li class="flex items-center space-x-3">
              <i class="fas fa-vr-cardboard text-blue-600 text-lg flex-shrink-0"></i>
              <span>VR очки (3 шт.) — 1500 ₽/час</span>
            </li>
             <li class="flex items-center space-x-3">
              <i class="fas fa-vr-cardboard text-blue-600 text-lg flex-shrink-0"></i>
              <span>VR очки (4 шт.) — 2000 ₽/час</span>
            </li>
            <li class="flex items-center space-x-3">
              <i class="fas fa-child text-orange-600 text-lg flex-shrink-0"></i>
              <span>X-Box Kinnect (до 8 чел.) — 500 ₽/час</span>
            </li>
            <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-green-600 text-lg flex-shrink-0"></i>
              <span>X-Box (1 джойстик) — 250 ₽/час</span>
            </li>
             <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-green-600 text-lg flex-shrink-0"></i>
              <span>X-Box (2 джойстика) — 500 ₽/час</span>
            </li>
             <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-green-600 text-lg flex-shrink-0"></i>
              <span>X-Box (3 джойстика) — 750 ₽/час</span>
            </li>
             <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-green-600 text-lg flex-shrink-0"></i>
              <span>X-Box (4 джойстика) — 1000 ₽/час</span>
            </li>
            <li class="flex items-center space-x-3">
              <i class="fas fa-microphone text-pink-600 text-lg flex-shrink-0"></i>
              <span>Караоке — 1000 ₽/час</span>
            </li>
             <li class="flex items-center space-x-3">
              <i class="fas fa-dice-d6 text-purple-600 text-lg flex-shrink-0"></i>
              <span>Настольные игры — 500 ₽/час</span>
            </li>
          </ul>
        </div>
        <div class="bg-white rounded-3xl shadow-lg p-8 border border-gray-200">
          <h3 class="text-xl font-semibold mb-5 border-b border-gray-200 pb-3 text-gray-900 tracking-tight">Выходные дни</h3>
          <ul class="space-y-4 text-gray-700 text-base leading-relaxed">
            <li class="flex items-center space-x-3">
              <i class="fas fa-vr-cardboard text-blue-600 text-lg flex-shrink-0"></i>
              <span>VR очки (1 шт.) — 750 ₽/час</span>
            </li>
            <li class="flex items-center space-x-3">
              <i class="fas fa-vr-cardboard text-blue-600 text-lg flex-shrink-0"></i>
              <span>VR очки (2 шт.) — 1500 ₽/час</span>
            </li>
             <li class="flex items-center space-x-3">
              <i class="fas fa-vr-cardboard text-blue-600 text-lg flex-shrink-0"></i>
              <span>VR очки (3 шт.) — 2250 ₽/час</span>
            </li>
             <li class="flex items-center space-x-3">
              <i class="fas fa-vr-cardboard text-blue-600 text-lg flex-shrink-0"></i>
              <span>VR очки (4 шт.) — 3000 ₽/час</span>
            </li>
            <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-indigo-600 text-lg flex-shrink-0"></i>
               <span>PS5 (1 джойстик) — 150 ₽/час</span>
            </li>
            <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-indigo-600 text-lg flex-shrink-0"></i>
              <span>PS5 (2 джойстика) — 300 ₽/час</span>
            </li>
             <li class="flex items-center space-x-3">
              <i class="fas fa-child text-orange-600 text-lg flex-shrink-0"></i>
              <span>X-Box Kinnect (до 8 чел.) — 500 ₽/час</span>
            </li>
            <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-green-600 text-lg flex-shrink-0"></i>
              <span>X-Box (1 джойстик) — 250 ₽/час</span>
            </li>
             <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-green-600 text-lg flex-shrink-0"></i>
              <span>X-Box (2 джойстика) — 500 ₽/час</span>
            </li>
             <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-green-600 text-lg flex-shrink-0"></i>
              <span>X-Box (3 джойстика) — 750 ₽/час</span>
            </li>
             <li class="flex items-center space-x-3">
              <i class="fas fa-gamepad text-green-600 text-lg flex-shrink-0"></i>
              <span>X-Box (4 джойстика) — 1000 ₽/час</span>
            </li>
            <li class="flex items-center space-x-3">
              <i class="fas fa-microphone text-pink-600 text-lg flex-shrink-0"></i>
              <span>Караоке — 1000 ₽/час</span>
            </li>
             <li class="flex items-center space-x-3">
              <i class="fas fa-dice-d6 text-purple-600 text-lg flex-shrink-0"></i>
              <span>Настольные игры — 500 ₽/час</span>
            </li>
          </ul>
        </div>
        <div class="bg-white rounded-3xl shadow-lg p-8 border border-gray-200">
          <h3 class="text-xl font-semibold mb-5 border-b border-gray-200 pb-3 text-gray-900 tracking-tight flex items-center">
             <i class="fas fa-birthday-cake text-red-600 text-lg mr-2 flex-shrink-0"></i>
             <span>Аренда всего (День Рождения)</span>
           </h3>
          <ul class="space-y-3 text-gray-700 text-base leading-relaxed">
            <li>Первый час — 4000 руб.</li>
            <li>Второй час — 3500 руб.</li>
            <li>Третий час — 3000 руб.</li>
            <li>Четвертый и далее — 3000 руб./час</li>
          </ul>
          <p class="mt-5 font-semibold text-gray-900 tracking-tight">В стоимость входит аренда всего помещения:</p>
          <ul class="list-disc list-inside text-gray-700 space-y-1 mt-2 text-base leading-relaxed">
            <li>VR очки</li>
            <li>PS комната</li>
            <li>Караоке</li>
            <li>Кино</li>
            <li>XBOX 360</li>
            <li>Танцы в XBOX</li>
            <li>Игры на ПК</li>
          </ul>
          <p class="mt-4 text-gray-500 italic text-sm">Можно заказать свою еду и напитки</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Модальное окно бронирования клиента -->
  <div id="bookingModal" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center p-6 hidden z-50">
    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-8 relative ring-1 ring-gray-200">
      <button id="closeModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-3xl font-thin leading-none focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full w-10 h-10 flex items-center justify-center" aria-label="Закрыть модальное окно">&times;</button>
      <h3 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight" id="modalTitle">Добавить запись клиента</h3>
      <form id="bookingForm" class="space-y-6">
        <input type="hidden" id="bookingId" name="bookingId" />
        <div>
          <label for="clientName" class="block text-gray-900 font-semibold mb-2">Имя клиента</label>
          <input type="text" id="clientName" name="clientName" required autocomplete="off" class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Введите имя клиента" />
        </div>
        <div>
          <label for="clientPhone" class="block text-gray-900 font-semibold mb-2">Номер телефона</label>
          <input type="tel" id="clientPhone" name="clientPhone" required autocomplete="off" class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="+7 (XXX) XXX-XX-XX" />
        </div>
        <div>
          <label for="bookingDate" class="block text-gray-900 font-semibold mb-2">Дата</label>
          <input type="date" id="bookingDate" name="bookingDate" required class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" />
        </div>
        <div>
          <label for="startTime" class="block text-gray-900 font-semibold mb-2">Время начала</label>
          <input type="time" id="startTime" name="startTime" required class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" />
        </div>
        <div>
          <label for="duration" class="block text-gray-900 font-semibold mb-2">Длительность (часы)</label>
          <select id="duration" name="duration" required class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            <option value="0.5">0.5</option>
            <option value="1" selected>1</option>
            <option value="1.5">1.5</option>
            <option value="2">2</option>
            <option value="2.5">2.5</option>
            <option value="3">3</option>
            <option value="3.5">3.5</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
          </select>
        </div>

        <!-- Услуги -->
        <div>
          <label class="block text-gray-900 font-semibold mb-2">Услуги</label>
          <div id="servicesContainer" class="flex flex-wrap gap-3">
            <button type="button" class="service-tag" data-service="weekday_ps1" data-price="150">
              <div class="service-tag-line1"><i class="fas fa-gamepad text-indigo-600"></i> <span>PS5 (1 джойстик)</span></div>
              <div class="service-tag-price">150 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="weekday_ps2" data-price="300">
              <div class="service-tag-line1"><i class="fas fa-gamepad text-indigo-600"></i> <span>PS5 (2 джойстика)</span></div>
              <div class="service-tag-price">300 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="weekday_vr1" data-price="500">
               <div class="service-tag-line1"><i class="fas fa-vr-cardboard text-blue-600"></i> <span>VR очки (1 шт.) | Будни</span></div>
               <div class="service-tag-price">500 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="weekday_vr2" data-price="1000">
               <div class="service-tag-line1"><i class="fas fa-vr-cardboard text-blue-600"></i> <span>VR очки (2 шт.) | Будни</span></div>
               <div class="service-tag-price">1000 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="weekday_vr3" data-price="1500">
               <div class="service-tag-line1"><i class="fas fa-vr-cardboard text-blue-600"></i> <span>VR очки (3 шт.) | Будни</span></div>
               <div class="service-tag-price">1500 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="weekday_vr4" data-price="2000">
               <div class="service-tag-line1"><i class="fas fa-vr-cardboard text-blue-600"></i> <span>VR очки (4 шт.) | Будни</span></div>
               <div class="service-tag-price">2000 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="weekend_vr1" data-price="750">
               <div class="service-tag-line1"><i class="fas fa-vr-cardboard text-blue-600"></i> <span>VR очки (1 шт.) | Выходные</span></div>
               <div class="service-tag-price">750 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="weekend_vr2" data-price="1500">
               <div class="service-tag-line1"><i class="fas fa-vr-cardboard text-blue-600"></i> <span>VR очки (2 шт.) | Выходные</span></div>
               <div class="service-tag-price">1500 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="weekend_vr3" data-price="2250">
               <div class="service-tag-line1"><i class="fas fa-vr-cardboard text-blue-600"></i> <span>VR очки (3 шт.) | Выходные</span></div>
               <div class="service-tag-price">2250 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="weekend_vr4" data-price="3000">
               <div class="service-tag-line1"><i class="fas fa-vr-cardboard text-blue-600"></i> <span>VR очки (4 шт.) | Выходные</span></div>
               <div class="service-tag-price">3000 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="xbox_kinnect" data-price="500">
               <div class="service-tag-line1"><i class="fas fa-child text-orange-600"></i> <span>X-Box Kinnect (до 8 чел.)</span></div>
               <div class="service-tag-price">500 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="xbox1" data-price="250">
               <div class="service-tag-line1"><i class="fas fa-gamepad text-green-600"></i> <span>X-Box (1 джойстик)</span></div>
               <div class="service-tag-price">250 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="xbox2" data-price="500">
               <div class="service-tag-line1"><i class="fas fa-gamepad text-green-600"></i> <span>X-Box (2 джойстика)</span></div>
               <div class="service-tag-price">500 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="xbox3" data-price="750">
               <div class="service-tag-line1"><i class="fas fa-gamepad text-green-600"></i> <span>X-Box (3 джойстика)</span></div>
               <div class="service-tag-price">750 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="xbox4" data-price="1000">
               <div class="service-tag-line1"><i class="fas fa-gamepad text-green-600"></i> <span>X-Box (4 джойстика)</span></div>
               <div class="service-tag-price">1000 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="karaoke" data-price="1000">
               <div class="service-tag-line1"><i class="fas fa-microphone text-pink-600"></i> <span>Караоке</span></div>
               <div class="service-tag-price">1000 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="board_games" data-price="500">
               <div class="service-tag-line1"><i class="fas fa-dice-d6 text-purple-600"></i> <span>Настольные игры</span></div>
               <div class="service-tag-price">500 ₽/час</div>
            </button>
            <button type="button" class="service-tag" data-service="birthday" data-price="4000">
               <div class="service-tag-line1"><i class="fas fa-birthday-cake text-red-600"></i> <span>Аренда всего (День Рождения)</span></div>
               <div class="service-tag-price">от 3000 ₽/час</div> <!-- Цена для ДР динамическая -->
            </button>
        </div>
          <input type="hidden" id="selectedServices" name="selectedServices">
        </div>

        <!-- Сумма (было в grid) -->
        <div>
            <label class="block text-gray-900 font-semibold mb-2">Сумма</label>
            <div class="flex items-center">
              <input type="text" id="totalAmount" readonly class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 bg-gray-50" value="0 ₽">
            </div>
        </div>
        
        <!-- Скидка (было в grid) -->
        <div>
            <label class="block text-gray-900 font-semibold mb-2">Скидка</label>
            <div class="flex items-center space-x-2">
              <input type="number" id="discountPercent" min="0" max="100" class="w-1/2 rounded-3xl border border-gray-300 px-5 py-3 text-gray-900" placeholder="%">
              <span class="text-gray-500">или</span>
              <input type="number" id="discountAmount" min="0" class="w-1/2 rounded-3xl border border-gray-300 px-5 py-3 text-gray-900" placeholder="₽">
            </div>
        </div>

        <!-- Итоговая стоимость (остается ниже) -->
        <div>
          <label class="block text-gray-900 font-semibold mb-2">Итоговая стоимость</label>
          <div class="flex items-center">
            <input type="text" id="finalAmount" readonly class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 bg-gray-50 font-semibold" value="0 ₽">
          </div>
        </div>

        <div>
          <label for="notes" class="block text-gray-900 font-semibold mb-2">Примечания</label>
          <textarea id="notes" name="notes" rows="3" placeholder="Введите дополнительные сведения" class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none transition resize-none"></textarea>
        </div>
        <div class="flex space-x-4">
          <button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white py-3 rounded-3xl font-semibold transition focus:ring-4 focus:ring-blue-300 focus:outline-none">Сохранить запись</button>
          <button type="button" id="deleteBookingBtn" class="hidden flex-grow bg-red-600 hover:bg-red-700 active:bg-red-800 text-white py-3 rounded-3xl font-semibold transition focus:ring-4 focus:ring-red-300 focus:outline-none">Удалить запись</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Модальное окно для назначения администратора -->
  <div id="assignAdminModal" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center p-6 hidden z-50" onclick="event.target === this && this.classList.add('hidden')">
    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-8 relative ring-1 ring-gray-200" onclick="event.stopPropagation()">
      <button id="closeAssignModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-3xl font-thin leading-none focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full w-10 h-10 flex items-center justify-center" aria-label="Закрыть модальное окно">&times;</button>
      <h3 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight" id="assignModalTitle">Назначить администратора</h3>
      <form id="assignAdminForm" class="space-y-6">
        <input type="hidden" id="assignDate" name="assignDate">
        <div>
          <label class="block text-gray-900 font-semibold mb-2">Основной администратор</label>
          <select id="mainAdmin" name="mainAdmin" required class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            <option value="">Выберите администратора</option>
            <!-- Опции будут заполнены динамически -->
          </select>
        </div>
        <div id="helperAdminSection" class="space-y-4"> <!-- Убран 'hidden' по умолчанию, т.к. теперь логика показа в JS -->
          <label class="block text-gray-900 font-semibold mb-2">Помощник администратора</label>
          <select id="helperAdmin" name="helperAdmin" class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            <option value="">Нет помощника</option>
            <!-- Опции будут заполнены динамически -->
          </select>
          <div id="helperHoursSection" class="hidden"> <!-- Секция часов скрыта, пока не выбран помощник -->
            <label class="block text-gray-900 font-semibold mb-2">Часы работы помощника</label>
            <input type="number" id="helperHours" name="helperHours" min="1" max="24" class="w-full rounded-3xl border border-gray-300 px-5 py-3 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Количество часов">
          </div>
        </div>
        <div class="flex space-x-4">
          <button type="submit" class="flex-grow bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white py-3 rounded-3xl font-semibold transition focus:ring-4 focus:ring-blue-300 focus:outline-none">Сохранить назначение</button>
          <button type="button" id="deleteAssignmentBtn" class="hidden flex-grow bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white py-3 rounded-3xl font-semibold transition focus:ring-4 focus:ring-gray-300 focus:outline-none">Удалить назначение</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Модальное окно с деталями записей за день -->
  <div id="dayDetailsModal" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center p-6 hidden z-50" onclick="event.target === this && this.classList.add('hidden')">
    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-8 relative ring-1 ring-gray-200" onclick="event.stopPropagation()">
      <button id="closeDayDetailsModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-3xl font-thin leading-none focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full w-10 h-10 flex items-center justify-center" aria-label="Закрыть модальное окно">&times;</button>
      <h3 class="text-2xl font-semibold mb-6 text-center text-gray-900 tracking-tight" id="dayDetailsTitle">Записи на день</h3>
      <div id="dayDetailsContent" class="space-y-4">
        <!-- Детали бронирований будут добавлены сюда -->
      </div>
    </div>
  </div>


  <!-- Firebase и основная логика приложения -->
  <script type="module">
    // Инициализация Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, onSnapshot, 
      deleteDoc, doc, updateDoc, query, where, getDoc, setDoc // Добавлен setDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { 
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Ваша конфигурация Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBaq_faWwfE_TXn4Xh_2U3GYSAsUzGJ1bk",
      authDomain: "vr-lounge33.firebaseapp.com",
      projectId: "vr-lounge33",
      storageBucket: "vr-lounge33.appspot.com",
      messagingSenderId: "825655988090",
      appId: "1:825655988090:web:76d8e0554b8601f8bd10c3"
    };

    // Инициализация Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // === Элементы интерфейса ===
    // --- Общие ---
    const authContainer = document.getElementById('authContainer');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginBtn = document.getElementById('loginBtn');
    const closeAuthBtn = document.getElementById('closeAuthBtn');

    // --- Календарь клиентов ---
    const calendarEl = document.getElementById('calendar');
    const monthYearEl = document.getElementById('monthYear');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const addBookingBtn = document.getElementById('addBookingBtn');

    // --- Список записей клиентов ---
    const bookingsListEl = document.getElementById('bookingsList');
    const noBookingsText = document.getElementById('noBookingsText');
    const bookingsListTitle = document.getElementById('bookingsListTitle');
    const prevMonthBookingsBtn = document.getElementById('prevMonthBookings');
    const nextMonthBookingsBtn = document.getElementById('nextMonthBookings');

    // --- Модальное окно бронирования клиента ---
    const bookingModal = document.getElementById('bookingModal');
    const closeModalBtn = document.getElementById('closeModal');
    const bookingForm = document.getElementById('bookingForm');
    const modalTitle = document.getElementById('modalTitle');
    const bookingIdInput = document.getElementById('bookingId');
    const deleteBookingBtn = document.getElementById('deleteBookingBtn');
    const clientPhoneInput = document.getElementById('clientPhone');

    // --- График администраторов ---
    const adminScheduleSection = document.getElementById('adminScheduleSection'); // Секция графика
    const adminsCalendar = document.getElementById('adminsCalendar');
    const currentMonthAdmins = document.getElementById('currentMonthAdmins');
    const prevMonthAdminsBtn = document.getElementById('prevMonthAdmins');
    const nextMonthAdminsBtn = document.getElementById('nextMonthAdmins');

    // --- Модальное окно назначения администратора ---
    const assignAdminModal = document.getElementById('assignAdminModal');
    const assignAdminForm = document.getElementById('assignAdminForm');
    const assignModalTitle = document.getElementById('assignModalTitle');
    const assignDateInput = document.getElementById('assignDate');
    const mainAdminSelect = document.getElementById('mainAdmin');
    const helperAdminSelect = document.getElementById('helperAdmin');
    const helperAdminSection = document.getElementById('helperAdminSection'); // Контейнер для помощника
    const helperHoursSection = document.getElementById('helperHoursSection'); // Контейнер для часов помощника
    const helperHoursInput = document.getElementById('helperHours');
    const closeAssignModal = document.getElementById('closeAssignModal');
    const deleteAssignmentBtn = document.getElementById('deleteAssignmentBtn'); // Кнопка удаления назначения

    // --- Модальное окно деталей дня ---
    const dayDetailsModal = document.getElementById('dayDetailsModal');
    const dayDetailsTitle = document.getElementById('dayDetailsTitle');
    const dayDetailsContent = document.getElementById('dayDetailsContent');
    const closeDayDetailsModalBtn = document.getElementById('closeDayDetailsModal');

    // --- Расчет зарплаты ---
    const salarySection = document.getElementById('salarySection'); // Секция ЗП
    const salaryResults = document.getElementById('salaryResults');
    const currentMonthSalary = document.getElementById('currentMonthSalary');
    const prevMonthSalaryBtn = document.getElementById('prevMonthSalary');
    const nextMonthSalaryBtn = document.getElementById('nextMonthSalary');

    // --- Статистика Выручки ---
    const revenueTodayEl = document.getElementById('revenueToday');
    const revenueCurrentWeekEl = document.getElementById('revenueCurrentWeek');
    const revenueSelectedMonthEl = document.getElementById('revenueSelectedMonth');
    // --- Еженедельная ЗП ---
    const weeklyPayrollPeriodEl = document.getElementById('weeklyPayrollPeriod');
    const weeklyPayrollResultsEl = document.getElementById('weeklyPayrollResults');

    // === Состояние приложения ===
    let currentDate = new Date(); // Для календаря клиентов
    currentDate.setDate(1);
    let selectedDate = null; // Выбранная дата в календаре клиентов
    let bookings = [];
    let isAdmin = false;
    let bookingsViewMonth = new Date(); // Для списка записей клиентов
    bookingsViewMonth.setDate(1);
    let adminsViewMonth = new Date(); // Для графика администраторов
    adminsViewMonth.setDate(1);
    let salaryViewMonth = new Date(); // Для расчета зарплат
    salaryViewMonth.setDate(1);
    let admins = []; // Список администраторов
    let adminAssignments = []; // Список назначений
    let selectedServices = new Set(); // Множество выбранных услуг

    // Переменные для хранения функций отписки от слушателей Firestore
    let unsubscribeBookings = null;
    let unsubscribeAdmins = null;
    let unsubscribeAdminAssignments = null;

    // === Цены услуг ===
    const servicePrices = {
        // PS5
        weekday_ps1: 150, // Будни PS 1 джойстик
        weekday_ps2: 300, // Будни PS 2 джойстика
        // VR очки будни
        weekday_vr1: 500, // Будни VR 1 очки
        weekday_vr2: 1000, // Будни VR 2 очки
        weekday_vr3: 1500, // Будни VR 3 очки
        weekday_vr4: 2000, // Будни VR 4 очки
        // VR очки выходные
        weekend_vr1: 750, // Выходные VR 1 очки
        weekend_vr2: 1500, // Выходные VR 2 очки
        weekend_vr3: 2250, // Выходные VR 3 очки
        weekend_vr4: 3000, // Выходные VR 4 очки
        // X-Box
        xbox_kinnect: 500, // X-Box Kinnect
        xbox1: 250, // X-Box 1 джойстик
        xbox2: 500, // X-Box 2 джойстика
        xbox3: 750, // X-Box 3 джойстика
        xbox4: 1000, // X-Box 4 джойстика
        // Другие услуги
        karaoke: 1000, // Караоке
        board_games: 500, // Настольные игры
        // День рождения
        birthday: {
            1: 4000, 2: 3500, 3: 3000, 4: 3000, 5: 3000,
            6: 3000, 7: 3000, 8: 3000, 9: 3000, 10: 3000,
            11: 3000, 12: 3000
        }
    };
    const servicePriceHalfHour = { // Цены за полчаса
        weekday_vr: 250,
        weekend_vr: 350,
    }

    // === Вспомогательные функции ===
    function isWeekend(date) {
      const day = date.getDay();
      return day === 0 || day === 6; // 0 = Воскресенье, 6 = Суббота
    }

    // БЕЗОПАСНАЯ функция форматирования даты в 'YYYY-MM-DD' без учета часовых поясов
    function formatDateSafe(date) {
      const year = date.getFullYear();
      // getMonth() возвращает 0-11, добавляем 1 и дополняем нулем если нужно
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      // getDate() возвращает 1-31, дополняем нулем если нужно
      const day = date.getDate().toString().padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Улучшенная маска и обработчики для телефона
    const phonePlaceholder = '+7 (';

    clientPhoneInput.addEventListener('input', function(e) {
        const input = e.target;
        const value = input.value;
        // Сохраняем текущую позицию курсора ДО изменения
        const initialCursorPos = input.selectionStart;
        const initialValueLength = value.length;

        // 1. Удаляем все НЕцифры
        let digits = value.replace(/\D/g, '');

        // 2. Обрабатываем код страны (оставляем только 10 цифр после 7)
        if (digits.startsWith('7') || digits.startsWith('8')) {
            digits = digits.substring(1);
        }
        digits = digits.substring(0, 10); // Ограничиваем 10 цифрами

        // 3. Применяем маску
        let formattedValue = '+7 (';
        if (digits.length > 0) {
            formattedValue += digits.substring(0, 3);
        }
        if (digits.length >= 4) {
            formattedValue += ') ' + digits.substring(3, 6);
        }
        if (digits.length >= 7) {
            formattedValue += '-' + digits.substring(6, 8);
        }
        if (digits.length >= 9) {
            formattedValue += '-' + digits.substring(8, 10);
        }
        
        // 4. Устанавливаем отформатированное значение
        input.value = formattedValue;
        
        // 5. Просто устанавливаем курсор в конец после форматирования
        // Это наиболее предсказуемое поведение для маски
        requestAnimationFrame(() => {
           const finalPos = input.value.length;
           input.setSelectionRange(finalPos, finalPos);
        });
    });

    clientPhoneInput.addEventListener('focus', function(e) {
        if (e.target.value === phonePlaceholder) {
            e.target.value = '';
        }
    });

    clientPhoneInput.addEventListener('blur', function(e) {
        if (e.target.value === '') {
            e.target.value = phonePlaceholder;
        }
    });

    // Получить дату понедельника и воскресенья для недели, содержащей date
    function getWeekRange(date) {
        const d = new Date(date);
        const dayOfWeek = d.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
        const diffToMonday = d.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust Sunday
        const monday = new Date(d.setDate(diffToMonday));
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        return {
            start: monday, // Понедельник
            end: sunday    // Воскресенье
        };
    }

    // Получить дату понедельника и воскресенья для ПРЕДЫДУЩЕЙ недели относительно date
    function getPreviousWeekRange(date) {
        const d = new Date(date);
        d.setDate(d.getDate() - 7); // Переходим на предыдущую неделю
        return getWeekRange(d);
    }

    // === Загрузка данных из Firebase ===
    function loadData() {
      console.log('loadData called. isAdmin:', isAdmin); // DEBUG

      // Отписываемся от предыдущего слушателя bookings, если он был
      if (unsubscribeBookings) {
        unsubscribeBookings();
        unsubscribeBookings = null;
        console.log('Unsubscribed from bookings'); // DEBUG
      }

      // Загрузка бронирований клиентов (слушатель активен всегда)
      unsubscribeBookings = onSnapshot(collection(db, "bookings"), (snapshot) => {
        console.log('Bookings snapshot received:', snapshot.docs.length); // DEBUG
      bookings = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
        renderCalendar(); // Обновляем календарь клиентов
        renderBookingsList(); // Обновляем список записей
        if (isAdmin) {
            calculateRevenueStats(); // Рассчитать и отобразить выручку
            calculateWeeklyPayroll(); // Рассчитать и отобразить ЗП за прошлую неделю
            calculateSalaries(); // Пересчитываем месячную ЗП
        }
      });

      // Загрузка администраторов (только для админа)
      if (isAdmin) {
          console.log('Attempting to load admins...'); // DEBUG
          // Отписываемся от предыдущего слушателя admins, если он был
          if (unsubscribeAdmins) {
             unsubscribeAdmins();
             unsubscribeAdmins = null;
             console.log('Unsubscribed from admins'); // DEBUG
          }
          unsubscribeAdmins = onSnapshot(collection(db, "admins"), (snapshot) => {
            console.log('Admins snapshot received:', snapshot.docs.length); // DEBUG
            admins = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            })).sort((a, b) => a.name.localeCompare(b.name)); // Сортировка по имени
             console.log('Admins loaded:', admins); // DEBUG
            updateAdminSelects(); // Обновляем списки в модалке
            renderAdminsCalendar(); // Обновляем календарь админов
            // Пересчитываем зарплаты, т.к. список админов мог обновиться
            calculateWeeklyPayroll();
            calculateSalaries();
          }, (error) => {
            console.error("Error loading admins:", error); // DEBUG
          });

          // Загрузка назначений администраторов (только для админа)
          console.log('Attempting to load adminAssignments...'); // DEBUG
           // Отписываемся от предыдущего слушателя adminAssignments, если он был
          if (unsubscribeAdminAssignments) {
             unsubscribeAdminAssignments();
             unsubscribeAdminAssignments = null;
             console.log('Unsubscribed from adminAssignments'); // DEBUG
          }
          unsubscribeAdminAssignments = onSnapshot(collection(db, "adminAssignments"), (snapshot) => {
            console.log('AdminAssignments snapshot received:', snapshot.docs.length); // DEBUG
            adminAssignments = snapshot.docs.map(doc => ({
              id: doc.id, // Используем дату как ID
        ...doc.data()
      }));
            renderAdminsCalendar(); // Обновляем календарь админов
             // Пересчитываем зарплаты, т.к. назначения могли обновиться
            calculateWeeklyPayroll();
            calculateSalaries();
          }, (error) => {
             console.error("Error loading adminAssignments:", error); // DEBUG
             // Если ошибка прав доступа при загрузке, отписываемся, чтобы не повторялась
             if (error.code === 'permission-denied' && unsubscribeAdminAssignments) {
                 unsubscribeAdminAssignments();
                 unsubscribeAdminAssignments = null;
             }
          });
      } else {
          // Если не админ, убедимся, что отписались от админских данных
          if (unsubscribeAdmins) {
              unsubscribeAdmins();
              unsubscribeAdmins = null;
              console.log('Cleaned up admins listener'); // DEBUG
          }
          if (unsubscribeAdminAssignments) {
              unsubscribeAdminAssignments();
              unsubscribeAdminAssignments = null;
              console.log('Cleaned up adminAssignments listener'); // DEBUG
          }
          // Очищаем также новые поля
          renderRevenueStats(0, 0, 0); // Показать нули
          renderWeeklyPayroll({}, null); // Показать пустое состояние
      }
    }

    // === Логика Календаря Клиентов ===
    function renderCalendar() {
      // Очистка старых дней
      while (calendarEl.children.length > 7) {
        calendarEl.removeChild(calendarEl.lastChild);
      }

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      monthYearEl.textContent = currentDate.toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
      });

      const firstDayOfMonth = new Date(year, month, 1);
      let startDayOfWeek = firstDayOfMonth.getDay();
      startDayOfWeek = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;

      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // Пустые ячейки до начала месяца
      for (let i = 0; i < startDayOfWeek; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'border border-gray-200 bg-gray-50 h-24 rounded-3xl'; // Используем h-24 как в index.html
        calendarEl.appendChild(emptyCell);
      }

      // Ячейки дней месяца
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        // Используем безопасное форматирование
        const dateStr = formatDateSafe(date);

        const dayCell = document.createElement('div');
        dayCell.className = 'border border-gray-300 rounded-3xl h-24 p-3 flex flex-col justify-start cursor-pointer hover:bg-blue-50 transition relative select-text';

        if (isWeekend(date)) {
          dayCell.classList.add('bg-blue-50'); // Подсветка выходных
        }

        // Подсветка сегодняшнего дня
        const today = new Date();
        // Используем безопасное форматирование
        if (formatDateSafe(date) === formatDateSafe(today)) {
          dayCell.classList.add('ring-2', 'ring-blue-600');
        }

        // Подсветка выбранного дня
        // Используем безопасное форматирование
        if (selectedDate && formatDateSafe(date) === formatDateSafe(selectedDate)) {
          dayCell.classList.add('bg-blue-200', 'ring-4', 'ring-blue-500');
        }

        const dayNumber = document.createElement('div');
        dayNumber.textContent = day;
        dayNumber.className = 'font-semibold text-sm text-gray-900 mb-1 select-none';
        dayCell.appendChild(dayNumber);

        // Отображение бронирований на этот день
        // Сравнение идет со строкой dateStr, которая теперь формируется безопасно
        const dayBookings = bookings.filter(b => b.bookingDate === dateStr)
                                  .sort((a, b) => a.startTime.localeCompare(b.startTime)); // Сортировка по времени

        if (dayBookings.length > 0) {
          const bookingsList = document.createElement('ul');
          bookingsList.className = 'bookings-list mt-0.5 overflow-y-auto max-h-16 text-xs text-gray-800 space-y-0.5';

          dayBookings.forEach((b) => {
            const li = document.createElement('li');
            li.className = 'truncate rounded-2xl px-2 py-0.5';

            let bgColor = 'bg-gray-100 text-gray-700';
            if (b.serviceType === 'weekday_vr') bgColor = 'bg-blue-100 text-blue-800';
            else if (b.serviceType === 'weekday_ps') bgColor = 'bg-sky-100 text-sky-800'; // Изменен цвет для PS
            else if (b.serviceType === 'weekend_vr') bgColor = 'bg-indigo-100 text-indigo-800';
            else if (b.serviceType === 'weekend_ps') bgColor = 'bg-purple-100 text-purple-800'; // Изменен цвет для PS выходные
            else if (b.serviceType === 'birthday') bgColor = 'bg-pink-100 text-pink-800 font-semibold'; // Изменен цвет ДР

            li.classList.add(...bgColor.split(' '));
            li.textContent = `${b.startTime} (${b.duration}ч) - ${b.clientName}`;
            li.title = `${b.startTime} (${b.duration}ч) - ${b.clientName}\nУслуга: ${getServiceLabel(b.serviceType)}\nТел: ${b.clientPhone || '-'}\nПримечания: ${b.notes || '-'}`; // Всплывающая подсказка

            // Добавляем обработчик для редактирования по клику на запись (только для админа)
             if (isAdmin) {
                li.classList.add('cursor-pointer', 'hover:ring-1', 'hover:ring-black');
                li.addEventListener('click', (e) => {
                   e.stopPropagation(); // Предотвращаем срабатывание клика на ячейке дня
                   openEditModal(b.id);
                });
             }

            bookingsList.appendChild(li);
          });

          dayCell.appendChild(bookingsList);
        }

        // Обработчик клика на ячейку дня
        dayCell.addEventListener('click', () => {
          // Находим бронирования для этого дня
          const dayBookings = bookings.filter(b => b.bookingDate === dateStr)
                                    .sort((a, b) => a.startTime.localeCompare(b.startTime));

          if (dayBookings.length > 0) {
            // Если есть бронирования, показываем модальное окно с деталями
            showDayDetailsModal(dayBookings, date);
          } else {
            // Иначе, просто выделяем день (как раньше)
            // Можно добавить открытие окна добавления, если нужно
          selectedDate = date;
          renderCalendar();
          }
        });

        calendarEl.appendChild(dayCell);
      }
    }


    // === Логика Списка Записей Клиентов ===
    function renderBookingsList() {
        console.log('renderBookingsList called for month:', bookingsViewMonth.toLocaleDateString()); // DEBUG
      bookingsListEl.innerHTML = '';
      const year = bookingsViewMonth.getFullYear();
      const month = bookingsViewMonth.getMonth(); // 0-indexed (0 = January, 11 = December)
      // Формируем строку 'YYYY-MM' для сравнения
      const yearMonthStr = `${year}-${(month + 1).toString().padStart(2, '0')}`;
      console.log('Filtering bookings for year-month:', yearMonthStr); // DEBUG


      // Обновляем заголовок
      bookingsListTitle.textContent = `Список записей на ${bookingsViewMonth.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' })}`;

      // Фильтруем, сравнивая начало строки 'YYYY-MM-DD' с 'YYYY-MM'
      let filteredBookings = bookings.filter((b) => {
            // Убедимся, что b.bookingDate - это строка и имеет нужный формат
            return typeof b.bookingDate === 'string' && b.bookingDate.startsWith(yearMonthStr);
      });

      console.log('Filtered bookings for list:', filteredBookings.length, filteredBookings); // DEBUG

      if (filteredBookings.length === 0) {
            console.log('No bookings for list, showing placeholder.'); // DEBUG
        noBookingsText.classList.remove('hidden');
            bookingsListEl.classList.add('hidden'); // Скрываем сам список
        return;
      } else {
             console.log('Found bookings, hiding placeholder.'); // DEBUG
        noBookingsText.classList.add('hidden');
            bookingsListEl.classList.remove('hidden'); // Показываем список
      }

        // Сортировка по дате и времени
      filteredBookings.sort((a, b) => {
        const dateA = new Date(a.bookingDate + 'T' + a.startTime);
        const dateB = new Date(b.bookingDate + 'T' + b.startTime);
        return dateA - dateB;
      });

      filteredBookings.forEach((b) => {
        const li = document.createElement('li');
            li.className = 'border border-gray-200 rounded-xl p-4 shadow-sm flex flex-col md:flex-row md:items-start md:justify-between space-y-3 md:space-y-0 md:space-x-4 hover:bg-gray-50 transition'; // Улучшен стиль

        const dateObj = new Date(b.bookingDate);
            // Форматируем дату с добавлением дня недели
            const dateStr = dateObj.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short', year: 'numeric', weekday: 'short' });
            const timeStr = `${b.startTime} (${b.duration}ч)`;

            // Левая часть: Дата и время
            const dateTimeDiv = document.createElement('div');
            dateTimeDiv.className = 'flex-shrink-0 w-full md:w-40 text-gray-700'; // Ширина для выравнивания
            dateTimeDiv.innerHTML = `<div class="font-semibold">${dateStr}</div><div class="text-sm">${timeStr}</div>`;

            // Центральная часть: Имя и телефон
            const clientInfoDiv = document.createElement('div');
            clientInfoDiv.className = 'flex-grow text-gray-900';
            clientInfoDiv.innerHTML = `<div class="font-semibold text-base truncate" title="${b.clientName}">${b.clientName}</div>`;
        if (b.clientPhone) {
                 let cleanPhone = b.clientPhone.replace(/\D/g, '');
                 if (cleanPhone.startsWith('7') || cleanPhone.startsWith('8')) {
                    cleanPhone = cleanPhone.substring(1); // Убираем 7 или 8 в начале для ссылки
                 }
                 const formattedPhone = formatPhoneNumber(b.clientPhone); // Используем функцию форматирования
                clientInfoDiv.innerHTML += `<div class="text-sm mt-1"><a href="tel:+7${cleanPhone}" class="text-blue-600 hover:text-blue-800 hover:underline">${formattedPhone}</a></div>`;
            }

            // Правая часть: Услуга и примечания
            const serviceNotesDiv = document.createElement('div');
            serviceNotesDiv.className = 'flex-shrink-0 w-full md:w-56 text-sm text-gray-600 text-left md:text-right'; // Ширина и выравнивание
            
            // Получаем названия для выбранных услуг
            let serviceLabels = 'Не указаны'; // По умолчанию
            if (b.selectedServices && Array.isArray(b.selectedServices) && b.selectedServices.length > 0) {
                serviceLabels = b.selectedServices.map(serviceKey => getServiceLabel(serviceKey)).join(', ');
            } else if (b.serviceType) { // Обратная совместимость со старым полем
                 serviceLabels = getServiceLabel(b.serviceType);
            }

            serviceNotesDiv.innerHTML = `<div class="font-medium mb-1">${serviceLabels}</div>`;
        if (b.notes) {
                serviceNotesDiv.innerHTML += `<div class="italic text-gray-500 whitespace-pre-wrap break-words">${b.notes}</div>`;
        }

            li.appendChild(dateTimeDiv);
            li.appendChild(clientInfoDiv);
            li.appendChild(serviceNotesDiv);

            // Действия (только для админа)
        if (isAdmin) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex-shrink-0 flex items-center space-x-2 ml-0 md:ml-4 mt-2 md:mt-0'; // Отступы

          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'text-blue-600 hover:text-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-400 rounded p-1';
          editBtn.title = 'Редактировать запись';
                editBtn.innerHTML = '<i class="fas fa-edit fa-fw"></i>'; // Иконка побольше
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditModal(b.id);
                 });

          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-red-400 rounded p-1';
          deleteBtn.title = 'Удалить запись';
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt fa-fw"></i>'; // Иконка побольше
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Вы уверены, что хотите удалить запись для "${b.clientName}"?`)) {
              deleteBooking(b.id);
            }
          });

          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(deleteBtn);
          li.appendChild(actionsDiv);
        }

        bookingsListEl.appendChild(li);
      });
    }


    // === Логика Модального Окна Бронирования Клиента ===
    function openBookingModal(date = null) {
      if (!isAdmin) {
        showLoginModal();
        return;
      }

      bookingIdInput.value = ''; // Сброс ID для нового бронирования
      modalTitle.textContent = 'Карточка клиента'; // Изменено
      deleteBookingBtn.classList.add('hidden'); // Скрыть кнопку удаления
      bookingForm.reset(); // Сбросить форму
      clientPhoneInput.value = '+7 ('; // Установить маску по умолчанию

      // Установить дату по умолчанию (сегодня или выбранная дата)
      // Используем безопасное форматирование
      const defaultDate = date ? formatDateSafe(date) : formatDateSafe(new Date());
      bookingForm.bookingDate.value = defaultDate;

      // Создаем объект Date из строки 'YYYY-MM-DD', добавляя время чтобы избежать UTC сдвига при парсинге
      const bookingDateObj = new Date(defaultDate + 'T00:00:00');
      // bookingForm.serviceType.value = isWeekend(bookingDateObj) ? 'weekend_vr' : 'weekday_vr'; // Удалено, так как элемент больше не существует


      bookingModal.classList.remove('hidden');
      bookingForm.clientName.focus(); // Фокус на имени клиента
      // Создаем новый объект Date для selectedDate, чтобы избежать изменения исходного объекта date
      selectedDate = date ? new Date(date.getFullYear(), date.getMonth(), date.getDate()) : null;
      renderCalendar(); // Перерисовать календарь
    }

    function openEditModal(id) {
      if (!isAdmin) {
        showLoginModal();
        return;
      }

      const booking = bookings.find(b => b.id === id);
      if (!booking) {
          console.error("Бронирование не найдено:", id);
          alert("Не удалось найти бронирование для редактирования.");
          return;
      }

      bookingIdInput.value = booking.id;
      modalTitle.textContent = 'Карточка клиента'; // Изменено
      deleteBookingBtn.classList.remove('hidden'); // Показать кнопку удаления
      bookingModal.classList.remove('hidden');

      // Заполнить форму данными из бронирования
      bookingForm.clientName.value = booking.clientName;
      bookingForm.clientPhone.value = booking.clientPhone || '+7 (';
      bookingForm.bookingDate.value = booking.bookingDate;
      bookingForm.startTime.value = booking.startTime;
      bookingForm.duration.value = booking.duration.toString();
      bookingForm.notes.value = booking.notes || '';

      bookingForm.clientName.focus(); // Фокус на имени клиента

      // Выделить день в календаре
      selectedDate = new Date(booking.bookingDate + 'T00:00:00'); // Установка времени на начало дня для корректной даты
      renderCalendar();
    }

    async function handleBookingFormSubmit(e) {
      e.preventDefault();

      if (!isAdmin) {
            alert("Требуется авторизация администратора!");
            showLoginModal();
        return;
      }

      const id = bookingIdInput.value;
        const bookingData = {
        clientName: bookingForm.clientName.value.trim(),
        clientPhone: bookingForm.clientPhone.value.trim(),
        bookingDate: bookingForm.bookingDate.value,
        startTime: bookingForm.startTime.value,
        duration: parseFloat(bookingForm.duration.value),
        selectedServices: Array.from(selectedServices), // Сохраняем выбранные услуги
        notes: bookingForm.notes.value.trim(),
        discountPercent: parseFloat(bookingForm.discountPercent.value) || 0, // Сохраняем скидку %
        discountAmount: parseFloat(bookingForm.discountAmount.value) || 0, // Сохраняем скидку ₽
      };

        // --- Валидация ---
        if (!bookingData.clientName) {
        alert('Пожалуйста, введите имя клиента.');
      bookingForm.clientName.focus();
        return;
      }
        // Валидация номера телефона (должно быть 11 цифр после +7)
        const phoneDigits = bookingData.clientPhone.replace(/\D/g, '');
        if (!bookingData.clientPhone || !(phoneDigits.length === 11 && phoneDigits.startsWith('7'))) {
            alert('Пожалуйста, введите корректный номер телефона в формате +7 (XXX) XXX-XX-XX.');
            bookingForm.clientPhone.focus();
        return;
      }
         if (!bookingData.bookingDate) {
        alert('Пожалуйста, выберите дату.');
            bookingForm.bookingDate.focus();
        return;
      }
        if (!bookingData.startTime) {
        alert('Пожалуйста, выберите время начала.');
            bookingForm.startTime.focus();
        return;
      }
        if (isNaN(bookingData.duration) || bookingData.duration <= 0) {
            alert('Пожалуйста, выберите корректную длительность.');
            bookingForm.duration.focus();
            return;
        }
        // ----------------

      try {
        if (id) {
          // Обновление существующей записи
                await updateDoc(doc(db, "bookings", id), bookingData);
        } else {
          // Добавление новой записи
                await addDoc(collection(db, "bookings"), bookingData);
        }
        bookingModal.classList.add('hidden');
      } catch (error) {
            console.error("Ошибка сохранения бронирования:", error);
            alert("Не удалось сохранить запись. Пожалуйста, попробуйте еще раз.");
        }
    }

    async function deleteBooking(id) {
      if (!isAdmin) {
        alert("Требуется авторизация администратора!");
        showLoginModal();
        return;
      }
      try {
        await deleteDoc(doc(db, "bookings", id));
        console.log("Запись удалена:", id);
        // Обновление интерфейса произойдет через onSnapshot
      } catch (error) {
        console.error("Ошибка удаления бронирования:", error);
        alert("Не удалось удалить запись.");
      }
    }

    // === Логика Графика Администраторов ===
    function renderAdminsCalendar() {
      if (!isAdmin) {
          adminScheduleSection.classList.add('hidden'); // Скрыть секцию если не админ
          return;
      }
      adminScheduleSection.classList.remove('hidden'); // Показать секцию если админ

      // Очистка старых дней (оставляем заголовки)
      while (adminsCalendar.children.length > 7) {
        adminsCalendar.removeChild(adminsCalendar.lastChild);
      }

      const year = adminsViewMonth.getFullYear();
      const month = adminsViewMonth.getMonth();

      currentMonthAdmins.textContent = adminsViewMonth.toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
      });

      const firstDayOfMonth = new Date(year, month, 1);
      let startDayOfWeek = firstDayOfMonth.getDay();
      startDayOfWeek = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;

      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // Пустые ячейки
      for (let i = 0; i < startDayOfWeek; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'border border-gray-200 bg-gray-50 rounded-xl calendar-day-cell'; // Используем новый класс и стиль
        adminsCalendar.appendChild(emptyCell);
      }

      // Ячейки дней
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        // Используем безопасное форматирование
        const dateStr = formatDateSafe(date);

        const dayCell = document.createElement('div');
        // Добавляем классы для стилизации и управления высотой
        dayCell.className = 'calendar-day-cell border border-gray-300 rounded-xl p-2 flex flex-col cursor-pointer hover:bg-blue-50 transition relative';

        // Выделение сегодняшнего дня
        const today = new Date();
        // Используем безопасное форматирование
        if (formatDateSafe(date) === formatDateSafe(today)) {
          dayCell.classList.add('ring-2', 'ring-blue-600');
        }

        // Номер дня
        const dayNumber = document.createElement('div');
        dayNumber.textContent = day;
        dayNumber.className = 'font-semibold text-sm text-gray-900 mb-1 text-left'; // Выравнивание по левому краю
        dayCell.appendChild(dayNumber);

        // Отображение назначенных администраторов
        // Сравнение идет со строкой dateStr, которая теперь формируется безопасно
        const assignment = adminAssignments.find(a => a.date === dateStr);
        const assignmentDetails = document.createElement('div');
        assignmentDetails.className = 'flex-grow flex flex-col justify-start space-y-1 mt-1 text-xs'; // Выравнивание контента

        if (assignment && assignment.mainAdminId) {
          const mainAdmin = admins.find(a => a.id === assignment.mainAdminId);
          if (mainAdmin) {
            const adminDiv = document.createElement('div');
            adminDiv.className = 'bg-blue-100 text-blue-800 rounded px-1.5 py-0.5 truncate text-left';
            adminDiv.textContent = `👑 ${mainAdmin.name}`;
            adminDiv.title = `Основной: ${mainAdmin.name}`;
            assignmentDetails.appendChild(adminDiv);
          }

          if (assignment.helperAdminId) {
            const helperAdmin = admins.find(a => a.id === assignment.helperAdminId);
            if (helperAdmin) {
              const helperDiv = document.createElement('div');
              helperDiv.className = 'bg-indigo-100 text-indigo-800 rounded px-1.5 py-0.5 truncate text-left';
              const hoursText = assignment.helperHours ? ` (${assignment.helperHours}ч)` : '';
              helperDiv.textContent = `🛠️ ${helperAdmin.name}${hoursText}`; // Иконка помощи
              helperDiv.title = `Помощник: ${helperAdmin.name}${hoursText}`;
              assignmentDetails.appendChild(helperDiv);
            }
          }
        } else {
            // Можно добавить плейсхолдер или оставить пустым
             const noAdminDiv = document.createElement('div');
             noAdminDiv.className = 'text-gray-400 italic text-xs text-center mt-2';
             noAdminDiv.textContent = 'Нет смены';
             assignmentDetails.appendChild(noAdminDiv);
        }
        dayCell.appendChild(assignmentDetails);


        // Обработчик клика для назначения (только для админа)
        dayCell.addEventListener('click', () => {
          if (!isAdmin) {
            showLoginModal();
            return;
          }
          // Передаем dateStr, который был сформирован безопасно
          openAssignModal(date, dateStr);
        });

        adminsCalendar.appendChild(dayCell);
      }
    }


    // === Логика Модального Окна Назначения Админа ===
    function updateAdminSelects() {
        console.log('updateAdminSelects called. Admins available:', admins.length, admins); // DEBUG
        const mainAdminValue = mainAdminSelect.value;
        const helperAdminValue = helperAdminSelect.value;

        mainAdminSelect.innerHTML = '<option value="">-- Не назначен --</option>';
        helperAdminSelect.innerHTML = '<option value="">-- Нет помощника --</option>';

        admins.forEach(admin => {
            const optionMain = document.createElement('option');
            optionMain.value = admin.id;
            optionMain.textContent = admin.name;
             console.log('Adding main option:', admin.name, admin.id); // DEBUG
            mainAdminSelect.appendChild(optionMain);

            const optionHelper = document.createElement('option');
            optionHelper.value = admin.id;
            optionHelper.textContent = admin.name;
            console.log('Adding helper option:', admin.name, admin.id); // DEBUG
            helperAdminSelect.appendChild(optionHelper);
        });

        // Восстанавливаем сохраненные значения, если они есть
        mainAdminSelect.value = mainAdminValue;
        helperAdminSelect.value = helperAdminValue;

        // Обновляем доступность опций в списке помощников
        updateHelperAdminOptions();
    }

    function updateHelperAdminOptions() {
        const selectedMainAdminId = mainAdminSelect.value;
        const currentHelperValue = helperAdminSelect.value; // Запоминаем текущий выбор

        // Перебираем опции помощника
        Array.from(helperAdminSelect.options).forEach(option => {
            // Блокируем опцию, если она совпадает с выбранным основным админом
            // и это не пустая опция "-- Нет помощника --"
            if (option.value && option.value === selectedMainAdminId) {
                option.disabled = true;
                // Если заблокированная опция была выбрана, сбрасываем выбор помощника
                if (helperAdminSelect.value === option.value) {
                    helperAdminSelect.value = ""; // Сброс на "-- Нет помощника --"
                     toggleHelperHours(false); // Скрыть поле часов
                }
            } else {
                option.disabled = false; // Разблокируем остальные
            }
        });

         // Восстанавливаем выбор помощника, если он не был сброшен
         if (helperAdminSelect.value === "" && currentHelperValue !== "" && currentHelperValue !== selectedMainAdminId) {
            helperAdminSelect.value = currentHelperValue;
         }

         // Показываем/скрываем поле часов в зависимости от выбора помощника
         toggleHelperHours(helperAdminSelect.value !== "");
    }


    function toggleHelperHours(show) {
        if (show) {
            helperHoursSection.classList.remove('hidden');
            helperHoursInput.required = true; // Делаем поле обязательным
        } else {
            helperHoursSection.classList.add('hidden');
            helperHoursInput.required = false; // Снимаем обязательность
            helperHoursInput.value = ''; // Очищаем значение
        }
    }


    function openAssignModal(date, dateStr) {
      if (!isAdmin) {
        showLoginModal();
        return;
      }

      assignModalTitle.textContent = `Назначение на ${date.toLocaleDateString('ru-RU', {day: '2-digit', month: 'long', year: 'numeric'})}`;
      assignDateInput.value = dateStr; // Используем строку даты как ID документа

      // Поиск существующего назначения
      const assignment = adminAssignments.find(a => a.id === dateStr); // Ищем по ID (дате)

      if (assignment) {
        // Заполняем форму из существующего назначения
        mainAdminSelect.value = assignment.mainAdminId || '';
        helperAdminSelect.value = assignment.helperAdminId || '';
        helperHoursInput.value = assignment.helperHours || '';
        deleteAssignmentBtn.classList.remove('hidden'); // Показать кнопку удаления
      } else {
        // Сбрасываем форму для нового назначения
        mainAdminSelect.value = '';
        helperAdminSelect.value = '';
        helperHoursInput.value = '';
        deleteAssignmentBtn.classList.add('hidden'); // Скрыть кнопку удаления
      }

      updateHelperAdminOptions(); // Обновляем доступность помощников и видимость поля часов
      assignAdminModal.classList.remove('hidden');
      mainAdminSelect.focus();
    }

    async function handleAssignAdminFormSubmit(e) {
      e.preventDefault();
      if (!isAdmin) {
        alert("Требуется авторизация администратора!");
        showLoginModal();
        return;
      }

      const date = assignDateInput.value;
      const mainAdminId = mainAdminSelect.value;
      const helperAdminId = helperAdminSelect.value;
      const helperHours = helperHoursInput.value ? parseInt(helperHoursInput.value) : null;

      // Валидация: основной админ должен быть выбран
      if (!mainAdminId) {
        alert('Пожалуйста, выберите основного администратора.');
        mainAdminSelect.focus();
        return;
      }

      // Валидация: если выбран помощник, часы должны быть указаны и быть > 0
      if (helperAdminId && (!helperHours || helperHours <= 0)) {
        alert('Пожалуйста, укажите корректное количество часов для помощника.');
        helperHoursInput.focus();
        return;
      }

       // Валидация: основной и помощник не могут быть одним и тем же человеком
       if (mainAdminId && helperAdminId && mainAdminId === helperAdminId) {
           alert('Основной администратор и помощник не могут быть одним и тем же человеком.');
           helperAdminSelect.focus();
           return;
       }

      const assignmentData = {
        date: date, // Сохраняем дату для возможности фильтрации (хотя ID уже дата)
        mainAdminId: mainAdminId,
        helperAdminId: helperAdminId || null, // Сохраняем null, если не выбран
        helperHours: helperHours // Сохраняем null, если не указаны
      };

      try {
        // Используем дату (dateStr) как ID документа в коллекции adminAssignments
        const assignmentRef = doc(db, "adminAssignments", date);
        await setDoc(assignmentRef, assignmentData); // setDoc перезапишет или создаст документ

        console.log("Назначение сохранено:", date);
        assignAdminModal.classList.add('hidden');
      } catch (error) {
        console.error("Ошибка сохранения назначения:", error);
        alert("Не удалось сохранить назначение. Пожалуйста, попробуйте еще раз.");
      }
    }

    async function deleteAssignment() {
        const date = assignDateInput.value;
        if (!date) return;

        if (!isAdmin) {
            alert("Требуется авторизация администратора!");
            showLoginModal();
            return;
        }

        if (confirm(`Вы уверены, что хотите удалить назначение на ${date}?`)) {
            try {
                await deleteDoc(doc(db, "adminAssignments", date));
                console.log("Назначение удалено:", date);
                assignAdminModal.classList.add('hidden');
                // Обновление интерфейса произойдет через onSnapshot
            } catch (error) {
                console.error("Ошибка удаления назначения:", error);
                alert("Не удалось удалить назначение.");
            }
        }
    }


    // === Логика Расчета Зарплаты ===
    function calculateSalaries() {
      if (!isAdmin) {
          salarySection.classList.add('hidden'); // Скрыть секцию если не админ
          return;
      }
       salarySection.classList.remove('hidden'); // Показать секцию если админ

      const year = salaryViewMonth.getFullYear();
      const month = salaryViewMonth.getMonth();

      currentMonthSalary.textContent = salaryViewMonth.toLocaleDateString('ru-RU', {
        year: 'numeric',
        month: 'long',
      });

      // 1. Группировка бронирований по датам для текущего месяца
      const bookingsByDate = {};
      bookings.forEach(booking => {
        // Убедимся что bookingDate существует и это строка
        if (typeof booking.bookingDate === 'string') {
           try {
                const bookingDateObj = new Date(booking.bookingDate + 'T00:00:00'); // Добавляем время для надежности парсинга
                if (bookingDateObj.getFullYear() === year && bookingDateObj.getMonth() === month) {
                    const dateStr = booking.bookingDate; // Используем исходную строку даты
                    if (!bookingsByDate[dateStr]) {
                        bookingsByDate[dateStr] = [];
                    }
                    bookingsByDate[dateStr].push(booking);
                }
            } catch (e) {
                 console.error("Ошибка парсинга даты бронирования:", booking.bookingDate, e);
            }
        } else {
             console.warn("Некорректный формат даты в бронировании:", booking);
        }

      });

      // 2. Инициализация данных по зарплате для каждого администратора
      const salaryData = {};
      admins.forEach(admin => {
        salaryData[admin.id] = {
          name: admin.name,
          baseSalary: 0, // Сумма фиксированных ставок и почасовой оплаты
          bonusSalary: 0, // Сумма бонусов от выручки
          totalSalary: 0, // Итоговая ЗП
          daysWorked: 0, // Количество смен основного
          hoursWorked: 0, // Количество часов помощника
          details: [] // Массив для детализации по дням
        };
      });

      // 3. Обработка каждого дня месяца, на который есть назначение
      let totalMonthRevenue = 0; // Общая выручка за месяц (после скидок)

      adminAssignments.forEach(assignment => {
          // Убедимся, что assignment.date это строка и соответствует текущему месяцу/году
          if (typeof assignment.date === 'string') {
              try {
                  const assignmentDateObj = new Date(assignment.date + 'T00:00:00');
                  if (assignmentDateObj.getFullYear() === year && assignmentDateObj.getMonth() === month) {
                      const dateStr = assignment.date; // Строка даты 'YYYY-MM-DD'
                      const dayBookings = bookingsByDate[dateStr] || [];
                      let dayRevenue = 0; // Выручка дня ПОСЛЕ скидок

                      // Расчет выручки за день
                      dayBookings.forEach(booking => {
                          let bookingTotalAmount = 0; // Сумма до скидки
                          const duration = parseFloat(booking.duration) || 0;

                          // Используем selectedServices для расчета суммы ДО скидки
                          if (booking.selectedServices && Array.isArray(booking.selectedServices)) {
                              booking.selectedServices.forEach(service => {
                                  if (service === 'birthday') {
                                      // Накопительный расчет для ДР
                                      const fullHours = Math.floor(duration);
                                      const hasHalfHour = duration % 1 !== 0;
                                      let birthdayTotal = 0;
                                      for (let hour = 1; hour <= fullHours; hour++) {
                                          const hourPrice = servicePrices.birthday[hour] || servicePrices.birthday[4] || 3000;
                                          birthdayTotal += hourPrice;
                                      }
                                      if (hasHalfHour) {
                                          if (fullHours === 0) { birthdayTotal += 2000; }
                                          else if (fullHours === 1) { birthdayTotal += 2000; }
                                          else { birthdayTotal += (servicePrices.birthday[3] || 3000) / 2; }
                                      }
                                      bookingTotalAmount += birthdayTotal;
                                  } else {
                                      // Обычный расчет для других услуг
                                      const price = servicePrices[service] || 0;
                                      bookingTotalAmount += price * duration;
                                  }
                              });
                          } else if (booking.serviceType) { // Обратная совместимость со старым полем
                               // Логика расчета суммы ДО скидки по старому полю serviceType
                               // ... (логика расчета bookingRevenue по serviceType остается той же, но присваиваем в bookingTotalAmount) ...
                               console.warn('Using legacy serviceType for monthly salary calculation (calculating pre-discount amount)', booking);
                               if (booking.serviceType === 'birthday') {
                                   const hours = Math.min(Math.max(Math.ceil(duration), 1), 12);
                                   bookingTotalAmount = servicePrices.birthday[hours] || servicePrices.birthday[4];
                               } else if (duration === 0.5 && servicePriceHalfHour[booking.serviceType]) {
                                   bookingTotalAmount = servicePriceHalfHour[booking.serviceType] || 0;
                               } else {
                                   const pricePerHour = servicePrices[booking.serviceType] || 0;
                                   bookingTotalAmount = pricePerHour * duration;
                               }
                          }

                          // Рассчитываем итоговую стоимость бронирования с учетом скидки
                          const discountPercent = booking.discountPercent || 0;
                          const discountAmount = booking.discountAmount || 0;
                          let finalBookingAmount = bookingTotalAmount; // Итоговая стоимость этого бронирования
                          if (discountPercent > 0) {
                            finalBookingAmount = bookingTotalAmount * (1 - discountPercent / 100);
                          } else if (discountAmount > 0) {
                            finalBookingAmount = Math.max(0, bookingTotalAmount - discountAmount);
                          }

                          dayRevenue += finalBookingAmount; // Добавляем к выручке дня ИТОГОВУЮ сумму бронирования
                      });

                      totalMonthRevenue += dayRevenue; // Добавляем к общей выручке месяца (уже с учетом скидок)

                      // Начисление зарплаты основному администратору (используем dayRevenue ПОСЛЕ скидок)
                      if (assignment.mainAdminId && salaryData[assignment.mainAdminId]) {
                          const adminData = salaryData[assignment.mainAdminId];
                          adminData.daysWorked++;
                          const basePay = 500; // Фиксированная ставка за смену
                          adminData.baseSalary += basePay;
                          const bonusPercent = assignment.helperAdminId ? 0.08 : 0.15;
                          const bonus = dayRevenue * bonusPercent; // <- Считается от dayRevenue после скидок
                          adminData.bonusSalary += bonus;
                          adminData.totalSalary += basePay + bonus;

                          adminData.details.push({
                              date: dateStr,
                              type: 'Основная смена',
                              base: basePay,
                              bonus: bonus, // Сохраняем бонус, посчитанный от правильной выручки
                              revenue: dayRevenue, // Сохраняем выручку дня после скидок
                              hours: 0
                          });
                      }

                      // Начисление зарплаты помощнику (используем dayRevenue ПОСЛЕ скидок)
                      if (assignment.helperAdminId && salaryData[assignment.helperAdminId] && assignment.helperHours) {
                          const helperData = salaryData[assignment.helperAdminId];
                          const hours = parseInt(assignment.helperHours) || 0;
                          if (hours > 0) {
                                helperData.hoursWorked += hours;
                                const basePay = hours * 150; // 150₽ в час
                                helperData.baseSalary += basePay;
                                const bonusPercent = 0.07;
                                const bonus = dayRevenue * bonusPercent; // <- Считается от dayRevenue после скидок
                                helperData.bonusSalary += bonus;
                                helperData.totalSalary += basePay + bonus;

                                helperData.details.push({
                                    date: dateStr,
                                    type: 'Помощь на смене',
                                    base: basePay,
                                    bonus: bonus, // Сохраняем бонус, посчитанный от правильной выручки
                                    revenue: dayRevenue, // Сохраняем выручку дня после скидок
                                    hours: hours
                                });
                          }
                      }
                  }
              } catch(e) {
                  console.error("Ошибка парсинга даты назначения:", assignment.date, e);
              }
          } else {
               console.warn("Некорректный формат даты в назначении:", assignment);
          }
      });


      // 4. Отображение результатов
      renderSalaryResults(salaryData, totalMonthRevenue);
    }


    function renderSalaryResults(salaryData, totalRevenue) {
      salaryResults.innerHTML = ''; // Очищаем предыдущие результаты

      // Карточка общей выручки
      const revenueCard = document.createElement('div');
      revenueCard.className = 'bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl shadow-md p-6 border border-green-200'; // Градиент
      revenueCard.innerHTML = `
        <h3 class="text-lg font-semibold mb-2 text-green-800">Общая выручка за месяц</h3>
        <p class="text-3xl font-bold text-green-600">${totalRevenue.toLocaleString('ru-RU')} ₽</p> <!-- Округление -->
        <button class="mt-3 text-sm text-green-700 hover:text-green-900 view-revenue-details flex items-center">
            <i class="fas fa-list mr-1.5"></i> Показать детализацию
        </button>
        <div id="revenue-details" class="hidden mt-4 space-y-2 border-t border-green-100 pt-3">
          <!-- Детализация выручки будет здесь -->
        </div>
      `;
      salaryResults.appendChild(revenueCard);

      // Карточки для каждого администратора, кто работал в этом месяце
      admins.forEach(admin => {
        const data = salaryData[admin.id];
        // Отображаем только если есть данные и ЗП > 0
        if (data && data.totalSalary > 0) {
          const adminCard = document.createElement('div');
          adminCard.className = 'bg-white rounded-2xl shadow-md p-6 border border-gray-200 transition hover:shadow-lg'; // Эффект при наведении

          adminCard.innerHTML = `
            <h3 class="text-xl font-semibold mb-4 text-gray-800">${admin.name}</h3>
            <div class="grid grid-cols-2 gap-x-6 gap-y-3 mb-5">
              <div>
                <p class="text-sm text-gray-500">Смен (основной)</p>
                <p class="font-medium text-lg">${data.daysWorked}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Часов (помощник)</p>
                <p class="font-medium text-lg">${data.hoursWorked}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Ставка + Почасовая</p>
                <p class="font-medium text-lg">${data.baseSalary.toLocaleString('ru-RU')} ₽</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Бонус от выручки</p>
                <p class="font-medium text-lg">${data.bonusSalary.toLocaleString('ru-RU', { maximumFractionDigits: 0 })} ₽</p> <!-- Округление бонуса -->
              </div>
            </div>
            <div class="border-t border-gray-200 pt-4 mt-4">
              <p class="text-sm font-medium text-gray-600">Итого зарплата</p>
              <p class="text-2xl font-bold text-blue-600 mt-1">${data.totalSalary.toLocaleString('ru-RU', { maximumFractionDigits: 0 })} ₽</p> <!-- Округление итоговой -->
            </div>
            <button class="mt-5 text-sm text-blue-600 hover:text-blue-800 view-details flex items-center" data-admin="${admin.id}">
              <i class="fas fa-list mr-1.5"></i> Показать детализацию
            </button>
            <div id="details-${admin.id}" class="hidden mt-4 space-y-3 border-t border-gray-100 pt-4">
              <!-- Детализация будет здесь -->
            </div>
          `;
          salaryResults.appendChild(adminCard);
        }
      });

        // Если нет данных по зарплате ни у одного админа
        if (salaryResults.children.length <= 1) { // Только карточка выручки
             const noSalaryText = document.createElement('p');
             noSalaryText.className = 'text-center text-gray-500 italic mt-6';
             noSalaryText.textContent = 'Нет данных о зарплате за выбранный месяц.';
             salaryResults.appendChild(noSalaryText);
        }


      // Обработчики для кнопок "Подробнее"
      document.querySelectorAll('.view-details').forEach(btn => {
        btn.addEventListener('click', () => {
          const adminId = btn.getAttribute('data-admin');
          const detailsDiv = document.getElementById(`details-${adminId}`);
          const data = salaryData[adminId];
          const icon = btn.querySelector('i');

          if (detailsDiv.classList.contains('hidden')) {
            // Показать детализацию
            detailsDiv.innerHTML = ''; // Очистить перед заполнением
             if (data.details.length > 0) {
                 // Сортировка деталей по дате
                 data.details.sort((a,b) => a.date.localeCompare(b.date));

                 data.details.forEach(detail => {
                  const detailItem = document.createElement('div');
                  detailItem.className = 'text-sm border-b border-gray-100 pb-2 mb-2 last:border-b-0 last:pb-0 last:mb-0'; // Стили для элементов списка
                  const detailDate = new Date(detail.date + 'T00:00:00');
                  const formattedDate = detailDate.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short'});

                  detailItem.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                      <p class="font-medium text-gray-700">${formattedDate} - ${detail.type}</p>
                      <p class="font-semibold text-blue-700">${(detail.base + detail.bonus).toLocaleString('ru-RU', { maximumFractionDigits: 0 })} ₽</p>
                    </div>
                    <div class="grid grid-cols-3 gap-x-2 text-xs text-gray-500">
                      <span>${detail.hours > 0 ? `${detail.hours}ч` : 'Ставка'}: ${detail.base.toLocaleString('ru-RU')} ₽</span>
                      <span>Бонус: ${detail.bonus.toLocaleString('ru-RU', { maximumFractionDigits: 0 })} ₽</span>
                      <span>Выручка дня: ${detail.revenue.toLocaleString('ru-RU', { maximumFractionDigits: 0 })} ₽</span>
                    </div>
                  `;
                  detailsDiv.appendChild(detailItem);
                });
             } else {
                  detailsDiv.innerHTML = '<p class="text-xs text-gray-400 italic">Нет детальной информации.</p>';
             }

            detailsDiv.classList.remove('hidden');
            btn.innerHTML = '<i class="fas fa-chevron-up mr-1.5"></i> Скрыть детализацию';
          } else {
            // Скрыть детализацию
            detailsDiv.classList.add('hidden');
            btn.innerHTML = '<i class="fas fa-list mr-1.5"></i> Показать детализацию';
          }
        });
      });

       // Обработчик для кнопки детализации общей выручки
       const revenueDetailsBtn = document.querySelector('.view-revenue-details');
       if (revenueDetailsBtn) {
           revenueDetailsBtn.addEventListener('click', () => {
               const detailsDiv = document.getElementById('revenue-details');
               const icon = revenueDetailsBtn.querySelector('i');

               if (detailsDiv.classList.contains('hidden')) {
                   // Показать детализацию выручки
                   detailsDiv.innerHTML = ''; // Очистить

                   // 1. Пересчитываем выручку по дням напрямую из bookings
                   const revenueByDay = {};
                   const year = salaryViewMonth.getFullYear();
                   const month = salaryViewMonth.getMonth();
                   const yearMonthStr = `${year}-${(month + 1).toString().padStart(2, '0')}`;

                   bookings.forEach(booking => {
                       if (typeof booking.bookingDate === 'string' && booking.bookingDate.startsWith(yearMonthStr)) {
                            const dateStr = booking.bookingDate;
                            if (!revenueByDay[dateStr]) {
                                revenueByDay[dateStr] = 0;
                            }

                            // Расчет итоговой суммы бронирования ПОСЛЕ скидки (аналогично calculateRevenueStats)
                            const duration = parseFloat(booking.duration) || 0;
                            let bookingTotalAmount = 0;
                            if (booking.selectedServices && Array.isArray(booking.selectedServices)) {
                                booking.selectedServices.forEach(service => {
                                   if (service === 'birthday') {
                                     const fullHours = Math.floor(duration);
                                     const hasHalfHour = duration % 1 !== 0;
                                     let birthdayTotal = 0;
                                     for (let hour = 1; hour <= fullHours; hour++) {
                                       const hourPrice = servicePrices.birthday[hour] || servicePrices.birthday[4] || 3000;
                                       birthdayTotal += hourPrice;
                                     }
                                     if (hasHalfHour) {
                                        if (fullHours === 0) { birthdayTotal += 2000; }
                                        else if (fullHours === 1) { birthdayTotal += 2000; }
                                        else { birthdayTotal += (servicePrices.birthday[3] || 3000) / 2; }
                                     }
                                     bookingTotalAmount += birthdayTotal;
                                   } else {
                                     const price = servicePrices[service] || 0;
                                     bookingTotalAmount += price * duration;
                                   }
                                });
                            } else if (booking.serviceType) { // Обратная совместимость
                                 console.warn('Using legacy serviceType for revenue details calculation (calculating pre-discount amount)', booking);
                                 if (booking.serviceType === 'birthday') {
                                     const hours = Math.min(Math.max(Math.ceil(duration), 1), 12);
                                     bookingTotalAmount = servicePrices.birthday[hours] || servicePrices.birthday[4];
                                 } else if (duration === 0.5 && servicePriceHalfHour[booking.serviceType]) {
                                     bookingTotalAmount = servicePriceHalfHour[booking.serviceType] || 0;
                                 } else {
                                     const pricePerHour = servicePrices[booking.serviceType] || 0;
                                     bookingTotalAmount = pricePerHour * duration;
                                 }
                            }

                            const discountPercent = booking.discountPercent || 0;
                            const discountAmount = booking.discountAmount || 0;
                            let finalBookingAmount = bookingTotalAmount;
                            if (discountPercent > 0) {
                              finalBookingAmount = bookingTotalAmount * (1 - discountPercent / 100);
                            } else if (discountAmount > 0) {
                              finalBookingAmount = Math.max(0, bookingTotalAmount - discountAmount);
                            }

                            revenueByDay[dateStr] += finalBookingAmount; // Суммируем итоговую сумму
                       }
                   });

                   // 2. Группируем по неделям и считаем итоги
                   const revenueByWeek = {}; // { 'YYYY-MM-DD_пн': { days: [{date: '...', amount: N}, ...], total: T } }
                   const sortedDays = Object.keys(revenueByDay).sort();

                   sortedDays.forEach(dateStr => {
                       const amount = revenueByDay[dateStr];
                       if (amount <= 0) return; // Пропускаем дни без выручки

                       const dateObj = new Date(dateStr + 'T00:00:00');
                       const weekRange = getWeekRange(dateObj); // Получаем Пн и Вс недели
                       const mondayStr = formatDateSafe(weekRange.start); // Ключ - дата понедельника

                       if (!revenueByWeek[mondayStr]) {
                           revenueByWeek[mondayStr] = { days: [], total: 0 };
                       }
                       revenueByWeek[mondayStr].days.push({ date: dateStr, amount: amount });
                       revenueByWeek[mondayStr].total += amount;
                   });

                   // 3. Отображаем сгруппированные данные
                   const sortedWeeks = Object.keys(revenueByWeek).sort();

                   if (sortedWeeks.length > 0) {
                        sortedWeeks.forEach(mondayStr => {
                            const weekData = revenueByWeek[mondayStr];

                            // Отображаем дни недели
                            weekData.days.forEach(dayData => {
                                const detailItem = document.createElement('div');
                                detailItem.className = 'text-sm flex justify-between items-center text-green-800 py-0.5'; // Добавлен вертикальный отступ
                                const detailDate = new Date(dayData.date + 'T00:00:00');
                                // Формат даты с днем недели
                                const formattedDate = detailDate.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short', weekday: 'short' });
                                detailItem.innerHTML = `
                                    <span>${formattedDate}</span> <!-- Убрано двоеточие -->
                                    <span class="font-medium">${dayData.amount.toLocaleString('ru-RU', { maximumFractionDigits: 0 })} ₽</span>
                                `;
                                detailsDiv.appendChild(detailItem);
                            });

                            // Добавляем разделитель и итог недели
                            const hr = document.createElement('hr');
                            hr.className = 'border-t border-green-200 my-1.5'; // Чуть толще и с отступами
                            detailsDiv.appendChild(hr);

                            const weekTotalDiv = document.createElement('div');
                            weekTotalDiv.className = 'text-sm font-semibold text-right text-green-700 pr-1 mb-3'; // Отступ снизу
                            weekTotalDiv.innerHTML = `Итого за неделю: ${weekData.total.toLocaleString('ru-RU', { maximumFractionDigits: 0 })} ₽`;
                            detailsDiv.appendChild(weekTotalDiv);
                        });
                   } else {
                       detailsDiv.innerHTML = '<p class="text-xs text-gray-400 italic">Нет данных о выручке по дням за выбранный месяц.</p>';
                   }


                   detailsDiv.classList.remove('hidden');
                   revenueDetailsBtn.innerHTML = '<i class="fas fa-chevron-up mr-1.5"></i> Скрыть детализацию';
               } else {
                   // Скрыть детализацию выручки
                   detailsDiv.classList.add('hidden');
                   revenueDetailsBtn.innerHTML = '<i class="fas fa-list mr-1.5"></i> Показать детализацию';
               }
           });
       }
    }

    // === Аутентификация и Авторизация ===
    function showLoginModal() {
      authContainer.classList.remove('hidden');
      document.getElementById('loginEmail').focus();
    }

    onAuthStateChanged(auth, (user) => {
      console.log('Auth state changed. User:', user); // DEBUG
      if (user) {
        // Пользователь вошел
        isAdmin = true;
        console.log('isAdmin set to true'); // DEBUG
        logoutBtn.classList.remove('hidden');
        loginBtn.classList.add('hidden');
        addBookingBtn.classList.remove('hidden'); // Показать кнопку добавления записи
        adminScheduleSection.classList.remove('hidden'); // Показать секцию графика админов
        salarySection.classList.remove('hidden'); // Показать секцию ЗП
        loadData(); // Загрузить все данные (включая админские)
      } else {
        // Пользователь вышел
        isAdmin = false;
        console.log('isAdmin set to false'); // DEBUG
        logoutBtn.classList.add('hidden');
        loginBtn.classList.remove('hidden');
        addBookingBtn.classList.add('hidden'); // Скрыть кнопку добавления записи
        adminScheduleSection.classList.add('hidden'); // Скрыть секцию графика админов
        salarySection.classList.add('hidden'); // Скрыть секцию ЗП

        // Очистить админские данные и перерисовать интерфейс
        admins = [];
        adminAssignments = [];
        updateAdminSelects();
        renderAdminsCalendar(); // Очистит календарь админов
        calculateSalaries(); // Очистит секцию ЗП
        // Календарь и список бронирований остаются видимыми, данные загрузятся в loadData
        loadData(); // Загрузить только публичные данные (бронирования)
      }
      // Перерисовать календарь и список записей, чтобы применить/убрать админские кнопки
      renderCalendar();
    renderBookingsList();
    });

    // === Обработчики событий ===
    function setupEventListeners() {
      // --- Аутентификация ---
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
          await signInWithEmailAndPassword(auth, email, password);
          authContainer.classList.add('hidden'); // Закрыть окно при успехе
        } catch (error) {
          console.error("Ошибка входа:", error);
          alert('Ошибка входа: ' + error.message); // Показать сообщение об ошибке
        }
      });
      loginBtn.addEventListener('click', showLoginModal);
      logoutBtn.addEventListener('click', () => {
        // Отписываемся от админских слушателей ПЕРЕД выходом
        if (unsubscribeAdmins) {
            unsubscribeAdmins();
            unsubscribeAdmins = null;
            console.log('Unsubscribing from admins before logout'); // DEBUG
        }
        if (unsubscribeAdminAssignments) {
            unsubscribeAdminAssignments();
            unsubscribeAdminAssignments = null;
            console.log('Unsubscribing from adminAssignments before logout'); // DEBUG
        }
        // Выполняем выход
        signOut(auth);
      });
      closeAuthBtn.addEventListener('click', () => authContainer.classList.add('hidden'));

      // --- Обработчики для услуг и скидок ---
      document.querySelectorAll('.service-tag').forEach(tag => {
        tag.addEventListener('click', () => {
          const service = tag.getAttribute('data-service');
          tag.classList.toggle('selected');
          
          if (tag.classList.contains('selected')) {
            selectedServices.add(service);
          } else {
            selectedServices.delete(service);
          }
          
          document.getElementById('selectedServices').value = Array.from(selectedServices).join(',');
          calculateTotal();
        });
      });

      const discountPercentInput = document.getElementById('discountPercent');
      const discountAmountInput = document.getElementById('discountAmount');

      discountPercentInput.addEventListener('input', () => {
        if (discountPercentInput.value) {
          discountAmountInput.value = '';
        }
        calculateTotal();
      });

      discountAmountInput.addEventListener('input', () => {
        if (discountAmountInput.value) {
          discountPercentInput.value = '';
        }
        calculateTotal();
      });

      // --- Календарь клиентов ---
    prevMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
        selectedDate = null; // Сброс выбранной даты при смене месяца
      renderCalendar();
    });
    nextMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      selectedDate = null;
      renderCalendar();
    });
      addBookingBtn.addEventListener('click', () => openBookingModal(selectedDate || new Date())); // Передаем выбранную дату или сегодня


      // --- Список записей клиентов ---
    prevMonthBookingsBtn.addEventListener('click', () => {
        console.log('Prev month bookings clicked. Old month:', bookingsViewMonth.toLocaleDateString()); // DEBUG
      bookingsViewMonth.setMonth(bookingsViewMonth.getMonth() - 1);
         console.log('New month:', bookingsViewMonth.toLocaleDateString()); // DEBUG
        renderBookingsList(); // Убедимся, что вызывается
    });
    nextMonthBookingsBtn.addEventListener('click', () => {
         console.log('Next month bookings clicked. Old month:', bookingsViewMonth.toLocaleDateString()); // DEBUG
      bookingsViewMonth.setMonth(bookingsViewMonth.getMonth() + 1);
        console.log('New month:', bookingsViewMonth.toLocaleDateString()); // DEBUG
        renderBookingsList(); // Убедимся, что вызывается
      });

      // --- Модальное окно бронирования клиента ---
      bookingForm.addEventListener('submit', handleBookingFormSubmit);
      closeModalBtn.addEventListener('click', () => bookingModal.classList.add('hidden'));
      deleteBookingBtn.addEventListener('click', () => {
         const id = bookingIdInput.value;
         const booking = bookings.find(b => b.id === id);
         if (id && booking && confirm(`Вы уверены, что хотите удалить запись для "${booking.clientName}"?`)) {
             deleteBooking(id);
             bookingModal.classList.add('hidden'); // Закрыть окно после удаления
         }
      });

      // --- График администраторов ---
      prevMonthAdminsBtn.addEventListener('click', () => {
        adminsViewMonth.setMonth(adminsViewMonth.getMonth() - 1);
        renderAdminsCalendar();
      });
      nextMonthAdminsBtn.addEventListener('click', () => {
        adminsViewMonth.setMonth(adminsViewMonth.getMonth() + 1);
        renderAdminsCalendar();
      });

      // --- Модальное окно назначения админа ---
      assignAdminForm.addEventListener('submit', handleAssignAdminFormSubmit);
      closeAssignModal.addEventListener('click', () => assignAdminModal.classList.add('hidden'));
      deleteAssignmentBtn.addEventListener('click', deleteAssignment); // Кнопка удаления назначения
      // Обновление списка помощников при смене основного админа
      mainAdminSelect.addEventListener('change', updateHelperAdminOptions);
       // Показ/скрытие поля часов при выборе помощника
      helperAdminSelect.addEventListener('change', () => {
          toggleHelperHours(helperAdminSelect.value !== "");
          // Дополнительно проверим, не выбран ли тот же, что и основной
          if (mainAdminSelect.value && helperAdminSelect.value && mainAdminSelect.value === helperAdminSelect.value) {
               alert('Основной администратор и помощник не могут быть одним и тем же человеком.');
               helperAdminSelect.value = ""; // Сбрасываем помощника
               toggleHelperHours(false); // Скрываем часы
          }
      });


      // --- Расчет зарплаты ---
      prevMonthSalaryBtn.addEventListener('click', () => {
        salaryViewMonth.setMonth(salaryViewMonth.getMonth() - 1);
        // Пересчитываем ТОЛЬКО месячный отчет и статистику выручки для этого месяца
        calculateRevenueStats();
        calculateSalaries();
        // Еженедельная ЗП не зависит от выбранного месяца
      });
      nextMonthSalaryBtn.addEventListener('click', () => {
        salaryViewMonth.setMonth(salaryViewMonth.getMonth() + 1);
         // Пересчитываем ТОЛЬКО месячный отчет и статистику выручки для этого месяца
        calculateRevenueStats();
        calculateSalaries();
         // Еженедельная ЗП не зависит от выбранного месяца
      });

       // --- Закрытие модальных окон ---
       // Клик вне окна
       [authContainer, bookingModal, assignAdminModal, dayDetailsModal].forEach(modal => { // Добавлено dayDetailsModal
           modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
       });
       // Клавиша Esc
       document.addEventListener('keydown', function(e) {
           if (e.key === 'Escape') {
               if (!authContainer.classList.contains('hidden')) {
                   authContainer.classList.add('hidden');
               }
               if (!bookingModal.classList.contains('hidden')) {
        bookingModal.classList.add('hidden');
               }
               if (!assignAdminModal.classList.contains('hidden')) {
                   assignAdminModal.classList.add('hidden');
               }
               if (!dayDetailsModal.classList.contains('hidden')) { // Добавлено
                   dayDetailsModal.classList.add('hidden');
               }
           }
       });

      const durationSelect = document.getElementById('duration'); // Получаем элемент выбора длительности
      durationSelect.addEventListener('input', calculateTotal); // Добавляем слушатель для пересчета

      // --- Модальное окно деталей дня ---
      closeDayDetailsModalBtn.addEventListener('click', () => dayDetailsModal.classList.add('hidden'));
    }

    // === Вспомогательные функции для отображения ===
    function getServiceLabel(serviceType) {
      // Обновлено для всех новых ключей услуг
      switch (serviceType) {
        case 'weekday_ps1': return 'PS5 (1 дж.)';
        case 'weekday_ps2': return 'PS5 (2 дж.)';
        case 'weekday_vr1': return 'VR (1) | Будни';
        case 'weekday_vr2': return 'VR (2) | Будни';
        case 'weekday_vr3': return 'VR (3) | Будни';
        case 'weekday_vr4': return 'VR (4) | Будни';
        case 'weekend_vr1': return 'VR (1) | Выходные';
        case 'weekend_vr2': return 'VR (2) | Выходные';
        case 'weekend_vr3': return 'VR (3) | Выходные';
        case 'weekend_vr4': return 'VR (4) | Выходные';
        case 'xbox_kinnect': return 'X-Box Kinnect';
        case 'xbox1': return 'X-Box (1 дж.)';
        case 'xbox2': return 'X-Box (2 дж.)';
        case 'xbox3': return 'X-Box (3 дж.)';
        case 'xbox4': return 'X-Box (4 дж.)';
        case 'karaoke': return 'Караоке';
        case 'board_games': return 'Наст. игры';
        case 'birthday': return 'Аренда (ДР)';
        default: return 'Неизв. услуга'; // Сокращено
      }
    }

    function formatPhoneNumber(phoneStr) {
        if (!phoneStr) return '';
        const digits = phoneStr.replace(/\D/g, '');
        // Ожидаем формат +7 (XXX) XXX-XX-XX (11 цифр)
        if (digits.length === 11 && digits.startsWith('7')) {
             return `+7 (${digits.substring(1, 4)}) ${digits.substring(4, 7)}-${digits.substring(7, 9)}-${digits.substring(9, 11)}`;
        }
        // Возвращаем как есть, если формат другой
        return phoneStr;
    }


    // === Вспомогательные функции для расчета стоимости ===
    function calculateTotal() {
      const duration = parseFloat(document.getElementById('duration').value) || 0;
      let total = 0;

      // Суммируем стоимость выбранных услуг
      selectedServices.forEach(service => {
        if (service === 'birthday') {
          // Для аренды всего (День Рождения) — расчет с учетом получасовых интервалов
          const fullHours = Math.floor(duration);
          const hasHalfHour = duration % 1 !== 0;
          let birthdayTotal = 0;

          // Суммируем стоимость полных часов
          for (let hour = 1; hour <= fullHours; hour++) {
            const hourPrice = servicePrices.birthday[hour] || servicePrices.birthday[4] || 3000;
            birthdayTotal += hourPrice;
          }

          // Добавляем стоимость за полчаса, если есть
          if (hasHalfHour) {
            if (fullHours === 0) { // Если выбрано 0.5 часа
               birthdayTotal += 2000; // По аналогии с 1.5ч? Или цена первого часа? Уточнить, пока берем 2000
            } else if (fullHours === 1) { // Длительность 1.5 часа
              birthdayTotal += 2000; // Особая цена за +0.5 часа после первого
            } else { // Длительность 2.5, 3.5, 4.5 и т.д.
              // Берем цену 3-го или последующего часа (3000) и делим пополам
              const halfHourPrice = (servicePrices.birthday[3] || 3000) / 2;
              birthdayTotal += halfHourPrice; // 1500
            }
          }

          total += birthdayTotal;
        } else {
          // Обычный расчет для других услуг (цена * длительность)
          const price = servicePrices[service] || 0;
          total += price * duration;
        }
      });

      // Применяем скидку
      const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
      const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
      
      let finalAmount = total;
      if (discountPercent > 0) {
        finalAmount = total * (1 - discountPercent / 100);
      } else if (discountAmount > 0) {
        finalAmount = Math.max(0, total - discountAmount);
      }

      // Обновляем отображение
      document.getElementById('totalAmount').value = `${total.toLocaleString('ru-RU')} ₽`;
      document.getElementById('finalAmount').value = `${finalAmount.toLocaleString('ru-RU')} ₽`;
    }

    // === Инициализация приложения ===
    function init() {
      // Устанавливаем текущие даты для всех представлений
      const now = new Date();
      currentDate = new Date(now.getFullYear(), now.getMonth(), 1);
      bookingsViewMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      adminsViewMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      salaryViewMonth = new Date(now.getFullYear(), now.getMonth(), 1);

      setupEventListeners(); // Настраиваем все обработчики
      // Первичная загрузка данных будет инициирована через onAuthStateChanged
      // Но можно вызвать renderCalendar и renderBookingsList для начального отображения пустых состояний
    renderCalendar();
    renderBookingsList();
      renderAdminsCalendar(); // Покажет пустой календарь админов или скроет секцию
      calculateSalaries(); // Покажет пустую ЗП или скроет секцию
      renderRevenueStats(0, 0, 0); // Инициализируем нулями
      renderWeeklyPayroll({}, null); // Иниц. пустым состоянием
      calculateSalaries(); // Показ. пустой месячный отчет
      // Загрузка данных инициируется через onAuthStateChanged
    }

    // Запуск приложения
    init();

    // === Расчет Статистики Выручки ===
    function calculateRevenueStats() {
        const todayStr = formatDateSafe(new Date());
        const currentWeek = getWeekRange(new Date());
        const currentWeekStartStr = formatDateSafe(currentWeek.start);
        const currentWeekEndStr = formatDateSafe(currentWeek.end);

        const monthYearStr = `${salaryViewMonth.getFullYear()}-${(salaryViewMonth.getMonth() + 1).toString().padStart(2, '0')}`;

        let revenueToday = 0;
        let revenueCurrentWeek = 0;
        let revenueSelectedMonth = 0;

        bookings.forEach(booking => {
            if (typeof booking.bookingDate !== 'string') return;

            const duration = parseFloat(booking.duration) || 0;
            let bookingTotalAmount = 0; // Сумма ДО скидки

            // Расчет суммы ДО скидки (аналогично calculateSalaries)
            if (booking.selectedServices && Array.isArray(booking.selectedServices)) {
                 booking.selectedServices.forEach(service => {
                     if (service === 'birthday') {
                         const fullHours = Math.floor(duration);
                         const hasHalfHour = duration % 1 !== 0;
                         let birthdayTotal = 0;
                         for (let hour = 1; hour <= fullHours; hour++) {
                             const hourPrice = servicePrices.birthday[hour] || servicePrices.birthday[4] || 3000;
                             birthdayTotal += hourPrice;
                         }
                         if (hasHalfHour) {
                             if (fullHours === 0) { birthdayTotal += 2000; }
                             else if (fullHours === 1) { birthdayTotal += 2000; }
                             else { birthdayTotal += (servicePrices.birthday[3] || 3000) / 2; }
                         }
                         bookingTotalAmount += birthdayTotal;
                     } else {
                         const price = servicePrices[service] || 0;
                         bookingTotalAmount += price * duration;
                     }
                 });
            } else if (booking.serviceType) { // Обратная совместимость
                 console.warn('Using legacy serviceType for revenue stats calculation (calculating pre-discount amount)', booking);
                 if (booking.serviceType === 'birthday') {
                     const hours = Math.min(Math.max(Math.ceil(duration), 1), 12);
                     bookingTotalAmount = servicePrices.birthday[hours] || servicePrices.birthday[4];
                 } else if (duration === 0.5 && servicePriceHalfHour[booking.serviceType]) {
                     bookingTotalAmount = servicePriceHalfHour[booking.serviceType] || 0;
                 } else {
                     const pricePerHour = servicePrices[booking.serviceType] || 0;
                     bookingTotalAmount = pricePerHour * duration;
                 }
            }

            // Рассчитываем итоговую стоимость бронирования ПОСЛЕ скидки
            const discountPercent = booking.discountPercent || 0;
            const discountAmount = booking.discountAmount || 0;
            let finalBookingAmount = bookingTotalAmount; // Итоговая стоимость этого бронирования
            if (discountPercent > 0) {
              finalBookingAmount = bookingTotalAmount * (1 - discountPercent / 100);
            } else if (discountAmount > 0) {
              finalBookingAmount = Math.max(0, bookingTotalAmount - discountAmount);
            }

            // Суммируем итоговую выручку
            if (booking.bookingDate === todayStr) {
                revenueToday += finalBookingAmount;
            }
            if (booking.bookingDate >= currentWeekStartStr && booking.bookingDate <= currentWeekEndStr) {
                revenueCurrentWeek += finalBookingAmount;
            }
            if (booking.bookingDate.startsWith(monthYearStr)) {
                revenueSelectedMonth += finalBookingAmount;
            }
        });

        renderRevenueStats(revenueToday, revenueCurrentWeek, revenueSelectedMonth);
    }

    // === Отображение Статистики Выручки ===
    function renderRevenueStats(today, week, month) {
        const todayDate = new Date();
        const currentWeekRange = getWeekRange(todayDate);
        const selectedMonthStart = new Date(salaryViewMonth.getFullYear(), salaryViewMonth.getMonth(), 1);
        const selectedMonthEnd = new Date(salaryViewMonth.getFullYear(), salaryViewMonth.getMonth() + 1, 0);
        
        const dateOptions = { day: '2-digit', month: 'short' };
        const dateOptionsWeekday = { weekday: 'short', day: '2-digit', month: 'short' };

        // Форматируем даты
        const todayStr = todayDate.toLocaleDateString('ru-RU', dateOptions);
        const weekStartStr = currentWeekRange.start.toLocaleDateString('ru-RU', dateOptionsWeekday);
        const weekEndStr = currentWeekRange.end.toLocaleDateString('ru-RU', dateOptionsWeekday);
        const monthStartStr = selectedMonthStart.toLocaleDateString('ru-RU', dateOptionsWeekday);
        const monthEndStr = selectedMonthEnd.toLocaleDateString('ru-RU', dateOptionsWeekday);

        // Обновляем HTML
        const todayCard = revenueTodayEl.closest('div'); // Находим родительский div
        if (todayCard) {
            todayCard.innerHTML = `
                <p class="text-sm font-medium text-green-700">Выручка сегодня</p>
                <p class="text-xs text-green-500 -mt-0.5 mb-1">${todayStr}</p> <!-- Дата -->
                <p id="revenueToday" class="text-xl font-bold text-green-600">${today.toLocaleString('ru-RU')} ₽</p>
            `;
        }

        const weekCard = revenueCurrentWeekEl.closest('div');
        if (weekCard) {
             weekCard.innerHTML = `
                <p class="text-sm font-medium text-green-700">Выручка за неделю</p>
                <p class="text-xs text-green-500 -mt-0.5 mb-1">с ${weekStartStr} по ${weekEndStr}</p> <!-- Период -->
                <p id="revenueCurrentWeek" class="text-xl font-bold text-green-600">${week.toLocaleString('ru-RU')} ₽</p>
            `;
        }
        
        const monthCard = revenueSelectedMonthEl.closest('div');
        if (monthCard) {
             monthCard.innerHTML = `
                <p class="text-sm font-medium text-green-700">Выручка за месяц</p>
                <p class="text-xs text-green-500 -mt-0.5 mb-1">с ${monthStartStr} по ${monthEndStr}</p> <!-- Период -->
                <p id="revenueSelectedMonth" class="text-xl font-bold text-green-600">${month.toLocaleString('ru-RU')} ₽</p>
            `;
        }
    }


    // === Расчет Зарплаты за Прошлую Неделю ===
    function calculateWeeklyPayroll() {
        const today = new Date();
        const previousWeek = getPreviousWeekRange(today);
        const prevWeekStartStr = formatDateSafe(previousWeek.start);
        const prevWeekEndStr = formatDateSafe(previousWeek.end);

        const weeklyPayrollData = {}; // { adminId: { name: 'Name', total: 0 } }

        // 1. Инициализация данных
        admins.forEach(admin => {
            weeklyPayrollData[admin.id] = { name: admin.name, total: 0 };
        });

        // 2. Фильтруем назначения и бронирования за прошлую неделю
        const prevWeekAssignments = adminAssignments.filter(a =>
            typeof a.date === 'string' && a.date >= prevWeekStartStr && a.date <= prevWeekEndStr
        );

        const prevWeekBookingsByDate = {};
        bookings.forEach(booking => {
             if (typeof booking.bookingDate === 'string' && booking.bookingDate >= prevWeekStartStr && booking.bookingDate <= prevWeekEndStr) {
                const dateStr = booking.bookingDate;
                if (!prevWeekBookingsByDate[dateStr]) {
                    prevWeekBookingsByDate[dateStr] = [];
                }
                prevWeekBookingsByDate[dateStr].push(booking);
             }
        });

         // 3. Расчет ЗП за прошлую неделю
         prevWeekAssignments.forEach(assignment => {
            const dateStr = assignment.date;
            const dayBookings = prevWeekBookingsByDate[dateStr] || [];
            let dayRevenue = 0; // Итоговая выручка дня ПОСЛЕ скидок

            // Расчет выручки дня
            dayBookings.forEach(booking => {
                 let bookingTotalAmount = 0; // Сумма до скидки
                 const duration = parseFloat(booking.duration) || 0;

                 // Используем selectedServices для расчета суммы ДО скидки
                 if (booking.selectedServices && Array.isArray(booking.selectedServices)) {
                     booking.selectedServices.forEach(service => {
                         if (service === 'birthday') {
                             // Накопительный расчет для ДР
                             const fullHours = Math.floor(duration);
                             const hasHalfHour = duration % 1 !== 0;
                             let birthdayTotal = 0;
                             for (let hour = 1; hour <= fullHours; hour++) {
                                 const hourPrice = servicePrices.birthday[hour] || servicePrices.birthday[4] || 3000;
                                 birthdayTotal += hourPrice;
                             }
                             if (hasHalfHour) {
                                 if (fullHours === 0) { birthdayTotal += 2000; }
                                 else if (fullHours === 1) { birthdayTotal += 2000; }
                                 else { birthdayTotal += (servicePrices.birthday[3] || 3000) / 2; }
                             }
                             bookingTotalAmount += birthdayTotal;
                         } else {
                             // Обычный расчет для других услуг
                             const price = servicePrices[service] || 0;
                             bookingTotalAmount += price * duration;
                         }
                     });
                 } else if (booking.serviceType) { // Обратная совместимость со старым полем
                      // Логика расчета суммы ДО скидки по старому полю serviceType
                      // ... (логика расчета bookingRevenue по serviceType остается той же, но присваиваем в bookingTotalAmount) ...
                       console.warn('Using legacy serviceType for weekly payroll calculation (calculating pre-discount amount)', booking);
                       if (booking.serviceType === 'birthday') {
                           const hours = Math.min(Math.max(Math.ceil(duration), 1), 12);
                           bookingTotalAmount = servicePrices.birthday[hours] || servicePrices.birthday[4];
                       } else if (duration === 0.5 && servicePriceHalfHour[booking.serviceType]) {
                           bookingTotalAmount = servicePriceHalfHour[booking.serviceType] || 0;
                       } else {
                           const pricePerHour = servicePrices[booking.serviceType] || 0;
                           bookingTotalAmount = pricePerHour * duration;
                       }
                 }

                 // Рассчитываем итоговую стоимость бронирования с учетом скидки
                 const discountPercent = booking.discountPercent || 0;
                 const discountAmount = booking.discountAmount || 0;
                 let finalBookingAmount = bookingTotalAmount; // Итоговая стоимость этого бронирования
                 if (discountPercent > 0) {
                   finalBookingAmount = bookingTotalAmount * (1 - discountPercent / 100);
                 } else if (discountAmount > 0) {
                   finalBookingAmount = Math.max(0, bookingTotalAmount - discountAmount);
                 }

                 dayRevenue += finalBookingAmount; // Добавляем к выручке дня ИТОГОВУЮ сумму бронирования
            });

            // Начисление основному (используем dayRevenue, которая теперь УЧИТЫВАЕТ скидки)
            if (assignment.mainAdminId && weeklyPayrollData[assignment.mainAdminId]) {
                const basePay = 500;
                const bonusPercent = assignment.helperAdminId ? 0.08 : 0.15;
                const bonus = dayRevenue * bonusPercent;
                weeklyPayrollData[assignment.mainAdminId].total += basePay + bonus;
            }

             // Начисление помощнику (используем dayRevenue, которая теперь УЧИТЫВАЕТ скидки)
            if (assignment.helperAdminId && weeklyPayrollData[assignment.helperAdminId] && assignment.helperHours) {
                const hours = parseInt(assignment.helperHours) || 0;
                if (hours > 0) {
                    const basePay = hours * 150;
                    const bonusPercent = 0.07;
                    const bonus = dayRevenue * bonusPercent;
                    weeklyPayrollData[assignment.helperAdminId].total += basePay + bonus;
                }
            }
         });

        renderWeeklyPayroll(weeklyPayrollData, previousWeek);
    }


    // === Отображение Зарплаты за Прошлую Неделю ===
    function renderWeeklyPayroll(payrollData, weekRange) {
        weeklyPayrollResultsEl.innerHTML = ''; // Очистка

        if (!weekRange) {
             weeklyPayrollPeriodEl.textContent = 'Расчет периода...';
             weeklyPayrollResultsEl.innerHTML = '<p class="italic text-yellow-600">Нет данных</p>';
             return;
        }

        const options = { day: '2-digit', month: 'short' };
        weeklyPayrollPeriodEl.textContent = `(с ${weekRange.start.toLocaleDateString('ru-RU', options)} по ${weekRange.end.toLocaleDateString('ru-RU', options)})`;

        let hasData = false;
        admins.forEach(admin => {
            const data = payrollData[admin.id];
            if (data && data.total > 0) {
                hasData = true;
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center';
                div.innerHTML = `
                    <span>${data.name}:</span>
                    <span class="font-semibold text-yellow-800">${data.total.toLocaleString('ru-RU', { maximumFractionDigits: 0 })} ₽</span>
                `;
                weeklyPayrollResultsEl.appendChild(div);
            }
        });

        if (!hasData) {
            weeklyPayrollResultsEl.innerHTML = '<p class="italic text-yellow-600">Нет начислений за прошлую неделю.</p>';
        }
    }

    // === Логика Модального Окна Деталей Дня ===
    function showDayDetailsModal(dayBookings, date) {
        const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric', weekday: 'long' });
        dayDetailsTitle.textContent = `Записи на ${dateStr}`;
        dayDetailsContent.innerHTML = ''; // Очищаем содержимое

        if (dayBookings.length === 0) {
            dayDetailsContent.innerHTML = '<p class="text-center text-gray-500 italic">На этот день нет записей.</p>';
        } else {
            dayBookings.forEach(b => {
                const bookingCard = document.createElement('div');
                bookingCard.className = 'border border-gray-200 rounded-xl p-4 shadow-sm';

                // Формируем блок информации о клиенте
                let clientHTML = `<div class="font-semibold text-lg mb-1">${b.clientName}</div>`;
                if (b.clientPhone) {
                    let cleanPhone = b.clientPhone.replace(/\D/g, '');
                    if (cleanPhone.startsWith('7') || cleanPhone.startsWith('8')) {
                        cleanPhone = cleanPhone.substring(1);
                    }
                    const formattedPhone = formatPhoneNumber(b.clientPhone);
                    clientHTML += `<div class="text-sm mb-2"><a href="tel:+7${cleanPhone}" class="text-blue-600 hover:text-blue-800 hover:underline">${formattedPhone}</a></div>`;
                }

                // Формируем блок времени и длительности
                const timeHTML = `<div class="text-sm text-gray-700 mb-2"><span class="font-medium">Время:</span> ${b.startTime} (${b.duration} ч)</div>`;

                // Формируем блок услуг
                 let serviceLabels = 'Не указаны';
                 if (b.selectedServices && Array.isArray(b.selectedServices) && b.selectedServices.length > 0) {
                     serviceLabels = b.selectedServices.map(serviceKey => getServiceLabel(serviceKey)).join(', ');
                 } else if (b.serviceType) { // Обратная совместимость
                     serviceLabels = getServiceLabel(b.serviceType);
                 }
                const servicesHTML = `<div class="text-sm text-gray-700 mb-2"><span class="font-medium">Услуги:</span> ${serviceLabels}</div>`;

                // --- Добавляем Финансовую информацию ---
                let financialHTML = '';
                // Пересчитываем сумму до скидки
                let totalAmount = 0;
                const duration = parseFloat(b.duration) || 0;
                if (b.selectedServices && Array.isArray(b.selectedServices)) {
                     b.selectedServices.forEach(service => {
                       if (service === 'birthday') {
                         const fullHours = Math.floor(duration);
                         const hasHalfHour = duration % 1 !== 0;
                         let birthdayTotal = 0;
                         for (let hour = 1; hour <= fullHours; hour++) {
                           const hourPrice = servicePrices.birthday[hour] || servicePrices.birthday[4] || 3000;
                           birthdayTotal += hourPrice;
                         }
                         if (hasHalfHour) {
                            if (fullHours === 0) { birthdayTotal += 2000; }
                            else if (fullHours === 1) { birthdayTotal += 2000; }
                            else { birthdayTotal += (servicePrices.birthday[3] || 3000) / 2; }
                         }
                         totalAmount += birthdayTotal;
                       } else {
                         const price = servicePrices[service] || 0;
                         totalAmount += price * duration;
                       }
                     });
                }

                // Рассчитываем итоговую стоимость с учетом скидки
                const discountPercent = b.discountPercent || 0;
                const discountAmount = b.discountAmount || 0;
                let finalAmount = totalAmount;
                let discountText = 'Нет';
                if (discountPercent > 0) {
                  finalAmount = totalAmount * (1 - discountPercent / 100);
                  discountText = `${discountPercent}%`;
                } else if (discountAmount > 0) {
                  finalAmount = Math.max(0, totalAmount - discountAmount);
                  discountText = `${discountAmount.toLocaleString('ru-RU')} ₽`;
                }

                financialHTML = `
                  <div class="grid grid-cols-3 gap-x-4 text-sm mt-3 pt-3 border-t border-gray-100">
                    <div><span class="font-medium">Сумма:</span> ${totalAmount.toLocaleString('ru-RU')} ₽</div>
                    <div><span class="font-medium">Скидка:</span> ${discountText}</div>
                    <div><span class="font-medium">Итого:</span> ${finalAmount.toLocaleString('ru-RU', { maximumFractionDigits: 0 })} ₽</div>
                  </div>
                `;
                // --- Конец Финансовой информации ---

                // Формируем блок примечаний
                let notesHTML = '';
                if (b.notes) {
                    notesHTML = `<div class="text-sm text-gray-500 italic whitespace-pre-wrap break-words border-t border-gray-100 pt-2 mt-2"><span class="font-medium text-gray-700 not-italic">Примечания:</span> ${b.notes}</div>`;
                }

                // Находим назначение на этот день ОДИН РАЗ
                const assignmentDateStr = formatDateSafe(date);
                const assignment = adminAssignments.find(a => a.date === assignmentDateStr);
                let assignmentHTML = '';
                if (assignment) {
                    const mainAdmin = admins.find(a => a.id === assignment.mainAdminId);
                    const helperAdmin = assignment.helperAdminId ? admins.find(a => a.id === assignment.helperAdminId) : null;
                    assignmentHTML = '<div class="text-xs text-gray-500 mt-1">Смена: ';
                    if (mainAdmin) assignmentHTML += `👑 ${mainAdmin.name}`;
                    if (helperAdmin) assignmentHTML += ` / 🛠️ ${helperAdmin.name}${assignment.helperHours ? ' (' + assignment.helperHours + 'ч)' : ''}`;
                    assignmentHTML += '</div>';
                }

                // Собираем карточку
                bookingCard.innerHTML = clientHTML + timeHTML + servicesHTML + financialHTML + assignmentHTML + notesHTML;

                // --- Добавляем Кнопки действий (только для админа) ---
                if (isAdmin) {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'flex items-center space-x-3 mt-3 pt-3 border-t border-gray-100';

                    const editBtn = document.createElement('button');
                    editBtn.type = 'button';
                    editBtn.className = 'text-blue-600 hover:text-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-400 rounded p-1 text-sm inline-flex items-center';
                    editBtn.innerHTML = '<i class="fas fa-edit fa-fw mr-1"></i> Редакт.';
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        dayDetailsModal.classList.add('hidden'); // Закрываем текущее окно
                        openEditModal(b.id); // Открываем окно редактирования
                     });

                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-red-400 rounded p-1 text-sm inline-flex items-center';
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt fa-fw mr-1"></i> Удалить';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm(`Вы уверены, что хотите удалить запись для "${b.clientName}"?`)) {
                            dayDetailsModal.classList.add('hidden'); // Закрываем текущее окно
                            deleteBooking(b.id);
                        }
                    });

                    actionsDiv.appendChild(editBtn);
                    actionsDiv.appendChild(deleteBtn);
                    bookingCard.appendChild(actionsDiv);
                }
                // --- Конец Кнопок действий ---

                dayDetailsContent.appendChild(bookingCard);
            });
        }

        dayDetailsModal.classList.remove('hidden');
    }

  </script>
</body>
</html>
