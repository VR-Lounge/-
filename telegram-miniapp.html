<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>VR Lounge - –ó–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ Telegram</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
    }
    
    .service-tag {
      border: 2px solid #e5e7eb;
      border-radius: 1rem;
      padding: 0.75rem;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      width: 100%;
    }
    
    .service-tag.selected {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    
    .service-tag.selected .service-tag-line1 span {
      color: #1e40af !important;
      font-weight: 600;
    }
    
    .service-tag-line1 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #111827;
    }
    
    .service-tag-price {
      font-size: 0.875rem;
      color: #6b7280;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —à–∞–ø–∫–∏ */
    .header-blue {
      border-bottom-left-radius: 1.0rem;
      border-bottom-right-radius: 1.0rem;
    }
    
    /* –í–∏–¥–∏–º—ã–π –∫—É—Ä—Å–æ—Ä –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞ */
    input[type="text"],
    input[type="tel"],
    input[type="number"],
    textarea {
      caret-color: #3b82f6;
    }
    
    /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª—è—Ö –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ */
    input[type="date"],
    input[type="time"] {
      text-align: left !important;
      padding-left: 1rem !important;
      padding-right: 1rem !important;
    }
    
    /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≤ select */
    select {
      text-align: left !important;
      padding-left: 1rem !important;
      padding-right: 1rem !important;
    }
    
    /* –û—Ç—Å—Ç—É–ø—ã —Å–ø—Ä–∞–≤–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
    input[type="text"],
    input[type="tel"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    select,
    textarea {
      padding-right: 1.5rem !important;
    }
    
    /* –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –¥–ª—è –ø–æ–ª–µ–π –ú–µ—Ç–æ–¥ –∏ –î–∞—Ç–∞ –≤ —Å–µ–∫—Ü–∏–∏ –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ */
    #prepayAmount,
    #prepayMethod,
    #prepayDate {
      min-height: 2.75rem !important;
      padding-top: 0.625rem !important;
      padding-bottom: 0.625rem !important;
      height: auto;
    }
    
    /* –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã—Å–æ—Ç—ã –¥–ª—è –ø–æ–ª–µ–π –î–∞—Ç–∞, –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞, –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ */
    #bookingDate,
    #startTime,
    #duration {
      min-height: 3rem;
      padding-top: 0.75rem !important;
      padding-bottom: 0.75rem !important;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator {
      opacity: 1;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="min-h-screen bg-gray-50 pb-20">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="bg-blue-600 text-white p-4 z-10 shadow-md header-blue">
      <h1 class="text-xl font-bold text-center">üìù –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞</h1>
    </div>

    <!-- –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <form id="bookingForm" class="p-4 pr-8 space-y-4 max-w-lg mx-auto">
      <!-- –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ -->
      <div>
        <label for="clientName" class="block text-gray-900 font-semibold mb-2">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
        <input type="text" id="clientName" name="clientName" required 
          class="w-full rounded-2xl border border-gray-300 px-4 py-3 text-gray-900 text-left placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none" 
          placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞" />
      </div>

      <!-- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
      <div>
        <label for="clientPhone" class="block text-gray-900 font-semibold mb-2">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
        <input type="tel" id="clientPhone" name="clientPhone" required 
          class="w-full rounded-2xl border border-gray-300 px-4 py-3 text-gray-900 text-left placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none" 
          placeholder="+7 (XXX) XXX-XX-XX" />
      </div>

      <!-- –î–∞—Ç–∞ -->
      <div>
        <label for="bookingDate" class="block text-gray-900 font-semibold mb-2">–î–∞—Ç–∞</label>
        <input type="date" id="bookingDate" name="bookingDate" required 
          class="w-full rounded-2xl border border-gray-300 px-4 py-3 text-gray-900 text-left focus:ring-2 focus:ring-blue-500 focus:outline-none" />
      </div>

      <!-- –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ -->
      <div>
        <label for="startTime" class="block text-gray-900 font-semibold mb-2">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
        <select id="startTime" name="startTime" required 
          class="w-full rounded-2xl border border-gray-300 px-4 py-3 text-gray-900 text-left focus:ring-2 focus:ring-blue-500 focus:outline-none">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</option>
          <!-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </select>
        <div id="timeSlotsInfo" class="text-xs text-gray-500 mt-1 hidden"></div>
      </div>

      <!-- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
      <div>
        <label for="duration" class="block text-gray-900 font-semibold mb-2">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—á–∞—Å—ã)</label>
        <select id="duration" name="duration" required 
          class="w-full rounded-2xl border border-gray-300 px-4 py-3 text-gray-900 text-left focus:ring-2 focus:ring-blue-500 focus:outline-none">
          <option value="0.5">0.5</option>
          <option value="1" selected>1</option>
          <option value="1.5">1.5</option>
          <option value="2">2</option>
          <option value="2.5">2.5</option>
          <option value="3">3</option>
          <option value="3.5">3.5</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
        </select>
      </div>

      <!-- –£—Å–ª—É–≥–∏ -->
      <div>
        <label class="block text-gray-900 font-semibold mb-2">–£—Å–ª—É–≥–∏</label>
        <div id="servicesContainer" class="space-y-2">
          <!-- –£—Å–ª—É–≥–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>

      <!-- –°—É–º–º–∞ -->
      <div>
        <label class="block text-gray-900 font-semibold mb-2">–°—É–º–º–∞</label>
        <input type="text" id="totalAmount" readonly 
          class="w-full rounded-2xl border border-gray-300 px-4 py-3 text-gray-900 bg-gray-50" 
          value="0 ‚ÇΩ">
      </div>

      <!-- –°–∫–∏–¥–∫–∞ -->
      <div>
        <label class="block text-gray-900 font-semibold mb-2">–°–∫–∏–¥–∫–∞</label>
        <div class="flex items-center space-x-2">
          <input type="number" id="discountPercent" min="0" max="100" 
            class="w-1/2 rounded-2xl border border-gray-300 px-4 py-3 text-gray-900" 
            placeholder="%">
          <span class="text-gray-500">–∏–ª–∏</span>
          <input type="number" id="discountAmount" min="0" 
            class="w-1/2 rounded-2xl border border-gray-300 px-4 py-3 text-gray-900" 
            placeholder="‚ÇΩ">
        </div>
      </div>

      <!-- –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ -->
      <div class="grid grid-cols-3 gap-2">
        <div class="flex-1">
          <label class="block text-gray-900 font-semibold mb-2 text-sm">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
          <input type="number" id="prepayAmount" min="0" 
            class="w-full rounded-2xl border border-gray-300 px-3 py-2 text-gray-900 text-sm text-left" 
            placeholder="0">
        </div>
        <div class="flex-1">
          <label class="block text-gray-900 font-semibold mb-2 text-sm">–ú–µ—Ç–æ–¥</label>
          <select id="prepayMethod" 
            class="w-full rounded-2xl border border-gray-300 px-3 py-2 text-gray-900 text-sm text-left">
            <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
            <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>
          </select>
        </div>
        <div class="flex-1">
          <label class="block text-gray-900 font-semibold mb-2 text-sm">–î–∞—Ç–∞</label>
          <input type="date" id="prepayDate" 
            class="w-full rounded-2xl border border-gray-300 px-3 py-2 text-gray-900 text-sm text-left">
        </div>
      </div>

      <!-- –î–æ–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏ -->
      <div>
        <label class="block text-gray-900 font-semibold mb-2">–î–æ–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏ (‚ÇΩ)</label>
        <div class="grid grid-cols-2 gap-2">
          <input type="number" id="finalPayAmountCash" min="0" 
            class="w-full rounded-2xl border border-gray-300 px-4 py-3 text-gray-900 text-left" 
            placeholder="0">
          <input type="date" id="finalPayDateCash" 
            class="w-full rounded-2xl border border-gray-300 px-4 py-3 text-gray-900 text-left">
        </div>
      </div>

      <!-- –î–æ–ø–ª–∞—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–º -->
      <div>
        <label class="block text-gray-900 font-semibold mb-2">–î–æ–ø–ª–∞—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–º (‚ÇΩ)</label>
        <div class="grid grid-cols-2 gap-2">
          <input type="number" id="finalPayAmountTransfer" min="0" 
            class="w-full rounded-2xl border border-gray-300 px-4 py-3 text-gray-900 text-left" 
            placeholder="0">
          <input type="date" id="finalPayDateTransfer" 
            class="w-full rounded-2xl border border-gray-300 px-4 py-3 text-gray-900 text-left">
        </div>
      </div>

      <!-- –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∏ —É—Å–ª–æ–≤–∏—è -->
      <div id="calculationDetails" class="hidden">
        <label class="block text-gray-900 font-semibold mb-2">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞</label>
        <div id="calculationDetailsContent" class="bg-blue-50 border border-blue-200 rounded-2xl p-4 text-sm space-y-2">
          <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>

      <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å -->
      <div>
        <label class="block text-gray-900 font-semibold mb-2">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
        <input type="text" id="finalAmount" readonly 
          class="w-full rounded-2xl border border-gray-300 px-4 py-3 text-gray-900 bg-gray-50 font-semibold" 
          value="0 ‚ÇΩ">
      </div>

      <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏—è -->
      <div>
        <label for="notes" class="block text-gray-900 font-semibold mb-2">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
        <textarea id="notes" name="notes" rows="3" 
          placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è" 
          class="w-full rounded-2xl border border-gray-300 px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none"></textarea>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
      <button type="submit" 
        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-semibold transition shadow-lg">
        ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
      </button>
    </form>

    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–µ -->
    <div id="message" class="fixed top-20 left-4 right-4 bg-green-500 text-white p-4 rounded-2xl shadow-lg hidden z-50">
      <p id="messageText"></p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, query, where, getDocs, updateDoc, doc, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBaq_faWwfE_TXn4Xh_2U3GYSAsUzGJ1bk",
      authDomain: "vr-lounge33.firebaseapp.com",
      projectId: "vr-lounge33",
      storageBucket: "vr-lounge33.appspot.com",
      messagingSenderId: "825655988090",
      appId: "1:825655988090:web:76d8e0554b8601f8bd10c3"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Telegram Web App API
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
    const user = tg.initDataUnsafe?.user;
    const userId = user?.id?.toString();
    const username = user?.username ? `@${user.username}` : null;
    const firstName = user?.first_name || '';

    console.log('Telegram User:', user);

    // –¶–µ–Ω—ã —É—Å–ª—É–≥ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å CRM)
    const servicePrices = {
      weekday_ps1: 150,
      weekday_ps2: 300,
      weekday_vr1: 500,
      weekday_vr2: 1000,
      weekday_vr3: 1500,
      weekday_vr4: 2000,
      weekend_vr1: 750,
      weekend_vr2: 1500,
      weekend_vr3: 2250,
      weekend_vr4: 3000,
      xbox_kinnect: 500,
      xbox1: 250,
      xbox2: 500,
      xbox3: 750,
      xbox4: 1000,
      karaoke: 1000,
      board_games: 500,
      hostess: 2000,
      birthday: {
        1: 4000, 2: 3500, 3: 3000, 4: 3000, 5: 3000,
        6: 3000, 7: 3000, 8: 3000, 9: 3000, 10: 3000,
        11: 3000, 12: 3000
      }
    };

    // –ù–∞–∑–≤–∞–Ω–∏—è —É—Å–ª—É–≥
    const serviceLabels = {
      weekday_ps1: 'PS5 (1 –¥–∂–æ–π—Å—Ç–∏–∫)',
      weekday_ps2: 'PS5 (2 –¥–∂–æ–π—Å—Ç–∏–∫–∞)',
      weekday_vr1: 'VR –æ—á–∫–∏ (1 —à—Ç.) | –ë—É–¥–Ω–∏',
      weekday_vr2: 'VR –æ—á–∫–∏ (2 —à—Ç.) | –ë—É–¥–Ω–∏',
      weekday_vr3: 'VR –æ—á–∫–∏ (3 —à—Ç.) | –ë—É–¥–Ω–∏',
      weekday_vr4: 'VR –æ—á–∫–∏ (4 —à—Ç.) | –ë—É–¥–Ω–∏',
      weekend_vr1: 'VR –æ—á–∫–∏ (1 —à—Ç.) | –í—ã—Ö–æ–¥–Ω—ã–µ',
      weekend_vr2: 'VR –æ—á–∫–∏ (2 —à—Ç.) | –í—ã—Ö–æ–¥–Ω—ã–µ',
      weekend_vr3: 'VR –æ—á–∫–∏ (3 —à—Ç.) | –í—ã—Ö–æ–¥–Ω—ã–µ',
      weekend_vr4: 'VR –æ—á–∫–∏ (4 —à—Ç.) | –í—ã—Ö–æ–¥–Ω—ã–µ',
      xbox_kinnect: 'X-Box Kinnect (–¥–æ 8 —á–µ–ª.)',
      xbox1: 'X-Box (1 –¥–∂–æ–π—Å—Ç–∏–∫)',
      xbox2: 'X-Box (2 –¥–∂–æ–π—Å—Ç–∏–∫–∞)',
      xbox3: 'X-Box (3 –¥–∂–æ–π—Å—Ç–∏–∫–∞)',
      xbox4: 'X-Box (4 –¥–∂–æ–π—Å—Ç–∏–∫–∞)',
      karaoke: '–ö–∞—Ä–∞–æ–∫–µ',
      board_games: '–ù–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã',
      hostess: '–í–µ–¥—É—â–∞—è',
      birthday: '–ê—Ä–µ–Ω–¥–∞ –≤—Å–µ–≥–æ (–î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è)'
    };

    // –ò–∫–æ–Ω–∫–∏ —É—Å–ª—É–≥
    const serviceIcons = {
      weekday_ps1: 'fa-gamepad',
      weekday_ps2: 'fa-gamepad',
      weekday_vr1: 'fa-vr-cardboard',
      weekday_vr2: 'fa-vr-cardboard',
      weekday_vr3: 'fa-vr-cardboard',
      weekday_vr4: 'fa-vr-cardboard',
      weekend_vr1: 'fa-vr-cardboard',
      weekend_vr2: 'fa-vr-cardboard',
      weekend_vr3: 'fa-vr-cardboard',
      weekend_vr4: 'fa-vr-cardboard',
      xbox_kinnect: 'fa-child',
      xbox1: 'fa-gamepad',
      xbox2: 'fa-gamepad',
      xbox3: 'fa-gamepad',
      xbox4: 'fa-gamepad',
      karaoke: 'fa-microphone',
      board_games: 'fa-dice-d6',
      hostess: 'fa-user-tie',
      birthday: 'fa-birthday-cake'
    };

    // –¶–≤–µ—Ç–∞ –∏–∫–æ–Ω–æ–∫
    const serviceColors = {
      weekday_ps1: 'text-indigo-600',
      weekday_ps2: 'text-indigo-600',
      weekday_vr1: 'text-blue-600',
      weekday_vr2: 'text-blue-600',
      weekday_vr3: 'text-blue-600',
      weekday_vr4: 'text-blue-600',
      weekend_vr1: 'text-blue-600',
      weekend_vr2: 'text-blue-600',
      weekend_vr3: 'text-blue-600',
      weekend_vr4: 'text-blue-600',
      xbox_kinnect: 'text-orange-600',
      xbox1: 'text-green-600',
      xbox2: 'text-green-600',
      xbox3: 'text-green-600',
      xbox4: 'text-green-600',
      karaoke: 'text-pink-600',
      board_games: 'text-purple-600',
      hostess: 'text-pink-600',
      birthday: 'text-red-600'
    };

    // –í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏
    const selectedServices = new Set();
    
    // –ó–∞–Ω—è—Ç—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã (–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ Firebase)
    let bookedTimeSlots = [];

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è
    function isWeekend(dateStr) {
      const date = new Date(dateStr);
      const day = date.getDay();
      return day === 0 || day === 6;
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function formatPhone(phone) {
      const digits = phone.replace(/\D/g, '');
      if (digits.startsWith('8')) {
        return '7' + digits.substring(1);
      }
      if (!digits.startsWith('7')) {
        return '7' + digits;
      }
      return digits;
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function formatPhoneDisplay(phoneDigits) {
      if (phoneDigits.length < 11) return phoneDigits;
      return `+7 (${phoneDigits.substring(1, 4)}) ${phoneDigits.substring(4, 7)}-${phoneDigits.substring(7, 9)}-${phoneDigits.substring(9, 11)}`;
    }

    // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π
    function calculateTotal() {
      const duration = parseFloat(document.getElementById('duration').value) || 0;
      const bookingDate = document.getElementById('bookingDate').value;
      const isWeekendDay = isWeekend(bookingDate);
      
      let total = 0;
      const calculationDetails = [];

      console.log('üîç –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏. –í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏:', Array.from(selectedServices));
      console.log('‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:', duration);
      
      selectedServices.forEach(service => {
        console.log(`üì¶ –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ª—É–≥–∏: ${service}`);
        if (service === 'birthday') {
          const fullHours = Math.floor(duration);
          const hasHalfHour = duration % 1 !== 0;
          let birthdayTotal = 0;
          const hourDetails = [];
          
          console.log(`üéÇ –î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è: –ø–æ–ª–Ω—ã—Ö —á–∞—Å–æ–≤=${fullHours}, –µ—Å—Ç—å –ø–æ–ª—á–∞—Å–∞=${hasHalfHour}`);
          
          for (let hour = 1; hour <= fullHours; hour++) {
            const hourPrice = servicePrices.birthday[hour] || servicePrices.birthday[4] || 3000;
            birthdayTotal += hourPrice;
            hourDetails.push(`–ß–∞—Å ${hour}: ${hourPrice.toLocaleString('ru-RU')} ‚ÇΩ`);
            console.log(`  –ß–∞—Å ${hour}: ${hourPrice} ‚ÇΩ (—Å—É–º–º–∞: ${birthdayTotal})`);
          }
          
          if (hasHalfHour) {
            let halfHourPrice = 0;
            if (fullHours === 0) {
              halfHourPrice = 2000;
              hourDetails.push(`0.5 —á–∞—Å–∞: ${halfHourPrice.toLocaleString('ru-RU')} ‚ÇΩ`);
            } else if (fullHours === 1) {
              halfHourPrice = 2000;
              hourDetails.push(`+0.5 —á–∞—Å–∞: ${halfHourPrice.toLocaleString('ru-RU')} ‚ÇΩ`);
            } else {
              halfHourPrice = (servicePrices.birthday[3] || 3000) / 2;
              hourDetails.push(`+0.5 —á–∞—Å–∞: ${halfHourPrice.toLocaleString('ru-RU')} ‚ÇΩ`);
            }
            birthdayTotal += halfHourPrice;
          }
          
          calculationDetails.push({
            service: 'birthday',
            label: serviceLabels[service],
            details: hourDetails,
            total: birthdayTotal,
            conditions: [
              '–í —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Ö–æ–¥–∏—Ç –∞—Ä–µ–Ω–¥–∞ –≤—Å–µ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è:',
              '‚Ä¢ VR –æ—á–∫–∏',
              '‚Ä¢ PS –∫–æ–º–Ω–∞—Ç–∞',
              '‚Ä¢ –ö–∞—Ä–∞–æ–∫–µ',
              '‚Ä¢ –ö–∏–Ω–æ',
              '‚Ä¢ XBOX 360',
              '‚Ä¢ –¢–∞–Ω—Ü—ã –≤ XBOX',
              '‚Ä¢ –ò–≥—Ä—ã –Ω–∞ –ü–ö',
              '',
              '–ú–æ–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å —Å–≤–æ—é –µ–¥—É –∏ –Ω–∞–ø–∏—Ç–∫–∏'
            ]
          });
          
          console.log(`‚úÖ –ò—Ç–æ–≥–æ –∑–∞ –î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è: ${birthdayTotal} ‚ÇΩ`);
          total += birthdayTotal;
        } else if (service === 'hostess') {
          const hostessPrice = servicePrices.hostess;
          total += hostessPrice;
          calculationDetails.push({
            service: 'hostess',
            label: serviceLabels[service],
            details: [`${hostessPrice.toLocaleString('ru-RU')} ‚ÇΩ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)`],
            total: hostessPrice,
            conditions: [
              '–í–µ–¥—É—â–∞—è —Å–æ–∑–¥–∞—ë—Ç –æ–±—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –ø–æ–∑–¥—Ä–∞–≤–ª—è–µ—Ç –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–∞,',
              '—É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∫–æ–Ω–∫—É—Ä—Å—ã, —É–≤–ª–µ–∫–∞–µ—Ç, –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤—ã–≤–∞–µ—Ç –∏ –ø–æ–º–æ–≥–∞–µ—Ç –≥–æ—Å—Ç—è–º.',
              '–û—Å–æ–±–µ–Ω–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è –¥–µ—Ç—Å–∫–∏—Ö –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤!'
            ]
          });
        } else {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—É–¥–Ω–∏–π –∏–ª–∏ –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å –¥–ª—è VR —É—Å–ª—É–≥
          let serviceKey = service;
          if (service.includes('vr') && isWeekendDay && !service.includes('weekend')) {
            serviceKey = service.replace('weekday', 'weekend');
          } else if (service.includes('vr') && !isWeekendDay && !service.includes('weekday')) {
            serviceKey = service.replace('weekend', 'weekday');
          }
          const price = servicePrices[serviceKey] || servicePrices[service] || 0;
          const serviceTotal = price * duration;
          total += serviceTotal;
          
          calculationDetails.push({
            service: service,
            label: serviceLabels[service] || service,
            details: [`${price.toLocaleString('ru-RU')} ‚ÇΩ/—á–∞—Å √ó ${duration} —á = ${serviceTotal.toLocaleString('ru-RU')} ‚ÇΩ`],
            total: serviceTotal,
            conditions: null
          });
        }
      });

      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫–∏
      const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
      const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
      
      const totalBeforeDiscount = total; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É–º–º—É –¥–æ —Å–∫–∏–¥–∫–∏
      let discountApplied = 0;
      
      if (discountPercent > 0) {
        discountApplied = total * (discountPercent / 100);
        total = total * (1 - discountPercent / 100);
      } else if (discountAmount > 0) {
        discountApplied = discountAmount;
        total = Math.max(0, total - discountAmount);
      }

      console.log(`üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: ${total} ‚ÇΩ (–¥–æ —Å–∫–∏–¥–∫–∏: ${totalBeforeDiscount} ‚ÇΩ)`);
      
      return {
        total: Math.round(total),
        details: calculationDetails,
        discountApplied: Math.round(discountApplied),
        totalBeforeDiscount: Math.round(totalBeforeDiscount)
      };
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–Ω—è—Ç—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –∏–∑ Firebase
    async function loadBookedTimeSlots(selectedDate) {
      if (!selectedDate) return;
      
      try {
        const bookingsQuery = query(
          collection(db, 'bookings'),
          where('bookingDate', '==', selectedDate)
        );
        const bookingsSnapshot = await getDocs(bookingsQuery);
        
        bookedTimeSlots = [];
        bookingsSnapshot.forEach(doc => {
          const booking = doc.data();
          if (booking.startTime && booking.duration) {
            const startTime = booking.startTime;
            const duration = parseFloat(booking.duration) || 0;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
            const [startHours, startMinutes] = startTime.split(':').map(Number);
            const startDateTime = new Date();
            startDateTime.setHours(startHours, startMinutes, 0, 0);
            const endDateTime = new Date(startDateTime.getTime() + duration * 60 * 60 * 1000);
            const endTime = `${endDateTime.getHours().toString().padStart(2, '0')}:${endDateTime.getMinutes().toString().padStart(2, '0')}`;
            
            bookedTimeSlots.push({
              start: startTime,
              end: endTime,
              duration: duration,
              clientName: booking.clientName || '–ö–ª–∏–µ–Ω—Ç'
            });
          }
        });
        
        console.log('üìÖ –ó–∞–Ω—è—Ç—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã:', bookedTimeSlots);
        updateTimeSlots(selectedDate);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–Ω—è—Ç—ã—Ö —Å–ª–æ—Ç–æ–≤:', error);
        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã
        updateTimeSlots(selectedDate);
      }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
    function updateTimeSlots(selectedDate) {
      const startTimeSelect = document.getElementById('startTime');
      const timeSlotsInfo = document.getElementById('timeSlotsInfo');
      
      if (!selectedDate) {
        startTimeSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</option>';
        return;
      }
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–Ω—è –Ω–µ–¥–µ–ª–∏
      const date = new Date(selectedDate);
      const dayOfWeek = date.getDay();
      const isWeekendDay = dayOfWeek === 0 || dayOfWeek === 6;
      
      let workStartHour, workEndHour;
      if (isWeekendDay) {
        // –°–±-–í—Å: 12-21
        workStartHour = 12;
        workEndHour = 21;
      } else {
        // –ü–Ω-–ü—Ç: 15-20
        workStartHour = 15;
        workEndHour = 20;
      }
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã —Å —à–∞–≥–æ–º 30 –º–∏–Ω—É—Ç
      const availableSlots = [];
      const selectedDuration = parseFloat(document.getElementById('duration').value) || 1;
      
      for (let hour = workStartHour; hour < workEndHour; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è –ª–∏ —ç—Ç–æ—Ç —Å–ª–æ—Ç —Å –∑–∞–Ω—è—Ç—ã–º–∏ (—Å —É—á–µ—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
          const isAvailable = !isTimeSlotBooked(timeStr, selectedDuration);
          
          if (isAvailable) {
            availableSlots.push(timeStr);
          }
        }
      }
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º select
      startTimeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</option>';
      if (availableSlots.length === 0) {
        startTimeSelect.innerHTML += '<option value="" disabled>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤</option>';
        timeSlotsInfo.textContent = '‚ùå –ù–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤';
        timeSlotsInfo.classList.remove('hidden');
      } else {
        availableSlots.forEach(slot => {
          const option = document.createElement('option');
          option.value = slot;
          option.textContent = slot;
          startTimeSelect.appendChild(option);
        });
        
        const bookedCount = bookedTimeSlots.length;
        if (bookedCount > 0) {
          timeSlotsInfo.textContent = `‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ ${availableSlots.length} —Å–ª–æ—Ç–æ–≤. –ó–∞–Ω—è—Ç–æ: ${bookedCount}`;
          timeSlotsInfo.classList.remove('hidden');
        } else {
          timeSlotsInfo.classList.add('hidden');
        }
      }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–Ω—è—Ç –ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å–ª–æ—Ç (—Å —É—á–µ—Ç–æ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
    function isTimeSlotBooked(startTime, duration = 1) {
      if (!startTime || bookedTimeSlots.length === 0) return false;
      
      const [startHours, startMinutes] = startTime.split(':').map(Number);
      const requestedStart = startHours * 60 + startMinutes;
      const requestedEnd = requestedStart + duration * 60;
      
      return bookedTimeSlots.some(slot => {
        const [slotStartHours, slotStartMinutes] = slot.start.split(':').map(Number);
        const [slotEndHours, slotEndMinutes] = slot.end.split(':').map(Number);
        const slotStart = slotStartHours * 60 + slotStartMinutes;
        const slotEnd = slotEndHours * 60 + slotEndMinutes;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤:
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å –∑–∞–Ω—è—Ç—ã–º, –µ—Å–ª–∏:
        // - –Ω–∞—á–∞–ª–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–æ–≥–æ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –∑–∞–Ω—è—Ç—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –ò–õ–ò
        // - –∫–æ–Ω–µ—Ü –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–æ–≥–æ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –∑–∞–Ω—è—Ç—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –ò–õ–ò
        // - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–Ω—è—Ç—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
        return (requestedStart >= slotStart && requestedStart < slotEnd) ||
               (requestedEnd > slotStart && requestedEnd <= slotEnd) ||
               (requestedStart <= slotStart && requestedEnd >= slotEnd);
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    function updateTotal() {
      const calculation = calculateTotal();
      const total = calculation.total;
      const details = calculation.details;
      const discountApplied = calculation.discountApplied;
      const totalBeforeDiscount = calculation.totalBeforeDiscount;
      
      document.getElementById('totalAmount').value = totalBeforeDiscount.toLocaleString('ru-RU') + ' ‚ÇΩ';
      
      const prepayAmount = parseFloat(document.getElementById('prepayAmount').value) || 0;
      const finalPayCash = parseFloat(document.getElementById('finalPayAmountCash').value) || 0;
      const finalPayTransfer = parseFloat(document.getElementById('finalPayAmountTransfer').value) || 0;
      
      const finalTotal = total - prepayAmount - finalPayCash - finalPayTransfer;
      document.getElementById('finalAmount').value = finalTotal.toLocaleString('ru-RU') + ' ‚ÇΩ';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é —Ä–∞—Å—á–µ—Ç–∞
      updateCalculationDetails(details, discountApplied, totalBeforeDiscount, total);
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞
    function updateCalculationDetails(details, discountApplied, totalBeforeDiscount, totalAfterDiscount) {
      const detailsContainer = document.getElementById('calculationDetails');
      const detailsContent = document.getElementById('calculationDetailsContent');
      
      if (details.length === 0) {
        detailsContainer.classList.add('hidden');
        return;
      }
      
      detailsContainer.classList.remove('hidden');
      
      let html = '';
      
      details.forEach((item, index) => {
        html += `<div class="mb-4 ${index > 0 ? 'border-t border-blue-300 pt-3' : ''}">`;
        html += `<div class="font-semibold text-blue-900 mb-2">${item.label}</div>`;
        
        // –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞ –ø–æ —á–∞—Å–∞–º/—É—Å–ª—É–≥–∞–º
        html += `<div class="text-gray-700 mb-2">`;
        item.details.forEach(detail => {
          html += `<div class="ml-2">${detail}</div>`;
        });
        html += `</div>`;
        
        html += `<div class="font-semibold text-blue-800">–ò—Ç–æ–≥–æ: ${item.total.toLocaleString('ru-RU')} ‚ÇΩ</div>`;
        
        // –£—Å–ª–æ–≤–∏—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –î–Ω—è –†–æ–∂–¥–µ–Ω–∏—è –∏ –í–µ–¥—É—â–µ–π)
        if (item.conditions && item.conditions.length > 0) {
          html += `<div class="mt-2 pt-2 border-t border-blue-200 text-gray-600 text-xs">`;
          item.conditions.forEach(condition => {
            html += `<div class="ml-1">${condition}</div>`;
          });
          html += `</div>`;
        }
        
        html += `</div>`;
      });
      
      // –û–±—â–∞—è —Å—É–º–º–∞ –¥–æ —Å–∫–∏–¥–∫–∏
      if (discountApplied > 0) {
        html += `<div class="border-t-2 border-blue-400 pt-3 mt-3">`;
        html += `<div class="text-gray-700">–°—É–º–º–∞ –¥–æ —Å–∫–∏–¥–∫–∏: ${totalBeforeDiscount.toLocaleString('ru-RU')} ‚ÇΩ</div>`;
        html += `<div class="text-red-600 font-semibold">–°–∫–∏–¥–∫–∞: -${discountApplied.toLocaleString('ru-RU')} ‚ÇΩ</div>`;
        html += `<div class="text-blue-900 font-bold text-lg mt-1">–ò—Ç–æ–≥–æ: ${totalAfterDiscount.toLocaleString('ru-RU')} ‚ÇΩ</div>`;
        html += `</div>`;
      } else {
        html += `<div class="border-t-2 border-blue-400 pt-3 mt-3">`;
        html += `<div class="text-blue-900 font-bold text-lg">–ò—Ç–æ–≥–æ: ${totalAfterDiscount.toLocaleString('ru-RU')} ‚ÇΩ</div>`;
        html += `</div>`;
      }
      
      detailsContent.innerHTML = html;
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —É—Å–ª—É–≥
    function renderServices() {
      const container = document.getElementById('servicesContainer');
      const bookingDate = document.getElementById('bookingDate').value;
      const isWeekendDay = isWeekend(bookingDate);

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏
      const availableServices = isWeekendDay
        ? ['weekend_vr1', 'weekend_vr2', 'weekend_vr3', 'weekend_vr4', 'weekday_ps1', 'weekday_ps2', 'xbox_kinnect', 'xbox1', 'xbox2', 'xbox3', 'xbox4', 'karaoke', 'board_games', 'hostess', 'birthday']
        : ['weekday_vr1', 'weekday_vr2', 'weekday_vr3', 'weekday_vr4', 'weekday_ps1', 'weekday_ps2', 'xbox_kinnect', 'xbox1', 'xbox2', 'xbox3', 'xbox4', 'karaoke', 'board_games', 'hostess', 'birthday'];

      container.innerHTML = '';

      availableServices.forEach(service => {
        const isSelected = selectedServices.has(service);
        const label = serviceLabels[service] || service;
        const icon = serviceIcons[service] || 'fa-circle';
        const color = serviceColors[service] || 'text-gray-600';
        const price = servicePrices[service] || (service === 'birthday' ? '–æ—Ç 3000' : '0');

        const button = document.createElement('button');
        button.type = 'button';
        button.className = `service-tag ${isSelected ? 'selected' : ''}`;
        button.dataset.service = service;
        
        button.innerHTML = `
          <div class="service-tag-line1">
            <i class="fas ${icon} ${color}"></i>
            <span>${label}</span>
          </div>
          <div class="service-tag-price">${service === 'hostess' ? '2000 ‚ÇΩ' : service === 'birthday' ? '–æ—Ç 3000 ‚ÇΩ/—á–∞—Å' : price + ' ‚ÇΩ/—á–∞—Å'}</div>
        `;

        button.addEventListener('click', () => {
          const wasSelected = selectedServices.has(service);
          if (wasSelected) {
            selectedServices.delete(service);
            button.classList.remove('selected');
            console.log(`‚ùå –£—Å–ª—É–≥–∞ "${label}" —É–¥–∞–ª–µ–Ω–∞. –í—Å–µ–≥–æ –≤—ã–±—Ä–∞–Ω–æ: ${selectedServices.size}`);
          } else {
            selectedServices.add(service);
            button.classList.add('selected');
            console.log(`‚úÖ –£—Å–ª—É–≥–∞ "${label}" –¥–æ–±–∞–≤–ª–µ–Ω–∞. –í—Å–µ–≥–æ –≤—ã–±—Ä–∞–Ω–æ: ${selectedServices.size}`);
          }
          updateTotal();
        });

        container.appendChild(button);
      });
    }

    // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    function showMessage(text, isError = false) {
      const messageEl = document.getElementById('message');
      const messageTextEl = document.getElementById('messageText');
      messageTextEl.textContent = text;
      messageEl.className = `fixed top-20 left-4 right-4 p-4 rounded-2xl shadow-lg z-50 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`;
      messageEl.classList.remove('hidden');
      
      setTimeout(() => {
        messageEl.classList.add('hidden');
      }, 3000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    function initForm() {
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–µ–≥–æ–¥–Ω—è)
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      document.getElementById('bookingDate').value = dateStr;

      // –í—Ä–µ–º—è –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤

      // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram, –∑–∞–ø–æ–ª–Ω—è–µ–º –∏–º—è
      if (firstName) {
        document.getElementById('clientName').value = firstName;
      }

      // –†–µ–Ω–¥–µ—Ä–∏–º —É—Å–ª—É–≥–∏
      renderServices();
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
      loadBookedTimeSlots(document.getElementById('bookingDate').value);

      // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
      document.getElementById('bookingDate').addEventListener('change', (e) => {
        const selectedDate = e.target.value;
        renderServices(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —É—Å–ª—É–≥–∏ (—Å–æ—Ö—Ä–∞–Ω—è—è –≤—ã–±—Ä–∞–Ω–Ω—ã–µ)
        updateTotal();
        loadBookedTimeSlots(selectedDate); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ —Å–ª–æ—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π –¥–∞—Ç—ã
      });

      document.getElementById('duration').addEventListener('change', () => {
        updateTotal();
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ —Å —É—á–µ—Ç–æ–º –Ω–æ–≤–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const selectedDate = document.getElementById('bookingDate').value;
        if (selectedDate) {
          updateTimeSlots(selectedDate);
        }
      });
      document.getElementById('discountPercent').addEventListener('input', updateTotal);
      document.getElementById('discountAmount').addEventListener('input', updateTotal);
      document.getElementById('prepayAmount').addEventListener('input', updateTotal);
      document.getElementById('finalPayAmountCash').addEventListener('input', updateTotal);
      document.getElementById('finalPayAmountTransfer').addEventListener('input', updateTotal);

      // –ú–∞—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      const phoneInput = document.getElementById('clientPhone');
      phoneInput.value = '+7 (';
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
      let lastValue = '+7 (';
      let lastCursorPosition = 4;
      
      phoneInput.addEventListener('input', (e) => {
        const input = e.target;
        const currentValue = input.value;
        const cursorPosition = input.selectionStart;
        
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—è–µ—Ç —Å–∏–º–≤–æ–ª—ã (–∑–Ω–∞—á–µ–Ω–∏–µ —É–º–µ–Ω—å—à–∏–ª–æ—Å—å)
        if (currentValue.length < lastValue.length) {
          // –ï—Å–ª–∏ –ø—ã—Ç–∞—é—Ç—Å—è —É–¥–∞–ª–∏—Ç—å —á–∞—Å—Ç—å –º–∞—Å–∫–∏ "+7 (", –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ–º —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –¥–æ "+7 ("
          if (currentValue.length <= 4) {
            if (!currentValue.startsWith('+7 (')) {
              input.value = '+7 (';
              input.setSelectionRange(4, 4);
            } else {
              // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ "+7 (", –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
              input.value = '+7 (';
              input.setSelectionRange(4, 4);
            }
            lastValue = '+7 (';
            lastCursorPosition = 4;
            return;
          }
          
          // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —á–∞—Å—Ç—å –Ω–æ–º–µ—Ä–∞, –ø–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Ü–∏—Ñ—Ä—ã
          let digits = currentValue.replace(/\D/g, '');
          if (digits.startsWith('8')) {
            digits = '7' + digits.substring(1);
          }
          if (!digits.startsWith('7')) {
            digits = '7' + digits;
          }
          if (digits.length > 11) digits = digits.substring(0, 11);
          
          // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ 2 —Ü–∏—Ñ—Ä (—Ç–æ–ª—å–∫–æ "7"), –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å–∫—É
          if (digits.length <= 1) {
            input.value = '+7 (';
            input.setSelectionRange(4, 4);
            lastValue = '+7 (';
            lastCursorPosition = 4;
            return;
          }
          
          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–∞–Ω–æ–≤–æ
          let formatted = '+7 (';
          if (digits.length > 1) {
            formatted += digits.substring(1, Math.min(4, digits.length));
            if (digits.length >= 4) {
              formatted += ') ' + digits.substring(4, Math.min(7, digits.length));
              if (digits.length >= 7) {
                formatted += '-' + digits.substring(7, Math.min(9, digits.length));
                if (digits.length >= 9) {
                  formatted += '-' + digits.substring(9, Math.min(11, digits.length));
                }
              }
            }
          }
          
          input.value = formatted;
          
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞ —Å —É—á–µ—Ç–æ–º —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
          const deletedChars = lastValue.length - currentValue.length;
          let newCursorPos = Math.max(4, cursorPosition - deletedChars);
          
          // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –ø–æ–ø–∞–ª –≤ —Å–µ—Ä–µ–¥–∏–Ω—É —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—â–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
          if (formatted.length < newCursorPos) {
            newCursorPos = formatted.length;
          }
          
          input.setSelectionRange(newCursorPos, newCursorPos);
          lastValue = formatted;
          lastCursorPosition = newCursorPos;
          return;
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å—Ç–∞–≤–∫–∏/–≤–≤–æ–¥–∞ –Ω–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
        let value = currentValue.replace(/\D/g, '');
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤–≤–æ–¥–∞ (–≤–∫–ª—é—á–∞—è –≤—Å—Ç–∞–≤–∫—É –∏–∑ –±—É—Ñ–µ—Ä–∞)
        if (value.startsWith('8')) {
          value = '7' + value.substring(1);
        }
        if (!value.startsWith('7')) {
          value = '7' + value;
        }
        if (value.length > 11) value = value.substring(0, 11);
        
        // –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ "7", –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å–∫—É
        if (value.length <= 1) {
          input.value = '+7 (';
          input.setSelectionRange(4, 4);
          lastValue = '+7 (';
          lastCursorPosition = 4;
          return;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä
        let formatted = '+7 (';
        if (value.length > 1) {
          formatted += value.substring(1, Math.min(4, value.length));
          if (value.length >= 4) {
            formatted += ') ' + value.substring(4, Math.min(7, value.length));
            if (value.length >= 7) {
              formatted += '-' + value.substring(7, Math.min(9, value.length));
              if (value.length >= 9) {
                formatted += '-' + value.substring(9, Math.min(11, value.length));
              }
            }
          }
        }
        
        input.value = formatted;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
        let newCursorPos = formatted.length;
        if (cursorPosition < currentValue.length) {
          // –ö—É—Ä—Å–æ—Ä –±—ã–ª –Ω–µ –≤ –∫–æ–Ω—Ü–µ - –ø—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
          const digitsBeforeCursor = currentValue.substring(0, cursorPosition).replace(/\D/g, '').length;
          let pos = 4; // –ù–∞—á–∏–Ω–∞–µ–º –ø–æ—Å–ª–µ "+7 ("
          if (digitsBeforeCursor > 0) {
            pos += Math.min(3, digitsBeforeCursor - 1); // –¶–∏—Ñ—Ä—ã –∫–æ–¥–∞
            if (digitsBeforeCursor > 3) {
              pos += 2; // ") "
              pos += Math.min(3, digitsBeforeCursor - 3); // –°–ª–µ–¥—É—é—â–∏–µ 3 —Ü–∏—Ñ—Ä—ã
              if (digitsBeforeCursor > 6) {
                pos += 1; // "-"
                pos += Math.min(2, digitsBeforeCursor - 6); // –°–ª–µ–¥—É—é—â–∏–µ 2 —Ü–∏—Ñ—Ä—ã
                if (digitsBeforeCursor > 8) {
                  pos += 1; // "-"
                  pos += Math.min(2, digitsBeforeCursor - 8); // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Ü–∏—Ñ—Ä—ã
                }
              }
            }
          }
          newCursorPos = Math.min(pos, formatted.length);
        }
        
        input.setSelectionRange(newCursorPos, newCursorPos);
        lastValue = formatted;
        lastCursorPosition = newCursorPos;
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π —É–¥–∞–ª–µ–Ω–∏—è (Backspace, Delete)
      phoneInput.addEventListener('keydown', (e) => {
        const input = e.target;
        const cursorPosition = input.selectionStart;
        const value = input.value;
        
        // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ Backspace –∏–ª–∏ Delete –∏ –∫—É—Ä—Å–æ—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ –º–∞—Å–∫–∏ "+7 ("
        if ((e.key === 'Backspace' || e.key === 'Delete') && cursorPosition <= 4) {
          e.preventDefault();
          return;
        }
        
        // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ Backspace –∏ –∫—É—Ä—Å–æ—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ "+7 (", –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ–º —É–¥–∞–ª—è—Ç—å
        if (e.key === 'Backspace' && cursorPosition === 4 && value.startsWith('+7 (')) {
          e.preventDefault();
          return;
        }
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞ (Ctrl+V, Cmd+V)
      phoneInput.addEventListener('paste', (e) => {
        e.preventDefault();
        const input = e.target;
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        
        console.log('üìã –í—Å—Ç–∞–≤–ª–µ–Ω —Ç–µ–∫—Å—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞:', pastedText);
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏–∑ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        let digits = pastedText.replace(/\D/g, '');
        
        console.log('üî¢ –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Ü–∏—Ñ—Ä—ã:', digits);
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
        if (digits.startsWith('8')) {
          digits = '7' + digits.substring(1);
        }
        if (!digits.startsWith('7')) {
          digits = '7' + digits;
        }
        if (digits.length > 11) {
          digits = digits.substring(0, 11);
        }
        
        console.log('‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ü–∏—Ñ—Ä—ã:', digits);
        
        // –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ "7" –∏–ª–∏ –º–µ–Ω—å—à–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å–∫—É
        if (digits.length <= 1) {
          input.value = '+7 (';
          input.setSelectionRange(4, 4);
          lastValue = '+7 (';
          lastCursorPosition = 4;
          console.log('‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ü–∏—Ñ—Ä, –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –º–∞—Å–∫–∞');
          return;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä
        let formatted = '+7 (';
        if (digits.length > 1) {
          formatted += digits.substring(1, Math.min(4, digits.length));
          if (digits.length >= 4) {
            formatted += ') ' + digits.substring(4, Math.min(7, digits.length));
            if (digits.length >= 7) {
              formatted += '-' + digits.substring(7, Math.min(9, digits.length));
              if (digits.length >= 9) {
                formatted += '-' + digits.substring(9, Math.min(11, digits.length));
              }
            }
          }
        }
        
        console.log('üìû –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä:', formatted);
        
        input.value = formatted;
        input.setSelectionRange(formatted.length, formatted.length);
        lastValue = formatted;
        lastCursorPosition = formatted.length;
      });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const clientName = document.getElementById('clientName').value.trim();
      const clientPhone = document.getElementById('clientPhone').value.trim();
      const bookingDate = document.getElementById('bookingDate').value;
      const startTime = document.getElementById('startTime').value;
      const duration = parseFloat(document.getElementById('duration').value);
      const notes = document.getElementById('notes').value.trim();

      // –í–∞–ª–∏–¥–∞—Ü–∏—è
      if (!clientName) {
        showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞', true);
        return;
      }

      if (selectedServices.size === 0) {
        showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É', true);
        return;
      }

      // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      const phoneDigits = formatPhone(clientPhone);
      if (phoneDigits.length < 11) {
        showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', true);
        return;
      }

      const formattedPhone = formatPhoneDisplay(phoneDigits);

      // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—á–µ—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—É–º–º—ã
      const calculation = calculateTotal();
      const totalAmount = calculation.totalBeforeDiscount; // –°—É–º–º–∞ –¥–æ —Å–∫–∏–¥–∫–∏

      // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
      const bookingData = {
        clientName: clientName,
        clientPhone: formattedPhone,
        bookingDate: bookingDate,
        startTime: startTime,
        duration: duration,
        selectedServices: Array.from(selectedServices),
        notes: notes,
        discountPercent: parseFloat(document.getElementById('discountPercent').value) || 0,
        discountAmount: parseFloat(document.getElementById('discountAmount').value) || 0,
        prepayment: {
          amount: parseFloat(document.getElementById('prepayAmount').value) || 0,
          method: document.getElementById('prepayMethod').value || 'cash',
          date: document.getElementById('prepayDate').value || null
        },
        finalPaymentCash: {
          amount: parseFloat(document.getElementById('finalPayAmountCash').value) || 0,
          date: document.getElementById('finalPayDateCash').value || null
        },
        finalPaymentTransfer: {
          amount: parseFloat(document.getElementById('finalPayAmountTransfer').value) || 0,
          date: document.getElementById('finalPayDateTransfer').value || null,
          notes: '–ü–µ—Ä–µ–≤–æ–¥'
        },
        createdAt: Timestamp.now(),
        source: 'admin_miniapp'
      };

      try {
        // –õ–æ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', bookingData);
        console.log('–í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏:', Array.from(selectedServices));
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
        await addDoc(collection(db, 'bookings'), bookingData);
        console.log('‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ bookings');

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞
        console.log('–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É:', phoneDigits);
        const clientsQuery = query(
          collection(db, 'clients'),
          where('phoneDigits', '==', phoneDigits)
        );
        const clientsSnapshot = await getDocs(clientsQuery);
        console.log('–ù–∞–π–¥–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤:', clientsSnapshot.size);

        if (!clientsSnapshot.empty) {
          // –ö–ª–∏–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          const clientDoc = clientsSnapshot.docs[0];
          const clientData = clientDoc.data();
          
          await updateDoc(clientDoc.ref, {
            lastBookingDate: bookingDate,
            totalBookings: (clientData.totalBookings || 0) + 1,
            totalSpent: (clientData.totalSpent || 0) + calculation.total,
            telegramId: userId || clientData.telegramId,
            telegramUsername: username || clientData.telegramUsername
          });
          console.log('‚úÖ –ö–ª–∏–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω');
        } else {
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
          await addDoc(collection(db, 'clients'), {
            clientName: clientName,
            clientPhone: formattedPhone,
            phoneDigits: phoneDigits,
            telegramId: userId,
            telegramUsername: username,
            createdAt: Timestamp.now(),
            lastBookingDate: bookingDate,
            totalBookings: 1,
            totalSpent: calculation.total,
            isActive: true
          });
          console.log('‚úÖ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω');
        }

        console.log('‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');
        showMessage('‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º Mini App —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          tg.close();
        }, 2000);

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', {
          code: error.code,
          message: error.message,
          stack: error.stack
        });
        
        // –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏. ';
        if (error.code === 'permission-denied') {
          errorMessage += '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firestore –≤ Firebase Console.';
        } else if (error.code === 'unavailable') {
          errorMessage += '–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.';
        } else {
          errorMessage += `–ö–æ–¥ –æ—à–∏–±–∫–∏: ${error.code || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12).`;
        }
        
        showMessage(errorMessage, true);
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    initForm();
  </script>
</body>
</html>

