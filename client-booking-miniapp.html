<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>VR Lounge - –ó–∞–ø–∏—Å–∞—Ç—å—Å—è</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, query, where, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBaq_faWwfE_TXn4Xh_2U3GYSAsUzGJ1bk",
      authDomain: "vr-lounge33.firebaseapp.com",
      projectId: "vr-lounge33",
      storageBucket: "vr-lounge33.appspot.com",
      messagingSenderId: "825655988090",
      appId: "1:825655988090:web:76d8e0554b8601f8bd10c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
    window.addDoc = addDoc;
    window.collection = collection;
    window.getDocs = getDocs;
    window.query = query;
    window.where = where;
    window.Timestamp = Timestamp;
  </script>
  
  <style>
    :root {
      --neon-purple: #a855f7;
      --neon-pink: #ec4899;
      --neon-blue: #3b82f6;
      --neon-cyan: #06b6d4;
      --dark-bg: #0a0a0f;
      --dark-card: #1a1a2e;
    }
    
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, var(--dark-bg) 0%, #1a0a2e 100%);
      color: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .neon-glow {
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.5),
                  0 0 40px rgba(168, 85, 247, 0.3),
                  0 0 60px rgba(168, 85, 247, 0.1);
    }
    
    .neon-text {
      text-shadow: 0 0 10px rgba(168, 85, 247, 0.8),
                   0 0 20px rgba(168, 85, 247, 0.6),
                   0 0 30px rgba(168, 85, 247, 0.4);
    }
    
    .neon-border {
      border: 2px solid var(--neon-purple);
      box-shadow: 0 0 10px rgba(168, 85, 247, 0.5),
                  inset 0 0 10px rgba(168, 85, 247, 0.1);
    }
    
    .service-card {
      background: linear-gradient(135deg, var(--dark-card) 0%, #16213e 100%);
      border: 2px solid transparent;
      border-radius: 1rem;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .service-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(168, 85, 247, 0.3), transparent);
      transition: left 0.5s;
    }
    
    .service-card:hover::before {
      left: 100%;
    }
    
    .service-card.selected {
      border-color: var(--neon-purple);
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.6),
                  0 0 40px rgba(168, 85, 247, 0.4);
      transform: scale(1.02);
    }
    
    .time-slot {
      background: var(--dark-card);
      border: 2px solid rgba(168, 85, 247, 0.3);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    
    .time-slot:hover {
      border-color: var(--neon-purple);
      box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
    }
    
    .time-slot.selected {
      background: linear-gradient(135deg, var(--neon-purple) 0%, var(--neon-pink) 100%);
      border-color: var(--neon-purple);
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.6);
    }
    
    .time-slot.disabled {
      opacity: 0.3;
      cursor: not-allowed;
      border-color: rgba(255, 255, 255, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--neon-purple) 0%, var(--neon-pink) 100%);
      border: none;
      border-radius: 1rem;
      padding: 1rem 2rem;
      font-weight: 600;
      font-size: 1.1rem;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
      width: 100%;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(168, 85, 247, 0.7);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    input, select, textarea {
      background: var(--dark-card);
      border: 2px solid rgba(168, 85, 247, 0.3);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      color: white;
      caret-color: var(--neon-purple);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--neon-purple);
      box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
    }
    
    input::placeholder, textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .card {
      background: linear-gradient(135deg, var(--dark-card) 0%, #16213e 100%);
      border-radius: 1.5rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(168, 85, 247, 0.2);
    }
    
    .header {
      background: linear-gradient(135deg, var(--neon-purple) 0%, var(--neon-pink) 100%);
      padding: 1.5rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(168, 85, 247, 0.3);
      border-radius: 50%;
      border-top-color: var(--neon-purple);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .success-message {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      padding: 1rem;
      border-radius: 1rem;
      text-align: center;
      margin: 1rem 0;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }
    
    .error-message {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      padding: 1rem;
      border-radius: 1rem;
      text-align: center;
      margin: 1rem 0;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
    }
  </style>
</head>
<body>
  <div class="min-h-screen pb-24">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="header">
      <h1 class="text-2xl font-bold neon-text">üéÆ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –≤ VR Lounge</h1>
      <p class="text-sm mt-1 opacity-90">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è</p>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div id="messageContainer" class="p-4"></div>

    <!-- –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <form id="bookingForm" class="p-4 space-y-6 max-w-lg mx-auto">
      <!-- –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ -->
      <div class="card">
        <label for="clientName" class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-user"></i> –í–∞—à–µ –∏–º—è
        </label>
        <input type="text" id="clientName" name="clientName" required 
          class="w-full" 
          placeholder="–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?" />
      </div>

      <!-- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
      <div class="card">
        <label for="clientPhone" class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-phone"></i> –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        </label>
        <input type="tel" id="clientPhone" name="clientPhone" required 
          class="w-full" 
          placeholder="+7 (XXX) XXX-XX-XX" />
      </div>

      <!-- –£—Å–ª—É–≥–∏ -->
      <div class="card">
        <label class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-gamepad"></i> –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É
        </label>
        <div id="servicesContainer" class="grid grid-cols-1 gap-3">
          <!-- –£—Å–ª—É–≥–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>

      <!-- –î–∞—Ç–∞ -->
      <div class="card">
        <label for="bookingDate" class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-calendar"></i> –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É
        </label>
        <input type="date" id="bookingDate" name="bookingDate" required 
          class="w-full" />
      </div>

      <!-- –í—Ä–µ–º—è -->
      <div class="card">
        <label class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-clock"></i> –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è
        </label>
        <div id="timeSlotsContainer" class="grid grid-cols-3 gap-2">
          <!-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        <p id="workingHoursInfo" class="text-xs mt-3 text-purple-300 opacity-75"></p>
      </div>

      <!-- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
      <div class="card">
        <label for="duration" class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-hourglass-half"></i> –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        </label>
        <select id="duration" name="duration" required class="w-full">
          <option value="0.5">30 –º–∏–Ω—É—Ç</option>
          <option value="1" selected>1 —á–∞—Å</option>
          <option value="1.5">1.5 —á–∞—Å–∞</option>
          <option value="2">2 —á–∞—Å–∞</option>
          <option value="2.5">2.5 —á–∞—Å–∞</option>
          <option value="3">3 —á–∞—Å–∞</option>
          <option value="4">4 —á–∞—Å–∞</option>
          <option value="5">5 —á–∞—Å–æ–≤</option>
        </select>
      </div>

      <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏—è -->
      <div class="card">
        <label for="notes" class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-sticky-note"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
        </label>
        <textarea id="notes" name="notes" rows="3" 
          class="w-full" 
          placeholder="–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è, –ø–æ–≤–æ–¥ –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è –∏ —Ç.–¥."></textarea>
      </div>

      <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å -->
      <div class="card neon-border">
        <div class="flex justify-between items-center">
          <span class="text-lg font-semibold">–ò—Ç–æ–≥–æ:</span>
          <span id="totalAmount" class="text-2xl font-bold text-purple-300 neon-text">0 ‚ÇΩ</span>
        </div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
      <button type="submit" id="submitBtn" class="btn-primary">
        <i class="fas fa-check-circle"></i> –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
      </button>
    </form>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
    const user = tg.initDataUnsafe?.user;
    const userName = user?.first_name || '';
    const userPhone = user?.phone_number || '';

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
    if (userName && document.getElementById('clientName')) {
      document.getElementById('clientName').value = userName;
    }

    // –ú–∞—Å–∫–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    const phoneInput = document.getElementById('clientPhone');
    if (phoneInput) {
      phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.startsWith('7') || value.startsWith('8')) {
          value = value.substring(1);
        }
        value = value.substring(0, 10);
        
        let formatted = '+7';
        if (value.length > 0) {
          formatted += ' (' + value.substring(0, 3);
          if (value.length >= 4) {
            formatted += ') ' + value.substring(3, 6);
            if (value.length >= 7) {
              formatted += '-' + value.substring(6, 8);
              if (value.length >= 9) {
                formatted += '-' + value.substring(8, 10);
              }
            }
          }
        }
        e.target.value = formatted;
      });
    }

    // –¶–µ–Ω—ã —É—Å–ª—É–≥
    const servicePrices = {
      weekday_ps1: 150,
      weekday_ps2: 300,
      weekday_vr1: 500,
      weekday_vr2: 1000,
      weekday_vr3: 1500,
      weekday_vr4: 2000,
      weekend_vr1: 750,
      weekend_vr2: 1500,
      weekend_vr3: 2250,
      weekend_vr4: 3000,
      xbox_kinnect: 500,
      xbox1: 250,
      xbox2: 500,
      xbox3: 750,
      xbox4: 1000,
      karaoke: 1000,
      board_games: 500,
      hostess: 2000,
      birthday: {
        1: 4000, 2: 3500, 3: 3000, 4: 3000, 5: 3000,
        6: 3000, 7: 3000, 8: 3000, 9: 3000, 10: 3000,
        11: 3000, 12: 3000
      }
    };

    // –ù–∞–∑–≤–∞–Ω–∏—è —É—Å–ª—É–≥
    const serviceLabels = {
      weekday_ps1: 'PS5 (1 –¥–∂–æ–π—Å—Ç–∏–∫)',
      weekday_ps2: 'PS5 (2 –¥–∂–æ–π—Å—Ç–∏–∫–∞)',
      weekday_vr1: 'VR –æ—á–∫–∏ (1 —à—Ç.)',
      weekday_vr2: 'VR –æ—á–∫–∏ (2 —à—Ç.)',
      weekday_vr3: 'VR –æ—á–∫–∏ (3 —à—Ç.)',
      weekday_vr4: 'VR –æ—á–∫–∏ (4 —à—Ç.)',
      weekend_vr1: 'VR –æ—á–∫–∏ (1 —à—Ç.)',
      weekend_vr2: 'VR –æ—á–∫–∏ (2 —à—Ç.)',
      weekend_vr3: 'VR –æ—á–∫–∏ (3 —à—Ç.)',
      weekend_vr4: 'VR –æ—á–∫–∏ (4 —à—Ç.)',
      xbox_kinnect: 'X-Box Kinnect',
      xbox1: 'X-Box (1 –¥–∂–æ–π—Å—Ç–∏–∫)',
      xbox2: 'X-Box (2 –¥–∂–æ–π—Å—Ç–∏–∫–∞)',
      xbox3: 'X-Box (3 –¥–∂–æ–π—Å—Ç–∏–∫–∞)',
      xbox4: 'X-Box (4 –¥–∂–æ–π—Å—Ç–∏–∫–∞)',
      karaoke: '–ö–∞—Ä–∞–æ–∫–µ',
      board_games: '–ù–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã',
      hostess: '–í–µ–¥—É—â–∞—è',
      birthday: '–ê—Ä–µ–Ω–¥–∞ (–î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è)'
    };

    // –ò–∫–æ–Ω–∫–∏ —É—Å–ª—É–≥
    const serviceIcons = {
      weekday_ps1: 'fa-gamepad',
      weekday_ps2: 'fa-gamepad',
      weekday_vr1: 'fa-vr-cardboard',
      weekday_vr2: 'fa-vr-cardboard',
      weekday_vr3: 'fa-vr-cardboard',
      weekday_vr4: 'fa-vr-cardboard',
      weekend_vr1: 'fa-vr-cardboard',
      weekend_vr2: 'fa-vr-cardboard',
      weekend_vr3: 'fa-vr-cardboard',
      weekend_vr4: 'fa-vr-cardboard',
      xbox_kinnect: 'fa-child',
      xbox1: 'fa-gamepad',
      xbox2: 'fa-gamepad',
      xbox3: 'fa-gamepad',
      xbox4: 'fa-gamepad',
      karaoke: 'fa-microphone',
      board_games: 'fa-dice-d6',
      hostess: 'fa-user-tie',
      birthday: 'fa-birthday-cake'
    };

    let selectedService = null;
    let selectedTime = null;
    let bookings = [];

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–∞—Ç–∞ –≤—ã—Ö–æ–¥–Ω—ã–º –¥–Ω–µ–º
    function isWeekend(date) {
      const day = date.getDay();
      return day === 0 || day === 6;
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
    function getWorkingHours(date) {
      const isWeekendDay = isWeekend(date);
      if (isWeekendDay) {
        return { start: 12, end: 21 }; // –°–±-–í—Å: 12-21
      } else {
        return { start: 15, end: 20 }; // –ü–Ω-–ü—Ç: 15-20
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
    async function loadBookings() {
      try {
        const bookingsSnapshot = await window.getDocs(window.collection(window.db, "bookings"));
        bookings = bookingsSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π:', bookings.length);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π:', error);
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–∏
    function isTimeAvailable(date, time, duration) {
      const [hours, minutes] = time.split(':').map(Number);
      const bookingStart = new Date(date);
      bookingStart.setHours(hours, minutes, 0, 0);
      const bookingEnd = new Date(bookingStart.getTime() + duration * 60 * 60 * 1000);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏
      for (const booking of bookings) {
        if (booking.bookingDate === date) {
          const [bHours, bMinutes] = booking.startTime.split(':').map(Number);
          const bStart = new Date(date);
          bStart.setHours(bHours, bMinutes, 0, 0);
          const bEnd = new Date(bStart.getTime() + (booking.duration || 1) * 60 * 60 * 1000);

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
          if (bookingStart < bEnd && bookingEnd > bStart) {
            return false;
          }
        }
      }

      return true;
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
    function generateTimeSlots(date) {
      const container = document.getElementById('timeSlotsContainer');
      const info = document.getElementById('workingHoursInfo');
      if (!container || !date) return;

      const workingHours = getWorkingHours(new Date(date));
      info.textContent = `–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã: ${workingHours.start}:00 - ${workingHours.end}:00`;

      container.innerHTML = '';
      selectedTime = null;

      for (let hour = workingHours.start; hour < workingHours.end; hour++) {
        for (let minute of [0, 30]) {
          if (hour === workingHours.end - 1 && minute === 30) break;
          
          const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          const duration = parseFloat(document.getElementById('duration').value) || 1;
          const isAvailable = isTimeAvailable(date, timeStr, duration);

          const slot = document.createElement('div');
          slot.className = `time-slot ${isAvailable ? '' : 'disabled'}`;
          slot.textContent = timeStr;
          
          if (isAvailable) {
            slot.addEventListener('click', () => {
              document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
              slot.classList.add('selected');
              selectedTime = timeStr;
              updateTotal();
            });
          }
          
          container.appendChild(slot);
        }
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥ (—Å —É—á–µ—Ç–æ–º –¥–Ω—è –Ω–µ–¥–µ–ª–∏)
    function loadServices(date = null) {
      const container = document.getElementById('servicesContainer');
      if (!container) return;

      const isWeekendDay = date ? isWeekend(new Date(date)) : isWeekend(new Date());
      
      const allServices = [
        { id: 'weekday_ps1', label: 'PS5 (1 –¥–∂–æ–π—Å—Ç–∏–∫)', price: 150, icon: 'fa-gamepad', weekday: true },
        { id: 'weekday_ps2', label: 'PS5 (2 –¥–∂–æ–π—Å—Ç–∏–∫–∞)', price: 300, icon: 'fa-gamepad', weekday: true },
        { id: 'weekday_vr1', label: 'VR –æ—á–∫–∏ (1 —à—Ç.)', price: 500, icon: 'fa-vr-cardboard', weekday: true },
        { id: 'weekday_vr2', label: 'VR –æ—á–∫–∏ (2 —à—Ç.)', price: 1000, icon: 'fa-vr-cardboard', weekday: true },
        { id: 'weekday_vr3', label: 'VR –æ—á–∫–∏ (3 —à—Ç.)', price: 1500, icon: 'fa-vr-cardboard', weekday: true },
        { id: 'weekday_vr4', label: 'VR –æ—á–∫–∏ (4 —à—Ç.)', price: 2000, icon: 'fa-vr-cardboard', weekday: true },
        { id: 'weekend_vr1', label: 'VR –æ—á–∫–∏ (1 —à—Ç.)', price: 750, icon: 'fa-vr-cardboard', weekday: false },
        { id: 'weekend_vr2', label: 'VR –æ—á–∫–∏ (2 —à—Ç.)', price: 1500, icon: 'fa-vr-cardboard', weekday: false },
        { id: 'weekend_vr3', label: 'VR –æ—á–∫–∏ (3 —à—Ç.)', price: 2250, icon: 'fa-vr-cardboard', weekday: false },
        { id: 'weekend_vr4', label: 'VR –æ—á–∫–∏ (4 —à—Ç.)', price: 3000, icon: 'fa-vr-cardboard', weekday: false },
        { id: 'xbox_kinnect', label: 'X-Box Kinnect', price: 500, icon: 'fa-child', weekday: null },
        { id: 'xbox1', label: 'X-Box (1 –¥–∂–æ–π—Å—Ç–∏–∫)', price: 250, icon: 'fa-gamepad', weekday: null },
        { id: 'xbox2', label: 'X-Box (2 –¥–∂–æ–π—Å—Ç–∏–∫–∞)', price: 500, icon: 'fa-gamepad', weekday: null },
        { id: 'xbox3', label: 'X-Box (3 –¥–∂–æ–π—Å—Ç–∏–∫–∞)', price: 750, icon: 'fa-gamepad', weekday: null },
        { id: 'xbox4', label: 'X-Box (4 –¥–∂–æ–π—Å—Ç–∏–∫–∞)', price: 1000, icon: 'fa-gamepad', weekday: null },
        { id: 'karaoke', label: '–ö–∞—Ä–∞–æ–∫–µ', price: 1000, icon: 'fa-microphone', weekday: null },
        { id: 'board_games', label: '–ù–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã', price: 500, icon: 'fa-dice-d6', weekday: null },
        { id: 'hostess', label: '–í–µ–¥—É—â–∞—è', price: 2000, icon: 'fa-user-tie', weekday: null },
        { id: 'birthday', label: '–ê—Ä–µ–Ω–¥–∞ (–î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è)', price: 3000, icon: 'fa-birthday-cake', weekday: null }
      ];

      // –§–∏–ª—å—Ç—Ä—É–µ–º —É—Å–ª—É–≥–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–Ω—è –Ω–µ–¥–µ–ª–∏
      const services = allServices.filter(service => {
        if (service.weekday === null) return true; // –£—Å–ª—É–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–≥–¥–∞
        return service.weekday === !isWeekendDay;
      });

      container.innerHTML = '';

      services.forEach(service => {
        const card = document.createElement('div');
        card.className = 'service-card';
        card.dataset.service = service.id;
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <i class="fas ${service.icon} text-2xl text-purple-400"></i>
              <div>
                <div class="font-semibold">${service.label}</div>
                <div class="text-sm text-purple-300 opacity-75">${service.price} ‚ÇΩ/—á–∞—Å</div>
              </div>
            </div>
            <i class="fas fa-check-circle text-purple-400 opacity-0 transition-opacity" style="font-size: 1.5rem;"></i>
          </div>
        `;
        
        card.addEventListener('click', () => {
          document.querySelectorAll('.service-card').forEach(c => {
            c.classList.remove('selected');
            c.querySelector('.fa-check-circle').style.opacity = '0';
          });
          card.classList.add('selected');
          card.querySelector('.fa-check-circle').style.opacity = '1';
          selectedService = service.id;
          updateTotal();
        });
        
        container.appendChild(card);
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    function updateTotal() {
      const totalEl = document.getElementById('totalAmount');
      if (!totalEl || !selectedService) {
        totalEl.textContent = '0 ‚ÇΩ';
        return;
      }

      const duration = parseFloat(document.getElementById('duration').value) || 1;
      let total = 0;

      if (selectedService === 'birthday') {
        const hours = Math.floor(duration);
        total = servicePrices.birthday[Math.min(hours, 12)] || servicePrices.birthday[12];
        if (duration % 1 !== 0) {
          total += (servicePrices.birthday[Math.min(hours + 1, 12)] || servicePrices.birthday[12]) / 2;
        }
      } else if (selectedService === 'hostess') {
        total = servicePrices.hostess;
      } else {
        const price = servicePrices[selectedService] || 0;
        total = price * duration;
      }

      totalEl.textContent = `${Math.round(total).toLocaleString('ru-RU')} ‚ÇΩ`;
    }

    // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    function showMessage(text, type = 'success') {
      const container = document.getElementById('messageContainer');
      const message = document.createElement('div');
      message.className = type === 'success' ? 'success-message' : 'error-message';
      message.textContent = text;
      container.innerHTML = '';
      container.appendChild(message);
      
      setTimeout(() => {
        message.style.opacity = '0';
        message.style.transition = 'opacity 0.3s';
        setTimeout(() => message.remove(), 300);
      }, 5000);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> –û—Ç–ø—Ä–∞–≤–∫–∞...';

      const clientName = document.getElementById('clientName').value.trim();
      const clientPhone = document.getElementById('clientPhone').value.trim();
      const bookingDate = document.getElementById('bookingDate').value;
      const duration = parseFloat(document.getElementById('duration').value);
      const notes = document.getElementById('notes').value.trim();

      if (!clientName || !clientPhone || !bookingDate || !selectedTime || !selectedService) {
        showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–∏
      if (!isTimeAvailable(bookingDate, selectedTime, duration)) {
        showMessage('–≠—Ç–æ –≤—Ä–µ–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è.', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';
        generateTimeSlots(bookingDate);
        return;
      }

      try {
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase
        const phoneDigits = clientPhone.replace(/\D/g, '').substring(1);
        
        const bookingData = {
          clientName,
          clientPhone,
          phoneDigits,
          bookingDate,
          startTime: selectedTime,
          duration,
          selectedServices: [selectedService],
          notes: notes || '',
          createdAt: window.Timestamp.now(),
          source: 'client_miniapp'
        };

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        await window.addDoc(window.collection(window.db, "bookings"), bookingData);

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
        const clientsQuery = window.query(
          window.collection(window.db, "clients"),
          window.where("phoneDigits", "==", phoneDigits)
        );
        const clientsSnapshot = await window.getDocs(clientsQuery);

        if (!clientsSnapshot.empty) {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
          const clientDoc = clientsSnapshot.docs[0];
          const clientData = clientDoc.data();
          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –≤ CRM
        } else {
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
          await window.addDoc(window.collection(window.db, "clients"), {
            clientName,
            clientPhone,
            phoneDigits,
            telegramId: user?.id?.toString() || null,
            telegramUsername: user?.username ? `@${user.username}` : null,
            createdAt: window.Timestamp.now(),
            totalBookings: 0,
            totalSpent: 0,
            isActive: true
          });
        }

        showMessage('‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–∏–Ω–∏-–∞–ø–ø–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          tg.close();
        }, 2000);

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏.', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('bookingDate').addEventListener('change', (e) => {
      const date = e.target.value;
      loadServices(date); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —É—Å–ª—É–≥–∏ —Å —É—á–µ—Ç–æ–º –¥–Ω—è –Ω–µ–¥–µ–ª–∏
      generateTimeSlots(date);
      selectedService = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —É—Å–ª—É–≥–∏
      document.querySelectorAll('.service-card').forEach(c => {
        c.classList.remove('selected');
        c.querySelector('.fa-check-circle').style.opacity = '0';
      });
      updateTotal();
    });

    document.getElementById('duration').addEventListener('change', () => {
      updateTotal();
      const date = document.getElementById('bookingDate').value;
      if (date) {
        generateTimeSlots(date);
      }
    });

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã (—Å–µ–≥–æ–¥–Ω—è)
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('bookingDate').setAttribute('min', today);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    (async () => {
      await loadBookings();
      loadServices();
    })();
  </script>
</body>
</html>

