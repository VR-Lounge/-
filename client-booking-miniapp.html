<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>VR Lounge - –ó–∞–ø–∏—Å–∞—Ç—å—Å—è</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, query, where, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBaq_faWwfE_TXn4Xh_2U3GYSAsUzGJ1bk",
      authDomain: "vr-lounge33.firebaseapp.com",
      projectId: "vr-lounge33",
      storageBucket: "vr-lounge33.appspot.com",
      messagingSenderId: "825655988090",
      appId: "1:825655988090:web:76d8e0554b8601f8bd10c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ window –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    window.db = db;
    window.addDoc = addDoc;
    window.collection = collection;
    window.getDocs = getDocs;
    window.query = query;
    window.where = where;
    window.Timestamp = Timestamp;
    
    // –°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º, —á—Ç–æ Firebase –≥–æ—Ç–æ–≤
    window.firebaseReady = true;
    window.dispatchEvent(new Event('firebaseReady'));
  </script>
  
  <style>
    :root {
      --neon-purple: #a855f7;
      --neon-pink: #ec4899;
      --neon-blue: #3b82f6;
      --neon-cyan: #06b6d4;
      --dark-bg: #0a0a0f;
      --dark-card: #1a1a2e;
    }
    
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, var(--dark-bg) 0%, #1a0a2e 100%);
      color: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .neon-glow {
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.5),
                  0 0 40px rgba(168, 85, 247, 0.3),
                  0 0 60px rgba(168, 85, 247, 0.1);
    }
    
    .neon-text {
      text-shadow: 0 0 10px rgba(168, 85, 247, 0.8),
                   0 0 20px rgba(168, 85, 247, 0.6),
                   0 0 30px rgba(168, 85, 247, 0.4);
    }
    
    .neon-border {
      border: 2px solid var(--neon-purple);
      box-shadow: 0 0 10px rgba(168, 85, 247, 0.5),
                  inset 0 0 10px rgba(168, 85, 247, 0.1);
    }
    
    .service-card {
      background: linear-gradient(135deg, var(--dark-card) 0%, #16213e 100%);
      border: 2px solid transparent;
      border-radius: 1rem;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .service-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(168, 85, 247, 0.3), transparent);
      transition: left 0.5s;
    }
    
    .service-card:hover::before {
      left: 100%;
    }
    
    .service-card.selected {
      border-color: var(--neon-purple);
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.6),
                  0 0 40px rgba(168, 85, 247, 0.4);
      transform: scale(1.02);
    }
    
    .time-slot {
      background: var(--dark-card);
      border: 2px solid rgba(168, 85, 247, 0.3);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    
    .time-slot:hover {
      border-color: var(--neon-purple);
      box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
    }
    
    .time-slot.selected {
      background: linear-gradient(135deg, var(--neon-purple) 0%, var(--neon-pink) 100%);
      border-color: var(--neon-purple);
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.6);
    }
    
    .time-slot.disabled {
      opacity: 0.3;
      cursor: not-allowed;
      border-color: rgba(255, 255, 255, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(18deg, #500a91 0%, #bc2972 100%);
      border: none;
      border-radius: 1rem;
      padding: 1rem 2rem;
      font-weight: 600;
      font-size: 1.1rem;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
      width: 100%;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(168, 85, 247, 0.7);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    input, select, textarea {
      background: var(--dark-card);
      border: 2px solid rgba(168, 85, 247, 0.3);
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      color: white;
      caret-color: var(--neon-purple);
      font-size: 1rem;
      min-height: 3rem;
    }
    
    input[type="date"], input[type="tel"], input[type="text"], select {
      padding: 1rem 1.25rem;
      min-height: 3rem;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--neon-purple);
      box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
    }
    
    input::placeholder, textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .card {
      background: linear-gradient(135deg, var(--dark-card) 0%, #16213e 100%);
      border-radius: 1.5rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(168, 85, 247, 0.2);
    }
    
    .header {
      background: linear-gradient(18deg, #500a91 0%, #bc2972 100%);
      padding: 1.5rem;
      text-align: center;
      z-index: 100;
      border-bottom-right-radius: 1.5rem;
      border-bottom-left-radius: 1.5rem;
      box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 1rem;
    }
    
    .header-logo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: contain;
      flex-shrink: 0;
      box-shadow: 0 0 15px rgba(168, 85, 247, 0.6);
      background: rgba(255, 255, 255, 0.1);
      padding: 5px;
    }
    
    .header-content {
      flex: 1;
      text-align: left;
    }
    
    @media (max-width: 640px) {
      .header {
        flex-direction: row;
        gap: 0.75rem;
        padding: 1rem;
      }
      
      .header-logo {
        width: 70px;
        height: 70px;
      }
      
      .header-content h1 {
        font-size: 1.25rem;
      }
      
      .header-content p {
        font-size: 0.75rem;
      }
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(168, 85, 247, 0.3);
      border-radius: 50%;
      border-top-color: var(--neon-purple);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .success-message {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      padding: 1rem;
      border-radius: 1rem;
      text-align: center;
      margin: 1rem 0;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }
    
    .error-message {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      padding: 1rem;
      border-radius: 1rem;
      text-align: center;
      margin: 1rem 0;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease-out;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 90%;
      width: 400px;
      box-shadow: 0 0 30px rgba(168, 85, 247, 0.5);
      border: 2px solid var(--neon-purple);
      animation: scaleIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: bold;
      margin-bottom: 1rem;
      color: var(--neon-purple);
      text-align: center;
    }
    
    .modal-message {
      color: #fff;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
    
    .modal-button {
      width: 100%;
      padding: 0.75rem;
      background: linear-gradient(18deg, #500a91 0%, #bc2972 100%);
      color: white;
      border: none;
      border-radius: 0.75rem;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .modal-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
    }
    
    .modal-button:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="min-h-screen pb-24">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="header">
      <img src="https://vr-lounge.github.io/-/Logo.png" alt="VR Lounge Logo" class="header-logo" onerror="this.style.display='none'">
      <div class="header-content">
        <h1 class="text-2xl font-bold neon-text">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –≤ VR Lounge</h1>
        <p class="text-sm mt-1 opacity-90">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è</p>
      </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div id="messageContainer" class="p-4"></div>

    <!-- –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <form id="bookingForm" class="p-4 space-y-6 max-w-lg mx-auto">
      <!-- –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ -->
      <div class="card">
        <label for="clientName" class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-user"></i> –í–∞—à–µ –∏–º—è
        </label>
        <input type="text" id="clientName" name="clientName" required 
          class="w-full" 
          placeholder="–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?"
          tabindex="1" />
      </div>

      <!-- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
      <div class="card">
        <label for="clientPhone" class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-phone"></i> –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        </label>
        <input type="tel" id="clientPhone" name="clientPhone" required 
          class="w-full" 
          placeholder="+7 (XXX) XXX-XX-XX"
          tabindex="2" />
      </div>

      <!-- –£—Å–ª—É–≥–∏ -->
      <div class="card">
        <label class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-gamepad"></i> –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É
        </label>
        <div id="servicesContainer" class="grid grid-cols-1 gap-3" tabindex="3">
          <!-- –£—Å–ª—É–≥–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>

      <!-- –î–∞—Ç–∞ -->
      <div class="card">
        <label for="bookingDate" class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-calendar"></i> –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É
        </label>
        <input type="date" id="bookingDate" name="bookingDate" required 
          class="w-full"
          tabindex="4" />
      </div>

      <!-- –í—Ä–µ–º—è -->
      <div class="card">
        <label class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-clock"></i> –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è
        </label>
        <div id="timeSlotsContainer" class="grid grid-cols-3 gap-2" tabindex="5">
          <!-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        <p id="workingHoursInfo" class="text-xs mt-3 text-purple-300 opacity-75"></p>
      </div>

      <!-- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
      <div class="card">
        <label for="duration" class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-hourglass-half"></i> –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        </label>
        <select id="duration" name="duration" required class="w-full" tabindex="6">
          <option value="0.5">30 –º–∏–Ω—É—Ç</option>
          <option value="1" selected>1 —á–∞—Å</option>
          <option value="1.5">1.5 —á–∞—Å–∞</option>
          <option value="2">2 —á–∞—Å–∞</option>
          <option value="2.5">2.5 —á–∞—Å–∞</option>
          <option value="3">3 —á–∞—Å–∞</option>
          <option value="4">4 —á–∞—Å–∞</option>
          <option value="5">5 —á–∞—Å–æ–≤</option>
        </select>
      </div>

      <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏—è -->
      <div class="card">
        <label for="notes" class="block text-sm font-semibold mb-3 text-purple-300">
          <i class="fas fa-sticky-note"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
        </label>
        <textarea id="notes" name="notes" rows="3" 
          class="w-full" 
          placeholder="–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è, –ø–æ–≤–æ–¥ –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è –∏ —Ç.–¥."></textarea>
      </div>

      <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å -->
      <div class="card neon-border">
        <div class="flex justify-between items-center mb-3">
          <span class="text-lg font-semibold">–ò—Ç–æ–≥–æ:</span>
          <span id="totalAmount" class="text-2xl font-bold text-purple-300 neon-text">0 ‚ÇΩ</span>
        </div>
        <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –∏ —É—Å–ª–æ–≤–∏—è -->
        <div id="calculationDetails" class="hidden mt-3 pt-3 border-t border-purple-500/30">
          <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>

      <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö (–Ω–∞–¥ –∫–Ω–æ–ø–∫–æ–π) -->
      <div id="errorMessageContainer" class="mb-4"></div>

      <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
      <button type="submit" id="submitBtn" class="btn-primary">
        <i class="fas fa-check-circle"></i> –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
      </button>
    </form>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö: –≥–æ—Å—Ç–µ–π –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤)
    function getUserData() {
      // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ initDataUnsafe
      let user = tg.initDataUnsafe?.user;
      
      // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ initData (—Ç—Ä–µ–±—É–µ—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏, –Ω–æ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ)
      if (!user && tg.initData) {
        try {
          // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ initData
          const params = new URLSearchParams(tg.initData);
          const userParam = params.get('user');
          if (userParam) {
            user = JSON.parse(decodeURIComponent(userParam));
          }
        } catch (e) {
          console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å initData:', e);
        }
      }
      
      return user;
    }

    const user = getUserData();
    let userName = user?.first_name || '';
    let userPhone = user?.phone_number || '';

    console.log('üë§ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram:', {
      user: user,
      userName: userName,
      userPhone: userPhone,
      hasPhone: !!userPhone
    });

    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ Telegram
    function formatPhoneFromTelegram(phone) {
      if (!phone) return '';
      
      // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
      let digits = phone.replace(/\D/g, '');
      
      // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 7 –∏–ª–∏ 8, —É–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é —Ü–∏—Ñ—Ä—É
      if (digits.startsWith('7') || digits.startsWith('8')) {
        digits = digits.substring(1);
      }
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 10 —Ü–∏—Ñ—Ä
      digits = digits.substring(0, 10);
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
      let formatted = '+7';
      if (digits.length > 0) {
        formatted += ' (' + digits.substring(0, 3);
        if (digits.length >= 4) {
          formatted += ') ' + digits.substring(3, 6);
          if (digits.length >= 7) {
            formatted += '-' + digits.substring(6, 8);
            if (digits.length >= 9) {
              formatted += '-' + digits.substring(8, 10);
            }
          }
        }
      }
      
      return formatted;
    }

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
    function fillUserData() {
      const nameInput = document.getElementById('clientName');
      const phoneInput = document.getElementById('clientPhone');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞ —Å–ª—É—á–∞–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)
      const updatedUser = getUserData();
      if (updatedUser) {
        userName = updatedUser.first_name || userName;
        userPhone = updatedUser.phone_number || userPhone;
      }
      
      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ (–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Telegram)
      if (userName && nameInput && !nameInput.value) {
        nameInput.value = userName;
        console.log('‚úÖ –ò–º—è –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –∏–∑ Telegram:', userName);
      } else if (!userName) {
        console.log('‚ö†Ô∏è –ò–º—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ Telegram –¥–∞–Ω–Ω—ã—Ö');
        console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', {
          user: updatedUser,
          initDataUnsafe: tg.initDataUnsafe
        });
      } else if (nameInput && nameInput.value) {
        console.log('‚ÑπÔ∏è –ü–æ–ª–µ –∏–º–µ–Ω–∏ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ:', nameInput.value);
      }
      
      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑—Ä–µ—à–∏–ª –¥–æ—Å—Ç—É–ø)
      if (userPhone && phoneInput && (!phoneInput.value || phoneInput.value === '+7 (')) {
        const formattedPhone = formatPhoneFromTelegram(userPhone);
        phoneInput.value = formattedPhone;
        console.log('‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω –∑–∞–ø–æ–ª–Ω–µ–Ω –∏–∑ Telegram:', formattedPhone);
      } else if (!userPhone) {
        console.log('‚ö†Ô∏è –¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ Telegram –¥–∞–Ω–Ω—ã—Ö');
        console.log('üí° –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑—Ä–µ—à–∏–ª –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Telegram');
        console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', {
          user: updatedUser,
          hasPhoneNumber: !!updatedUser?.phone_number
        });
      } else if (phoneInput && phoneInput.value && phoneInput.value !== '+7 (') {
        console.log('‚ÑπÔ∏è –ü–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ:', phoneInput.value);
      }
    }

    // –í—ã–∑—ã–≤–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
    function initFillUserData() {
      // –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å—Ä–∞–∑—É
      fillUserData();
      
      // –í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É (–Ω–∞ —Å–ª—É—á–∞–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)
      setTimeout(fillUserData, 300);
      
      // –¢—Ä–µ—Ç—å—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É (–Ω–∞ —Å–ª—É—á–∞–π –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)
      setTimeout(fillUserData, 1000);
    }

    // –í—ã–∑—ã–≤–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFillUserData);
    } else {
      // DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
      initFillUserData();
    }

    // –ú–∞—Å–∫–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    const phoneInput = document.getElementById('clientPhone');
    if (phoneInput) {
      phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.startsWith('7') || value.startsWith('8')) {
          value = value.substring(1);
        }
        value = value.substring(0, 10);
        
        let formatted = '+7';
        if (value.length > 0) {
          formatted += ' (' + value.substring(0, 3);
          if (value.length >= 4) {
            formatted += ') ' + value.substring(3, 6);
            if (value.length >= 7) {
              formatted += '-' + value.substring(6, 8);
              if (value.length >= 9) {
                formatted += '-' + value.substring(8, 10);
              }
            }
          }
        }
        e.target.value = formatted;
      });
    }

    // –¶–µ–Ω—ã —É—Å–ª—É–≥
    const servicePrices = {
      weekday_ps1: 150,
      weekday_ps2: 300,
      weekday_vr1: 500,
      weekday_vr2: 1000,
      weekday_vr3: 1500,
      weekday_vr4: 2000,
      weekend_vr1: 750,
      weekend_vr2: 1500,
      weekend_vr3: 2250,
      weekend_vr4: 3000,
      xbox_kinnect: 500,
      xbox1: 250,
      xbox2: 500,
      xbox3: 750,
      xbox4: 1000,
      karaoke: 1000,
      board_games: 500,
      hostess: 2000,
      birthday: {
        1: 4000, 2: 3500, 3: 3000, 4: 3000, 5: 3000,
        6: 3000, 7: 3000, 8: 3000, 9: 3000, 10: 3000,
        11: 3000, 12: 3000
      }
    };

    // –ù–∞–∑–≤–∞–Ω–∏—è —É—Å–ª—É–≥
    const serviceLabels = {
      weekday_ps1: 'PS5 (1 –¥–∂–æ–π—Å—Ç–∏–∫)',
      weekday_ps2: 'PS5 (2 –¥–∂–æ–π—Å—Ç–∏–∫–∞)',
      weekday_vr1: 'VR –æ—á–∫–∏ (1 —à—Ç.)',
      weekday_vr2: 'VR –æ—á–∫–∏ (2 —à—Ç.)',
      weekday_vr3: 'VR –æ—á–∫–∏ (3 —à—Ç.)',
      weekday_vr4: 'VR –æ—á–∫–∏ (4 —à—Ç.)',
      weekend_vr1: 'VR –æ—á–∫–∏ (1 —à—Ç.)',
      weekend_vr2: 'VR –æ—á–∫–∏ (2 —à—Ç.)',
      weekend_vr3: 'VR –æ—á–∫–∏ (3 —à—Ç.)',
      weekend_vr4: 'VR –æ—á–∫–∏ (4 —à—Ç.)',
      xbox_kinnect: 'X-Box Kinnect',
      xbox1: 'X-Box (1 –¥–∂–æ–π—Å—Ç–∏–∫)',
      xbox2: 'X-Box (2 –¥–∂–æ–π—Å—Ç–∏–∫–∞)',
      xbox3: 'X-Box (3 –¥–∂–æ–π—Å—Ç–∏–∫–∞)',
      xbox4: 'X-Box (4 –¥–∂–æ–π—Å—Ç–∏–∫–∞)',
      karaoke: '–ö–∞—Ä–∞–æ–∫–µ',
      board_games: '–ù–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã',
      hostess: '–í–µ–¥—É—â–∞—è',
      birthday: '–ê—Ä–µ–Ω–¥–∞ (–î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è)'
    };

    // –ò–∫–æ–Ω–∫–∏ —É—Å–ª—É–≥
    const serviceIcons = {
      weekday_ps1: 'fa-gamepad',
      weekday_ps2: 'fa-gamepad',
      weekday_vr1: 'fa-vr-cardboard',
      weekday_vr2: 'fa-vr-cardboard',
      weekday_vr3: 'fa-vr-cardboard',
      weekday_vr4: 'fa-vr-cardboard',
      weekend_vr1: 'fa-vr-cardboard',
      weekend_vr2: 'fa-vr-cardboard',
      weekend_vr3: 'fa-vr-cardboard',
      weekend_vr4: 'fa-vr-cardboard',
      xbox_kinnect: 'fa-child',
      xbox1: 'fa-gamepad',
      xbox2: 'fa-gamepad',
      xbox3: 'fa-gamepad',
      xbox4: 'fa-gamepad',
      karaoke: 'fa-microphone',
      board_games: 'fa-dice-d6',
      hostess: 'fa-user-tie',
      birthday: 'fa-birthday-cake'
    };

    // –í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä)
    let selectedServices = new Set();
    let selectedTime = null;
    let bookings = [];

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–∞—Ç–∞ –≤—ã—Ö–æ–¥–Ω—ã–º –¥–Ω–µ–º
    function isWeekend(date) {
      // –ï—Å–ª–∏ date - —Å—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD, —Å–æ–∑–¥–∞–µ–º Date –æ–±—ä–µ–∫—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
      if (typeof date === 'string') {
        const [year, month, day] = date.split('-').map(Number);
        date = new Date(year, month - 1, day);
      }
      const day = date.getDay();
      return day === 0 || day === 6;
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
    function getWorkingHours(date) {
      const isWeekendDay = isWeekend(date);
      if (isWeekendDay) {
        return { start: 12, end: 21 }; // –°–±-–í—Å: 12-21
      } else {
        return { start: 15, end: 20 }; // –ü–Ω-–ü—Ç: 15-20
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
    async function loadBookings() {
      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Firebase —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
        if (!window.db || !window.collection || !window.query || !window.getDocs) {
          console.warn('‚ö†Ô∏è Firebase —Ñ—É–Ω–∫—Ü–∏–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∂–¥–µ–º...');
          await new Promise(resolve => {
            const checkInterval = setInterval(() => {
              if (window.db && window.collection && window.query && window.getDocs) {
                clearInterval(checkInterval);
                resolve();
              }
            }, 50);
          });
        }
        
        console.log('üìÖ –ó–∞–≥—Ä—É–∑–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∏–∑ Firebase...');
        const bookingsQuery = window.query(
          window.collection(window.db, "bookings")
        );
        const bookingsSnapshot = await window.getDocs(bookingsQuery);
        bookings = bookingsSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π:', bookings.length);
        console.log('üìã –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', bookings);
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π:', error);
        bookings = []; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–∏
    function isTimeAvailable(date, time, duration) {
      const [hours, minutes] = time.split(':').map(Number);
      const bookingStart = new Date(date);
      bookingStart.setHours(hours, minutes, 0, 0);
      const bookingEnd = new Date(bookingStart.getTime() + duration * 60 * 60 * 1000);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏
      for (const booking of bookings) {
        if (booking.bookingDate === date) {
          const [bHours, bMinutes] = booking.startTime.split(':').map(Number);
          const bStart = new Date(date);
          bStart.setHours(bHours, bMinutes, 0, 0);
          const bEnd = new Date(bStart.getTime() + (booking.duration || 1) * 60 * 60 * 1000);

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
          if (bookingStart < bEnd && bookingEnd > bStart) {
            return false;
          }
        }
      }

      return true;
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
    function generateTimeSlots(date) {
      const container = document.getElementById('timeSlotsContainer');
      const info = document.getElementById('workingHoursInfo');
      if (!container || !date) return;

      const workingHours = getWorkingHours(new Date(date));
      info.textContent = `–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã: ${workingHours.start}:00 - ${workingHours.end}:00`;

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
      const savedSelectedTime = selectedTime;

      container.innerHTML = '';
      // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º selectedTime –∑–¥–µ—Å—å, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä

      for (let hour = workingHours.start; hour < workingHours.end; hour++) {
        for (let minute of [0, 30]) {
          if (hour === workingHours.end - 1 && minute === 30) break;
          
          const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          const duration = parseFloat(document.getElementById('duration').value) || 1;
          const isAvailable = isTimeAvailable(date, timeStr, duration);

          const slot = document.createElement('div');
          slot.className = `time-slot ${isAvailable ? '' : 'disabled'}`;
          slot.textContent = timeStr;
          
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞–Ω–æ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ
          if (savedSelectedTime === timeStr && isAvailable) {
            slot.classList.add('selected');
            selectedTime = timeStr;
          }
          
          if (isAvailable) {
            slot.addEventListener('click', () => {
              document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
              slot.classList.add('selected');
              selectedTime = timeStr;
              updateTotal();
            });
          }
          
          container.appendChild(slot);
        }
      }
      
      // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ
      if (savedSelectedTime && !container.querySelector('.time-slot.selected')) {
        selectedTime = null;
        console.log(`‚ö†Ô∏è –í—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è ${savedSelectedTime} –±–æ–ª—å—à–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ, —Å–±—Ä–æ—à–µ–Ω–æ`);
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥ (—Å —É—á–µ—Ç–æ–º –¥–Ω—è –Ω–µ–¥–µ–ª–∏)
    function loadServices(date = null) {
      const container = document.getElementById('servicesContainer');
      if (!container) return;

      // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–∞, –±–µ—Ä–µ–º —Ç–µ–∫—É—â—É—é –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –∏–∑ —Ñ–æ—Ä–º—ã
      if (!date) {
        const dateInput = document.getElementById('bookingDate');
        date = dateInput ? dateInput.value : null;
      }

      // –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
      let isWeekendDay = false;
      if (date) {
        // –ï—Å–ª–∏ date - —Å—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD, —Å–æ–∑–¥–∞–µ–º Date –æ–±—ä–µ–∫—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
        if (typeof date === 'string') {
          const [year, month, day] = date.split('-').map(Number);
          const dateObj = new Date(year, month - 1, day);
          isWeekendDay = isWeekend(dateObj);
        } else {
          isWeekendDay = isWeekend(date);
        }
      } else {
        isWeekendDay = isWeekend(new Date());
      }
      
      console.log('üìÖ –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥:', {
        date: date,
        isWeekendDay: isWeekendDay,
        selectedServicesBefore: Array.from(selectedServices)
      });
      
      // –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ä—ã—Ö ID —É—Å–ª—É–≥ –Ω–∞ –Ω–æ–≤—ã–µ (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–Ω—è –Ω–µ–¥–µ–ª–∏)
      const serviceMapping = {
        'weekday_ps1': 'weekday_ps1',
        'weekday_ps2': 'weekday_ps2',
        'weekday_vr1': isWeekendDay ? 'weekend_vr1' : 'weekday_vr1',
        'weekday_vr2': isWeekendDay ? 'weekend_vr2' : 'weekday_vr2',
        'weekday_vr3': isWeekendDay ? 'weekend_vr3' : 'weekday_vr3',
        'weekday_vr4': isWeekendDay ? 'weekend_vr4' : 'weekday_vr4',
        'weekend_vr1': isWeekendDay ? 'weekend_vr1' : 'weekday_vr1',
        'weekend_vr2': isWeekendDay ? 'weekend_vr2' : 'weekday_vr2',
        'weekend_vr3': isWeekendDay ? 'weekend_vr3' : 'weekday_vr3',
        'weekend_vr4': isWeekendDay ? 'weekend_vr4' : 'weekday_vr4',
        'xbox_kinnect': 'xbox_kinnect',
        'xbox1': 'xbox1',
        'xbox2': 'xbox2',
        'xbox3': 'xbox3',
        'xbox4': 'xbox4',
        'karaoke': 'karaoke',
        'board_games': 'board_games',
        'hostess': 'hostess',
        'birthday': 'birthday'
      };
      
      // –û–±–Ω–æ–≤–ª—è–µ–º selectedServices: –º–∞–ø–ø–∏–º —Å—Ç–∞—Ä—ã–µ ID –Ω–∞ –Ω–æ–≤—ã–µ –∏ —É–¥–∞–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ
      const newSelectedServices = new Set();
      const availableServiceIds = new Set();
      
      const allServices = [
        { id: 'weekday_ps1', label: 'PS5 (1 –¥–∂–æ–π—Å—Ç–∏–∫)', price: 150, icon: 'fa-gamepad', weekday: true },
        { id: 'weekday_ps2', label: 'PS5 (2 –¥–∂–æ–π—Å—Ç–∏–∫–∞)', price: 300, icon: 'fa-gamepad', weekday: true },
        { id: 'weekday_vr1', label: 'VR –æ—á–∫–∏ (1 —à—Ç.)', price: 500, icon: 'fa-vr-cardboard', weekday: true },
        { id: 'weekday_vr2', label: 'VR –æ—á–∫–∏ (2 —à—Ç.)', price: 1000, icon: 'fa-vr-cardboard', weekday: true },
        { id: 'weekday_vr3', label: 'VR –æ—á–∫–∏ (3 —à—Ç.)', price: 1500, icon: 'fa-vr-cardboard', weekday: true },
        { id: 'weekday_vr4', label: 'VR –æ—á–∫–∏ (4 —à—Ç.)', price: 2000, icon: 'fa-vr-cardboard', weekday: true },
        { id: 'weekend_vr1', label: 'VR –æ—á–∫–∏ (1 —à—Ç.)', price: 750, icon: 'fa-vr-cardboard', weekday: false },
        { id: 'weekend_vr2', label: 'VR –æ—á–∫–∏ (2 —à—Ç.)', price: 1500, icon: 'fa-vr-cardboard', weekday: false },
        { id: 'weekend_vr3', label: 'VR –æ—á–∫–∏ (3 —à—Ç.)', price: 2250, icon: 'fa-vr-cardboard', weekday: false },
        { id: 'weekend_vr4', label: 'VR –æ—á–∫–∏ (4 —à—Ç.)', price: 3000, icon: 'fa-vr-cardboard', weekday: false },
        { id: 'xbox_kinnect', label: 'X-Box Kinnect', price: 500, icon: 'fa-child', weekday: null },
        { id: 'xbox1', label: 'X-Box (1 –¥–∂–æ–π—Å—Ç–∏–∫)', price: 250, icon: 'fa-gamepad', weekday: null },
        { id: 'xbox2', label: 'X-Box (2 –¥–∂–æ–π—Å—Ç–∏–∫–∞)', price: 500, icon: 'fa-gamepad', weekday: null },
        { id: 'xbox3', label: 'X-Box (3 –¥–∂–æ–π—Å—Ç–∏–∫–∞)', price: 750, icon: 'fa-gamepad', weekday: null },
        { id: 'xbox4', label: 'X-Box (4 –¥–∂–æ–π—Å—Ç–∏–∫–∞)', price: 1000, icon: 'fa-gamepad', weekday: null },
        { id: 'karaoke', label: '–ö–∞—Ä–∞–æ–∫–µ', price: 1000, icon: 'fa-microphone', weekday: null },
        { id: 'board_games', label: '–ù–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã', price: 500, icon: 'fa-dice-d6', weekday: null },
        { id: 'hostess', label: '–í–µ–¥—É—â–∞—è', price: 2000, icon: 'fa-user-tie', weekday: null },
        { id: 'birthday', label: '–ê—Ä–µ–Ω–¥–∞ (–î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è)', price: 3000, icon: 'fa-birthday-cake', weekday: null }
      ];

      // –§–∏–ª—å—Ç—Ä—É–µ–º —É—Å–ª—É–≥–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–Ω—è –Ω–µ–¥–µ–ª–∏
      const services = allServices.filter(service => {
        if (service.weekday === null) return true; // –£—Å–ª—É–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–≥–¥–∞
        return service.weekday === !isWeekendDay;
      });
      
      // –°–æ–±–∏—Ä–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ ID —É—Å–ª—É–≥
      services.forEach(service => {
        availableServiceIds.add(service.id);
      });
      
      // –ú–∞–ø–ø–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ –Ω–∞ –Ω–æ–≤—ã–µ ID –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
      const oldSelectedServices = new Set(selectedServices); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
      selectedServices.forEach(oldServiceId => {
        const newServiceId = serviceMapping[oldServiceId];
        if (newServiceId && availableServiceIds.has(newServiceId)) {
          newSelectedServices.add(newServiceId);
        }
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º selectedServices
      selectedServices = newSelectedServices;
      
      console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥:', {
        isWeekendDay,
        oldSelected: Array.from(oldSelectedServices),
        newSelected: Array.from(newSelectedServices),
        availableServices: Array.from(availableServiceIds)
      });

      container.innerHTML = '';

      services.forEach(service => {
        const card = document.createElement('div');
        card.className = 'service-card';
        card.dataset.service = service.id;
        const isSelected = selectedServices.has(service.id);
        
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <i class="fas ${service.icon} text-2xl text-purple-400"></i>
              <div>
                <div class="font-semibold">${service.label}</div>
                <div class="text-sm text-purple-300 opacity-75">${service.id === 'hostess' ? '2000 ‚ÇΩ' : service.id === 'birthday' ? '–æ—Ç 3000 ‚ÇΩ/—á–∞—Å' : service.price + ' ‚ÇΩ/—á–∞—Å'}</div>
              </div>
            </div>
            <i class="fas fa-check-circle text-purple-400 transition-opacity" style="font-size: 1.5rem; opacity: ${isSelected ? '1' : '0'};"></i>
          </div>
        `;
        
        if (isSelected) {
          card.classList.add('selected');
        }
        
        card.addEventListener('click', () => {
          const serviceId = service.id;
          const wasSelected = selectedServices.has(serviceId);
          
          if (wasSelected) {
            // –£–±–∏—Ä–∞–µ–º —É—Å–ª—É–≥—É –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
            selectedServices.delete(serviceId);
            card.classList.remove('selected');
            card.querySelector('.fa-check-circle').style.opacity = '0';
            console.log(`‚ùå –£—Å–ª—É–≥–∞ "${service.label}" —É–¥–∞–ª–µ–Ω–∞. –í—Å–µ–≥–æ –≤—ã–±—Ä–∞–Ω–æ: ${selectedServices.size}`);
          } else {
            // –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª—É–≥—É –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
            selectedServices.add(serviceId);
            card.classList.add('selected');
            card.querySelector('.fa-check-circle').style.opacity = '1';
            console.log(`‚úÖ –£—Å–ª—É–≥–∞ "${service.label}" –¥–æ–±–∞–≤–ª–µ–Ω–∞. –í—Å–µ–≥–æ –≤—ã–±—Ä–∞–Ω–æ: ${selectedServices.size}`);
          }
          
          updateTotal();
          
          // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —É—Å–ª—É–≥–∏ —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
          const currentDate = document.getElementById('bookingDate').value;
          if (currentDate) {
            loadServices(currentDate);
          }
        });
        
        container.appendChild(card);
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
      updateTotal();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    function updateTotal() {
      const totalEl = document.getElementById('totalAmount');
      const detailsEl = document.getElementById('calculationDetails');
      
      if (!totalEl || selectedServices.size === 0) {
        totalEl.textContent = '0 ‚ÇΩ';
        detailsEl.classList.add('hidden');
        return;
      }

      const duration = parseFloat(document.getElementById('duration').value) || 1;
      let total = 0;
      const calculationDetails = [];

      console.log('üîç –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏. –í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏:', Array.from(selectedServices));
      console.log('‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:', duration);

      selectedServices.forEach(serviceId => {
        console.log(`üì¶ –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ª—É–≥–∏: ${serviceId}`);
        
        if (serviceId === 'birthday') {
          const fullHours = Math.floor(duration);
          const hasHalfHour = duration % 1 !== 0;
          let birthdayTotal = 0;
          const hourDetails = [];
          
          console.log(`üéÇ –î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è: –ø–æ–ª–Ω—ã—Ö —á–∞—Å–æ–≤=${fullHours}, –µ—Å—Ç—å –ø–æ–ª—á–∞—Å–∞=${hasHalfHour}`);
          
          for (let hour = 1; hour <= fullHours; hour++) {
            const hourPrice = servicePrices.birthday[hour] || servicePrices.birthday[4] || 3000;
            birthdayTotal += hourPrice;
            hourDetails.push(`–ß–∞—Å ${hour}: ${hourPrice.toLocaleString('ru-RU')} ‚ÇΩ`);
            console.log(`  –ß–∞—Å ${hour}: ${hourPrice} ‚ÇΩ (—Å—É–º–º–∞: ${birthdayTotal})`);
          }
          
          if (hasHalfHour) {
            let halfHourPrice = 0;
            if (fullHours === 0) {
              halfHourPrice = 2000;
              hourDetails.push(`0.5 —á–∞—Å–∞: ${halfHourPrice.toLocaleString('ru-RU')} ‚ÇΩ`);
            } else if (fullHours === 1) {
              halfHourPrice = 2000;
              hourDetails.push(`+0.5 —á–∞—Å–∞: ${halfHourPrice.toLocaleString('ru-RU')} ‚ÇΩ`);
            } else {
              halfHourPrice = (servicePrices.birthday[3] || 3000) / 2;
              hourDetails.push(`+0.5 —á–∞—Å–∞: ${halfHourPrice.toLocaleString('ru-RU')} ‚ÇΩ`);
            }
            birthdayTotal += halfHourPrice;
            console.log(`  +0.5 —á–∞—Å–∞: ${halfHourPrice} ‚ÇΩ`);
          }
          
          console.log(`‚úÖ –ò—Ç–æ–≥–æ –∑–∞ –î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è: ${birthdayTotal} ‚ÇΩ`);
          total += birthdayTotal;
          
          calculationDetails.push({
            service: 'birthday',
            label: '–ê—Ä–µ–Ω–¥–∞ –≤—Å–µ–≥–æ (–î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è)',
            hourDetails: hourDetails,
            total: birthdayTotal,
            conditions: [
              '–í —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Ö–æ–¥–∏—Ç –∞—Ä–µ–Ω–¥–∞ –≤—Å–µ–≥–æ –ø–æ–º–µ—â–µ–Ω–∏—è:',
              '‚Ä¢ VR –æ—á–∫–∏',
              '‚Ä¢ PS –∫–æ–º–Ω–∞—Ç–∞',
              '‚Ä¢ –ö–∞—Ä–∞–æ–∫–µ',
              '‚Ä¢ –ö–∏–Ω–æ',
              '‚Ä¢ XBOX 360',
              '‚Ä¢ –¢–∞–Ω—Ü—ã –≤ XBOX',
              '‚Ä¢ –ò–≥—Ä—ã –Ω–∞ –ü–ö',
              '',
              '–ú–æ–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å —Å–≤–æ—é –µ–¥—É –∏ –Ω–∞–ø–∏—Ç–∫–∏'
            ]
          });
        } else if (serviceId === 'hostess') {
          const hostessPrice = servicePrices.hostess;
          total += hostessPrice;
          console.log(`‚úÖ –í–µ–¥—É—â–∞—è: ${hostessPrice} ‚ÇΩ`);
          
          calculationDetails.push({
            service: 'hostess',
            label: '–í–µ–¥—É—â–∞—è',
            total: hostessPrice,
            conditions: [
              '–í–µ–¥—É—â–∞—è: 2000 ‚ÇΩ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)',
              '',
              '–í–µ–¥—É—â–∞—è —Å–æ–∑–¥–∞—ë—Ç –æ–±—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –ø–æ–∑–¥—Ä–∞–≤–ª—è–µ—Ç –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–∞,',
              '—É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∫–æ–Ω–∫—É—Ä—Å—ã, —É–≤–ª–µ–∫–∞–µ—Ç, –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤—ã–≤–∞–µ—Ç –∏ –ø–æ–º–æ–≥–∞–µ—Ç –≥–æ—Å—Ç—è–º.',
              '–û—Å–æ–±–µ–Ω–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è –¥–µ—Ç—Å–∫–∏—Ö –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤!'
            ]
          });
        } else {
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è VR —É—Å–ª—É–≥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–Ω—è –Ω–µ–¥–µ–ª–∏
          const bookingDate = document.getElementById('bookingDate').value;
          const isWeekendDay = bookingDate ? isWeekend(new Date(bookingDate)) : isWeekend(new Date());
          
          let serviceKey = serviceId;
          if (serviceId.includes('vr') && isWeekendDay && !serviceId.includes('weekend')) {
            serviceKey = serviceId.replace('weekday', 'weekend');
          } else if (serviceId.includes('vr') && !isWeekendDay && !serviceId.includes('weekday')) {
            serviceKey = serviceId.replace('weekend', 'weekday');
          }
          
          const price = servicePrices[serviceKey] || servicePrices[serviceId] || 0;
          const serviceTotal = price * duration;
          total += serviceTotal;
          console.log(`‚úÖ ${serviceLabels[serviceId] || serviceId}: ${price} ‚ÇΩ/—á–∞—Å √ó ${duration} —á = ${serviceTotal} ‚ÇΩ`);
        }
      });

      console.log(`üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: ${total} ‚ÇΩ`);
      totalEl.textContent = `${Math.round(total).toLocaleString('ru-RU')} ‚ÇΩ`;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é
      updateCalculationDetails(calculationDetails, total);
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞
    function updateCalculationDetails(details, total) {
      const detailsEl = document.getElementById('calculationDetails');
      
      if (details.length === 0) {
        detailsEl.classList.add('hidden');
        return;
      }
      
      detailsEl.classList.remove('hidden');
      
      let html = '';
      
      details.forEach((item, index) => {
        if (index > 0) {
          html += '<div class="mt-3 pt-3 border-t border-purple-500/30"></div>';
        }
        
        html += `<div class="mb-2">`;
        html += `<div class="font-semibold text-purple-300 mb-2">${item.label}</div>`;
        
        // –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞ –ø–æ —á–∞—Å–∞–º (—Ç–æ–ª—å–∫–æ –¥–ª—è –î–Ω—è –†–æ–∂–¥–µ–Ω–∏—è)
        if (item.hourDetails && item.hourDetails.length > 0) {
          html += `<div class="text-sm text-purple-200/80 mb-2 space-y-1">`;
          item.hourDetails.forEach(detail => {
            html += `<div class="ml-2">${detail}</div>`;
          });
          html += `</div>`;
        }
        
        html += `<div class="font-semibold text-purple-300">–ò—Ç–æ–≥–æ: ${item.total.toLocaleString('ru-RU')} ‚ÇΩ</div>`;
        
        // –£—Å–ª–æ–≤–∏—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
        if (item.conditions && item.conditions.length > 0) {
          html += `<div class="mt-2 pt-2 border-t border-purple-500/20 text-xs text-purple-200/70 space-y-1">`;
          item.conditions.forEach(condition => {
            html += `<div class="ml-1">${condition}</div>`;
          });
          html += `</div>`;
        }
        
        html += `</div>`;
      });
      
      // –û–±—â–∏–π –∏—Ç–æ–≥
      html += `<div class="mt-3 pt-3 border-t-2 border-purple-500/50">`;
      html += `<div class="text-lg font-bold text-purple-300 neon-text">–û–±—â–∏–π –∏—Ç–æ–≥: ${total.toLocaleString('ru-RU')} ‚ÇΩ</div>`;
      html += `</div>`;
      
      detailsEl.innerHTML = html;
    }

    // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    function showMessage(text, type = 'success') {
      const container = document.getElementById('messageContainer');
      if (!container) {
        console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
      }
      
      const message = document.createElement('div');
      message.className = type === 'success' ? 'success-message' : 'error-message';
      message.textContent = text;
      message.style.opacity = '1';
      message.style.transition = 'opacity 0.3s';
      
      container.innerHTML = '';
      container.appendChild(message);
      
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
      message.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // –î–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ª—å—à–µ –∏ –Ω–µ —É–¥–∞–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      if (type === 'success') {
        // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∏–¥–∏–º—ã–º –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è Mini App
        console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –ø–æ–∫–∞–∑–∞–Ω–æ:', text);
      } else {
        // –î–ª—è –æ—à–∏–±–æ–∫ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
          message.style.opacity = '0';
          setTimeout(() => message.remove(), 300);
        }, 5000);
      }
    }
    
    // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –æ—à–∏–±–∫–æ–π
    function showErrorModal(message) {
      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å
      const existingModal = document.getElementById('errorModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      const modal = document.createElement('div');
      modal.id = 'errorModal';
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
          <div class="modal-message">${message}</div>
          <button class="modal-button" onclick="this.closest('.modal-overlay').remove()">
            –ü–æ–Ω—è—Ç–Ω–æ
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –∫–Ω–æ–ø–∫–µ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      setTimeout(() => {
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
          submitBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 100);
    }
    
    // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å —É—Å–ø–µ—Ö–æ–º
    function showSuccessModal(message) {
      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å
      const existingModal = document.getElementById('successModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      const modal = document.createElement('div');
      modal.id = 'successModal';
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</div>
          <div class="modal-message">${message}</div>
          <button class="modal-button" onclick="this.closest('.modal-overlay').remove(); window.Telegram.WebApp.close();">
            –û—Ç–ª–∏—á–Ω–æ!
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
          tg.close();
        }
      });
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
      setTimeout(() => {
        if (document.getElementById('successModal')) {
          document.getElementById('successModal').remove();
          tg.close();
        }
      }, 5000);
    }
    
    // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ –Ω–∞–¥ –∫–Ω–æ–ø–∫–æ–π
    function showErrorAboveButton(message) {
      const container = document.getElementById('errorMessageContainer');
      if (!container) {
        console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        showErrorModal(message);
        return;
      }
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      
      container.innerHTML = '';
      container.appendChild(errorDiv);
      
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
      errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
      setTimeout(() => {
        errorDiv.style.opacity = '0';
        errorDiv.style.transition = 'opacity 0.3s';
        setTimeout(() => errorDiv.remove(), 300);
      }, 5000);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> –û—Ç–ø—Ä–∞–≤–∫–∞...';

      const clientName = document.getElementById('clientName').value.trim();
      const clientPhone = document.getElementById('clientPhone').value.trim();
      const bookingDate = document.getElementById('bookingDate').value;
      const duration = parseFloat(document.getElementById('duration').value);
      const notes = document.getElementById('notes').value.trim();

      // –î–µ—Ç–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
      const errors = [];
      
      if (!clientName) {
        errors.push('–∏–º—è');
      }
      if (!clientPhone) {
        errors.push('–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
      }
      if (!bookingDate) {
        errors.push('–¥–∞—Ç—É');
      }
      if (!selectedTime) {
        errors.push('–≤—Ä–µ–º—è');
      }
      if (selectedServices.size === 0) {
        errors.push('—É—Å–ª—É–≥—É');
      }
      
      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º—ã:', {
        clientName: !!clientName,
        clientPhone: !!clientPhone,
        bookingDate: !!bookingDate,
        selectedTime: selectedTime,
        selectedServices: Array.from(selectedServices),
        selectedServicesSize: selectedServices.size,
        errors: errors
      });
      
      if (errors.length > 0) {
        let errorMessage = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ ';
        if (errors.length === 1) {
          errorMessage += errors[0];
        } else if (errors.length === 2) {
          errorMessage += errors.join(' –∏ ');
        } else {
          const lastError = errors.pop();
          errorMessage += errors.join(', ') + ' –∏ ' + lastError;
        }
        
        showErrorAboveButton(errorMessage);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–∏
      if (!isTimeAvailable(bookingDate, selectedTime, duration)) {
        showErrorAboveButton('–≠—Ç–æ –≤—Ä–µ–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';
        generateTimeSlots(bookingDate);
        return;
      }

      try {
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase
        const phoneDigits = clientPhone.replace(/\D/g, '');
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 7 –∏–ª–∏ 8, –∏ –±–µ—Ä–µ–º 11 —Ü–∏—Ñ—Ä
        const cleanPhone = phoneDigits.startsWith('7') ? phoneDigits.substring(1) : 
                          phoneDigits.startsWith('8') ? phoneDigits.substring(1) : 
                          phoneDigits;
        
        console.log('üìû –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞:', {
          original: clientPhone,
          phoneDigits: phoneDigits,
          cleanPhone: cleanPhone,
          length: cleanPhone.length
        });
        
        const bookingData = {
          clientName,
          clientPhone,
          phoneDigits: cleanPhone,
          bookingDate,
          startTime: selectedTime,
          duration,
          selectedServices: Array.from(selectedServices),
          notes: notes || '',
          createdAt: window.Timestamp.now(),
          source: 'client_miniapp'
        };
        
        console.log('üìã –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', bookingData);

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Firebase...');
        await window.addDoc(window.collection(window.db, "bookings"), bookingData);
        console.log('‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
        const clientsQuery = window.query(
          window.collection(window.db, "clients"),
          window.where("phoneDigits", "==", cleanPhone)
        );
        const clientsSnapshot = await window.getDocs(clientsQuery);

        if (!clientsSnapshot.empty) {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
          const clientDoc = clientsSnapshot.docs[0];
          const clientData = clientDoc.data();
          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –≤ CRM
        } else {
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
          await window.addDoc(window.collection(window.db, "clients"), {
            clientName,
            clientPhone,
            phoneDigits: cleanPhone,
            telegramId: user?.id?.toString() || null,
            telegramUsername: user?.username ? `@${user.username}` : null,
            createdAt: window.Timestamp.now(),
            totalBookings: 0,
            totalSpent: 0,
            isActive: true
          });
        }

        showMessage('‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.', 'success');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–± —É—Å–ø–µ—Ö–µ
        showSuccessModal('–í–∞—à–∞ –∑–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –ñ–¥–µ–º –≤–∞—Å! üéÆ');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ';
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Å–æ–æ–±—â–µ–Ω–∏—é –æ–± —É—Å–ø–µ—Ö–µ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –ø–æ–∫–∞–∑–∞–ª–æ—Å—å)
        setTimeout(() => {
          const messageContainer = document.getElementById('messageContainer');
          if (messageContainer) {
            messageContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–∏–Ω–∏-–∞–ø–ø–∞ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ (–µ—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –∑–∞–∫—Ä—ã–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
        setTimeout(() => {
          const successModal = document.getElementById('successModal');
          if (!successModal) {
            tg.close();
          }
        }, 5000);

      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        console.error('üìã –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', {
          code: error.code,
          message: error.message,
          bookingData: bookingData
        });
        
        let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏. ';
        if (error.code === 'permission-denied') {
          errorMessage += '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firestore –≤ Firebase Console.';
        } else if (error.code === 'unavailable') {
          errorMessage += '–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.';
        } else {
          errorMessage += `–ö–æ–¥ –æ—à–∏–±–∫–∏: ${error.code || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏.`;
        }
        
        showMessage(errorMessage, 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('bookingDate').addEventListener('change', (e) => {
      const date = e.target.value;
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —É—Å–ª—É–≥–∏ —Å —É—á–µ—Ç–æ–º –¥–Ω—è –Ω–µ–¥–µ–ª–∏ (—Å –º–∞–ø–ø–∏–Ω–≥–æ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥)
      loadServices(date);
      generateTimeSlots(date);
      // updateTotal –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ loadServices
    });

    document.getElementById('duration').addEventListener('change', () => {
      updateTotal();
      const date = document.getElementById('bookingDate').value;
      if (date) {
        generateTimeSlots(date);
      }
    });

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã (—Å–µ–≥–æ–¥–Ω—è)
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('bookingDate').setAttribute('min', today);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    (async () => {
      // –ñ–¥–µ–º, –ø–æ–∫–∞ Firebase –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
      if (!window.firebaseReady) {
        await new Promise(resolve => {
          window.addEventListener('firebaseReady', resolve, { once: true });
        });
      }
      
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã
      await new Promise(resolve => setTimeout(resolve, 100));
      
      console.log('üî• Firebase –≥–æ—Ç–æ–≤. –ó–∞–≥—Ä—É–∂–∞–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
      await loadBookings();
      loadServices();
    })();
  </script>
</body>
</html>

